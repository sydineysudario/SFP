<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o Financeira Pessoal - Vers√£o Corrigida</title>

    <!-- CDN Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase Config (Substitua pelas suas credenciais) -->
    <script type="application/json" id="firebase-config">
    {
        "apiKey": "AIzaSyCqCUYuwos_h5Fdt9a6bjibX7CzfhaJUqQ",
        "authDomain": "sistemafinanceiropessoal-ddbe3.firebaseapp.com",
        "projectId": "sistemafinanceiropessoal-ddbe3",
        "storageBucket": "sistemafinanceiropessoal-ddbe3.firebasestorage.app",
        "messagingSenderId": "360949795018",
        "appId": "1:360949795018:web:863523b189a26879e44c33",
        "measurementId": "G-1B3R3EK1TY"
    }
    </script>

    <style>
        /* Estilos customizados */
        .tab-content {
            min-height: 500px;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .modal {
            backdrop-filter: blur(4px);
        }

        /* Otimiza√ß√£o para PDF */
        @media print {
            body {
                font-size: 11px;
            }

            .no-print {
                display: none !important;
            }

            .tab-content {
                break-inside: avoid;
            }

            .chart-container {
                height: 250px;
            }

            header,
            nav {
                display: none !important;
            }

            .container {
                max-width: none !important;
                padding: 0 !important;
            }
        }

        /* Gradientes customizados */
        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .gradient-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .gradient-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .gradient-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .gradient-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .gradient-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        /* Anima√ß√µes */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pulse-success {
            animation: pulseSuccess 2s infinite;
        }

        @keyframes pulseSuccess {

            0%,
            100% {
                background-color: #10b981;
            }

            50% {
                background-color: #059669;
            }
        }

        /* Corre√ß√µes de valida√ß√£o visual */
        .input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }

        .input-success {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
        }

        /* Toast corrigido */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }

        .toast-container.show {
            transform: translateX(0);
        }

        /* Tabela responsiva melhorada */
        .table-wrapper {
            max-height: 400px;
            overflow-y: auto;
        }

        .sticky-header th {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        /* Filtros aprimorados */
        .filter-container {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Insights cards */
        .insight-card {
            transition: all 0.3s ease;
        }

        .insight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        /* Estat√≠sticas avan√ßadas */
        .stat-trend-up {
            color: #10b981;
        }

        .stat-trend-down {
            color: #ef4444;
        }

        .stat-neutral {
            color: #6b7280;
        }

        /* Loading spinner */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Tela de Login -->
    <div id="loginScreen" class="min-h-screen gradient-primary flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="gradient-info w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-wallet text-3xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">FinanceControl Pro</h1>
                <p class="text-gray-600">Sistema Inteligente de Gest√£o Financeira</p>
            </div>

            <button onclick="loginWithGoogle()" id="loginBtn"
                class="w-full bg-red-500 text-white py-3 px-4 rounded-lg hover:bg-red-600 transition-all flex items-center justify-center space-x-2 font-semibold">
                <i class="fab fa-google"></i>
                <span>Entrar com Google</span>
            </button>

            <div class="mt-6 text-center text-sm text-gray-500">
                <p>Seus dados s√£o protegidos e criptografados</p>
            </div>
        </div>
    </div>

    <!-- Tela Principal do App -->
    <div id="appScreen" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-lg sticky top-0 z-40 no-print">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="gradient-info w-10 h-10 rounded-full flex items-center justify-center">
                            <i class="fas fa-wallet text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">FinanceControl Pro</h1>
                            <p class="text-xs text-gray-500">Sistema Inteligente</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <img id="userPhoto" src="" alt="User" class="w-8 h-8 rounded-full">
                        <span id="userName" class="text-sm font-medium hidden md:block"></span>
                        <button onclick="logout()"
                            class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm transition-colors">
                            <i class="fas fa-sign-out-alt mr-1"></i>Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navega√ß√£o por Tabs -->
        <nav class="bg-white border-b sticky top-16 z-30 no-print">
            <div class="container mx-auto px-4">
                <div class="flex flex-wrap space-x-1 py-2 overflow-x-auto">
                    <button onclick="showTab('dashboard')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap gradient-info text-white"
                        data-tab="dashboard">
                        <i class="fas fa-tachometer-alt mr-1"></i>Dashboard
                    </button>
                    <button onclick="showTab('receitas')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="receitas">
                        <i class="fas fa-plus-circle mr-1"></i>Receitas
                    </button>
                    <button onclick="showTab('despesas')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="despesas">
                        <i class="fas fa-minus-circle mr-1"></i>Despesas
                    </button>
                    <button onclick="showTab('patrimonio')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="patrimonio">
                        <i class="fas fa-home mr-1"></i>Patrim√¥nio
                    </button>
                    <button onclick="showTab('relatorios')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="relatorios">
                        <i class="fas fa-chart-bar mr-1"></i>Relat√≥rios
                    </button>
                    <button onclick="showTab('insights')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="insights">
                        <i class="fas fa-brain mr-1"></i>Insights
                    </button>
                    <button onclick="showTab('orcamentos')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="orcamentos">
                        <i class="fas fa-bullseye mr-1"></i>Or√ßamentos
                    </button>
                    <button onclick="showTab('recorrentes')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="recorrentes">
                        <i class="fas fa-sync-alt mr-1"></i>Recorrentes
                    </button>
                    <button onclick="showTab('fluxo')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="fluxo">
                        <i class="fas fa-chart-area mr-1"></i>Fluxo de Caixa
                    </button>
                    <button onclick="showTab('comparativo')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="comparativo">
                        <i class="fas fa-balance-scale mr-1"></i>Comparativo
                    </button>
                    <button onclick="showTab('projecao')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="projecao">
                        <i class="fas fa-chart-line mr-1"></i>Proje√ß√£o
                    </button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-4 py-6">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Dashboard Financeiro</h2>

                    <!-- Filtros de Per√≠odo -->
                    <div class="flex space-x-2 no-print">
                        <select id="dashboardMonth" onchange="updateDashboardPeriod()"
                            class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Todos os meses</option>
                            <option value="0">Janeiro</option>
                            <option value="1">Fevereiro</option>
                            <option value="2">Mar√ßo</option>
                            <option value="3">Abril</option>
                            <option value="4">Maio</option>
                            <option value="5">Junho</option>
                            <option value="6">Julho</option>
                            <option value="7">Agosto</option>
                            <option value="8">Setembro</option>
                            <option value="9">Outubro</option>
                            <option value="10">Novembro</option>
                            <option value="11">Dezembro</option>
                        </select>
                        <select id="dashboardYear" onchange="updateDashboardPeriod()"
                            class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Todos os anos</option>
                        </select>
                    </div>
                </div>

                <!-- M√©tricas Principais -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="gradient-primary rounded-xl p-6 text-white fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Saldo do Per√≠odo</p>
                                <p class="text-2xl font-bold" id="saldoAtual">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-1" id="percentualSaldo">0% vs per√≠odo anterior</p>
                            </div>
                            <i class="fas fa-wallet text-3xl opacity-70"></i>
                        </div>
                    </div>

                    <div class="gradient-success rounded-xl p-6 text-white fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Receitas do Per√≠odo</p>
                                <p class="text-2xl font-bold" id="receitasMes">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-1" id="mediaReceitas">M√©dia: R$ 0,00</p>
                            </div>
                            <i class="fas fa-arrow-up text-3xl opacity-70"></i>
                        </div>
                    </div>

                    <div class="gradient-danger rounded-xl p-6 text-white fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Despesas do Per√≠odo</p>
                                <p class="text-2xl font-bold" id="despesasMes">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-1" id="mediaDespesas">M√©dia: R$ 0,00</p>
                            </div>
                            <i class="fas fa-arrow-down text-3xl opacity-70"></i>
                        </div>
                    </div>

                    <div class="gradient-info rounded-xl p-6 text-white fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Economia do Per√≠odo</p>
                                <p class="text-2xl font-bold" id="economiaMensal">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-1" id="percentualEconomia">0% da receita</p>
                            </div>
                            <i class="fas fa-piggy-bank text-3xl opacity-70"></i>
                        </div>
                    </div>
                </div>

                <!-- Estat√≠sticas Avan√ßadas -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-lg insight-card">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-trending-up mr-2 text-green-500"></i>
                            Tend√™ncia Mensal
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Receitas</span>
                                <span id="tendenciaReceitas" class="text-sm font-medium">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Despesas</span>
                                <span id="tendenciaDespesas" class="text-sm font-medium">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Economia</span>
                                <span id="tendenciaEconomia" class="text-sm font-medium">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg insight-card">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-chart-pie mr-2 text-purple-500"></i>
                            Maior Categoria
                        </h3>
                        <div class="text-center">
                            <div class="text-4xl mb-2" id="maiorCategoriaIcon">üìä</div>
                            <p class="font-semibold" id="maiorCategoriaNome">--</p>
                            <p class="text-2xl font-bold text-purple-600" id="maiorCategoriaValor">R$ 0,00</p>
                            <p class="text-xs text-gray-500" id="maiorCategoriaPercent">0% do total</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg insight-card">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-calendar-day mr-2 text-blue-500"></i>
                            M√©dias Di√°rias
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Receitas</span>
                                <span id="mediaDiariaReceitas" class="text-sm font-medium text-green-600">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Despesas</span>
                                <span id="mediaDiariaDespesas" class="text-sm font-medium text-red-600">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Saldo</span>
                                <span id="mediaDiariaSaldo" class="text-sm font-medium">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gr√°ficos -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                            Evolu√ß√£o Mensal
                        </h3>
                        <div class="chart-container">
                            <canvas id="evolucaoChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-chart-pie mr-2 text-purple-500"></i>
                            Despesas por Categoria
                        </h3>
                        <div class="chart-container">
                            <canvas id="categoriaChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Transa√ß√µes Recentes -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Transa√ß√µes Recentes</h3>
                        <span id="totalTransacoes" class="text-sm text-gray-500">0 transa√ß√µes</span>
                    </div>
                    <div class="table-wrapper">
                        <table class="w-full">
                            <thead class="sticky-header">
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Data</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Descri√ß√£o</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Categoria</th>
                                    <th class="text-right py-3 px-4 font-semibold text-gray-700">Valor</th>
                                    <th class="text-center py-3 px-4 font-semibold text-gray-700 no-print">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="transacoesTableBody">
                                <!-- Transa√ß√µes ser√£o carregadas aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Receitas Tab -->
            <div id="receitas" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Controle de Receitas</h2>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <!-- Formul√°rio -->
                    <div class="xl:col-span-1">
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 flex items-center text-green-600">
                                <i class="fas fa-plus-circle mr-2"></i>
                                Nova Receita
                            </h3>
                            <form onsubmit="handleReceitaForm(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700"
                                        for="receita-descricao">
                                        <i class="fas fa-file-alt mr-1"></i>Descri√ß√£o
                                    </label>
                                    <input name="descricao" id="receita-descricao" type="text" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        placeholder="Ex: Sal√°rio Principal" maxlength="100">
                                    <div class="text-xs text-red-500 mt-1 hidden" id="receita-descricao-error"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700" for="receita-valor">
                                        <i class="fas fa-dollar-sign mr-1"></i>Valor
                                    </label>
                                    <input name="valor" id="receita-valor" type="text" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        placeholder="1.000,00" oninput="formatCurrency(this)" data-max="999999999">
                                    <div class="text-xs text-red-500 mt-1 hidden" id="receita-valor-error"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700"
                                        for="receita-categoria">
                                        <i class="fas fa-tags mr-1"></i>Categoria
                                    </label>
                                    <select name="categoria" id="receita-categoria" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">Selecione uma categoria...</option>
                                        <option value="Sal√°rio">üíº Sal√°rio</option>
                                        <option value="Freelancer">üíª Freelancer</option>
                                        <option value="Investimentos">üìà Investimentos</option>
                                        <option value="Vendas">üõí Vendas</option>
                                        <option value="Aluguel">üè† Aluguel Recebido</option>
                                        <option value="Bonus">üéÅ B√¥nus</option>
                                        <option value="Outros">üìù Outros</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700" for="receita-data">
                                        <i class="fas fa-calendar mr-1"></i>Data
                                    </label>
                                    <input name="data" id="receita-data" type="date" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <div class="text-xs text-red-500 mt-1 hidden" id="receita-data-error"></div>
                                </div>
                                <button type="submit" id="receitaSubmitBtn"
                                    class="w-full gradient-success text-white py-3 rounded-lg hover:opacity-90 transition-all font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Adicionar Receita
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Resumo e Lista -->
                    <div class="xl:col-span-2 space-y-6">
                        <!-- Resumo -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="gradient-success rounded-xl p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90">Total do M√™s</p>
                                        <p class="text-2xl font-bold" id="totalReceitasMes">R$ 0,00</p>
                                    </div>
                                    <i class="fas fa-chart-line text-3xl opacity-70"></i>
                                </div>
                            </div>
                            <div class="gradient-info rounded-xl p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90">M√©dia Mensal</p>
                                        <p class="text-2xl font-bold" id="mediaReceitasMensal">R$ 0,00</p>
                                    </div>
                                    <i class="fas fa-calculator text-3xl opacity-70"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Receitas -->
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <h4 class="text-lg font-semibold mb-4">Receitas Recentes</h4>
                            <div id="receitasList" class="space-y-3">
                                <!-- Receitas ser√£o carregadas aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Despesas Tab -->
            <div id="despesas" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Controle de Despesas</h2>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <!-- Formul√°rio -->
                    <div class="xl:col-span-1">
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 flex items-center text-red-600">
                                <i class="fas fa-minus-circle mr-2"></i>
                                Nova Despesa
                            </h3>
                            <form onsubmit="handleDespesaForm(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700"
                                        for="despesa-descricao">
                                        <i class="fas fa-file-alt mr-1"></i>Descri√ß√£o
                                    </label>
                                    <input name="descricao" id="despesa-descricao" type="text" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                        placeholder="Ex: Aluguel" maxlength="100">
                                    <div class="text-xs text-red-500 mt-1 hidden" id="despesa-descricao-error"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700" for="despesa-valor">
                                        <i class="fas fa-dollar-sign mr-1"></i>Valor
                                    </label>
                                    <input name="valor" id="despesa-valor" type="text" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                        placeholder="500,00" oninput="formatCurrency(this)" data-max="999999999">
                                    <div class="text-xs text-red-500 mt-1 hidden" id="despesa-valor-error"></div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700"
                                        for="despesa-categoria">
                                        <i class="fas fa-tags mr-1"></i>Categoria
                                    </label>
                                    <select name="categoria" id="despesa-categoria" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                        <option value="">Selecione uma categoria...</option>
                                        <option value="Habita√ß√£o">üè† Habita√ß√£o</option>
                                        <option value="Alimenta√ß√£o">üçΩÔ∏è Alimenta√ß√£o</option>
                                        <option value="Transporte">üöó Transporte</option>
                                        <option value="Lazer">üéØ Lazer</option>
                                        <option value="Sa√∫de">‚öïÔ∏è Sa√∫de</option>
                                        <option value="Educa√ß√£o">üìö Educa√ß√£o</option>
                                        <option value="Roupas">üëï Roupas</option>
                                        <option value="Tecnologia">üíª Tecnologia</option>
                                        <option value="Contas">üìÑ Contas</option>
                                        <option value="Outros">üìù Outros</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700" for="despesa-data">
                                        <i class="fas fa-calendar mr-1"></i>Data
                                    </label>
                                    <input name="data" id="despesa-data" type="date" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                    <div class="text-xs text-red-500 mt-1 hidden" id="despesa-data-error"></div>
                                </div>
                                <button type="submit" id="despesaSubmitBtn"
                                    class="w-full gradient-danger text-white py-3 rounded-lg hover:opacity-90 transition-all font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Adicionar Despesa
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Resumo e Lista -->
                    <div class="xl:col-span-2 space-y-6">
                        <!-- Resumo -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="gradient-danger rounded-xl p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90">Total do M√™s</p>
                                        <p class="text-2xl font-bold" id="totalDespesasMes">R$ 0,00</p>
                                    </div>
                                    <i class="fas fa-chart-line text-3xl opacity-70"></i>
                                </div>
                            </div>
                            <div class="gradient-warning rounded-xl p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90">M√©dia Mensal</p>
                                        <p class="text-2xl font-bold" id="mediaDespesasMensal">R$ 0,00</p>
                                    </div>
                                    <i class="fas fa-calculator text-3xl opacity-70"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Despesas -->
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <h4 class="text-lg font-semibold mb-4">Despesas Recentes</h4>
                            <div id="despesasList" class="space-y-3">
                                <!-- Despesas ser√£o carregadas aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patrim√¥nio Tab -->
            <div id="patrimonio" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Controle de Patrim√¥nio</h2>

                <!-- Resumo do Patrim√¥nio -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="gradient-success rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Total de Bens</p>
                                <p class="text-2xl font-bold" id="totalBens">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-1" id="quantidadeBens">0 itens</p>
                            </div>
                            <i class="fas fa-arrow-trend-up text-3xl opacity-70"></i>
                        </div>
                    </div>

                    <div class="gradient-danger rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Total de D√≠vidas</p>
                                <p class="text-2xl font-bold" id="totalDividas">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-1" id="quantidadeDividas">0 itens</p>
                            </div>
                            <i class="fas fa-arrow-trend-down text-3xl opacity-70"></i>
                        </div>
                    </div>

                    <div class="gradient-info rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Patrim√¥nio L√≠quido</p>
                                <p class="text-2xl font-bold" id="patrimonioLiquido">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-1" id="statusPatrimonio">Positivo</p>
                            </div>
                            <i class="fas fa-balance-scale text-3xl opacity-70"></i>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <!-- Formul√°rio -->
                    <div class="xl:col-span-1">
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 flex items-center text-blue-600">
                                <i class="fas fa-plus mr-2"></i>
                                Novo Item
                            </h3>
                            <form onsubmit="handlePatrimonioForm(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700" for="patrimonio-tipo">
                                        <i class="fas fa-list mr-1"></i>Tipo
                                    </label>
                                    <select name="tipo" id="patrimonio-tipo" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">Selecione o tipo...</option>
                                        <option value="bem">üí∞ Bem</option>
                                        <option value="divida">üí∏ D√≠vida</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700"
                                        for="patrimonio-descricao">
                                        <i class="fas fa-file-alt mr-1"></i>Descri√ß√£o
                                    </label>
                                    <input name="descricao" id="patrimonio-descricao" type="text" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Ex: Casa Pr√≥pria" maxlength="100">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700"
                                        for="patrimonio-valor">
                                        <i class="fas fa-dollar-sign mr-1"></i>Valor
                                    </label>
                                    <input name="valor" id="patrimonio-valor" type="text" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="100.000,00" oninput="formatCurrency(this)" data-max="999999999">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700"
                                        for="patrimonio-categoria">
                                        <i class="fas fa-tags mr-1"></i>Categoria
                                    </label>
                                    <select name="categoria" id="patrimonio-categoria" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">Selecione uma categoria...</option>
                                        <option value="Im√≥veis">üè† Im√≥veis</option>
                                        <option value="Ve√≠culos">üöó Ve√≠culos</option>
                                        <option value="Investimentos">üìà Investimentos</option>
                                        <option value="Conta Corrente">üè¶ Conta Corrente</option>
                                        <option value="Poupan√ßa">üí∞ Poupan√ßa</option>
                                        <option value="Cart√£o de Cr√©dito">üí≥ Cart√£o de Cr√©dito</option>
                                        <option value="Financiamentos">üè† Financiamentos</option>
                                        <option value="Empr√©stimos">üí∏ Empr√©stimos</option>
                                        <option value="Outros">üìù Outros</option>
                                    </select>
                                </div>
                                <button type="submit" id="patrimonioSubmitBtn"
                                    class="w-full gradient-info text-white py-3 rounded-lg hover:opacity-90 transition-all font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Adicionar Item
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Lista de Patrim√¥nio -->
                    <div class="xl:col-span-2">
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <h4 class="text-lg font-semibold mb-4">Itens do Patrim√¥nio</h4>
                            <div id="patrimonioList" class="space-y-3">
                                <!-- Patrim√¥nio ser√° carregado aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relat√≥rios Tab - CORRIGIDA -->
            <div id="relatorios" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Relat√≥rios Detalhados</h2>

                <!-- Filtros Aprimorados -->
                <div class="filter-container">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-filter mr-2 text-blue-500"></i>
                        Filtros de Pesquisa
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">M√™s</label>
                            <select id="filtroMes" onchange="syncFiltersFromReports()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Todos</option>
                                <option value="0">Janeiro</option>
                                <option value="1">Fevereiro</option>
                                <option value="2">Mar√ßo</option>
                                <option value="3">Abril</option>
                                <option value="4">Maio</option>
                                <option value="5">Junho</option>
                                <option value="6">Julho</option>
                                <option value="7">Agosto</option>
                                <option value="8">Setembro</option>
                                <option value="9">Outubro</option>
                                <option value="10">Novembro</option>
                                <option value="11">Dezembro</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Ano</label>
                            <select id="filtroAno" onchange="syncFiltersFromReports()"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Data In√≠cio</label>
                            <input type="date" id="filtroDataInicio"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Data Fim</label>
                            <input type="date" id="filtroDataFim"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Tipo</label>
                            <select id="filtroTipo"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Todos</option>
                                <option value="receita">Receitas</option>
                                <option value="despesa">Despesas</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Categoria</label>
                            <select id="filtroCategoria"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Todas</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex space-x-3 mt-4">
                        <button onclick="aplicarFiltros()"
                            class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-search mr-2"></i>Aplicar Filtros
                        </button>
                        <button onclick="limparFiltros()"
                            class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            <i class="fas fa-eraser mr-2"></i>Limpar
                        </button>
                        <button onclick="exportarCSV()"
                            class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-download mr-2"></i>Exportar CSV
                        </button>
                    </div>
                </div>

                <!-- Resumo dos Filtros -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-lg text-center">
                        <div class="text-3xl font-bold text-blue-600" id="filtroTotalRegistros">0</div>
                        <div class="text-sm text-gray-600 mt-1">Total de Registros</div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-lg text-center">
                        <div class="text-3xl font-bold text-green-600" id="filtroTotalReceitas">R$ 0,00</div>
                        <div class="text-sm text-gray-600 mt-1">Total Receitas</div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-lg text-center">
                        <div class="text-3xl font-bold text-red-600" id="filtroTotalDespesas">R$ 0,00</div>
                        <div class="text-sm text-gray-600 mt-1">Total Despesas</div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-lg text-center">
                        <div class="text-3xl font-bold" id="filtroSaldoPeriodo">R$ 0,00</div>
                        <div class="text-sm text-gray-600 mt-1">Saldo do Per√≠odo</div>
                    </div>
                </div>

                <!-- Tabela de Relat√≥rios -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Transa√ß√µes Filtradas</h3>
                        <div class="text-sm text-gray-500">
                            Clique nos cabe√ßalhos para ordenar
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="w-full">
                            <thead class="sticky-header">
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700 cursor-pointer hover:bg-gray-50"
                                        onclick="alterarOrdenacao('tipo')">
                                        Tipo <i class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700 cursor-pointer hover:bg-gray-50"
                                        onclick="alterarOrdenacao('data')">
                                        Data <i class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700 cursor-pointer hover:bg-gray-50"
                                        onclick="alterarOrdenacao('descricao')">
                                        Descri√ß√£o <i class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Categoria</th>
                                    <th class="text-right py-3 px-4 font-semibold text-gray-700 cursor-pointer hover:bg-gray-50"
                                        onclick="alterarOrdenacao('valor')">
                                        Valor <i class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="text-center py-3 px-4 font-semibold text-gray-700 no-print">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="relatoriosTableBody">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-gray-500">
                                        <div class="spinner"></div>
                                        Carregando dados...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Insights Tab - CORRIGIDA -->
            <div id="insights" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">An√°lises e Insights</h2>

                <!-- An√°lise R√°pida -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-lg insight-card">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                            Tend√™ncia Trimestral
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Receitas</span>
                                <span id="tendenciaReceitasTrimestre" class="text-sm font-medium">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Despesas</span>
                                <span id="tendenciaDespesasTrimestre" class="text-sm font-medium">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Economia</span>
                                <span id="tendenciaEconomiaTrimestre" class="text-sm font-medium">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg insight-card">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-calendar-alt mr-2 text-green-500"></i>
                            Atividade Mensal
                        </h3>
                        <div class="space-y-2">
                            <div>
                                <p class="text-xs text-gray-500 mb-1">M√™s com maior atividade</p>
                                <p id="mesMaiorAtividade" class="font-medium text-blue-600">--</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 mb-1">M√™s com menor atividade</p>
                                <p id="mesMenorAtividade" class="font-medium text-gray-600">--</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg insight-card">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-chart-pie mr-2 text-purple-500"></i>
                            Categoria Dominante
                        </h3>
                        <div class="space-y-2">
                            <p id="categoriaMaiorGasto" class="font-medium text-purple-600">--</p>
                            <p id="categoriaMaiorGastoValor" class="text-sm text-gray-600">R$ 0,00</p>
                            <p id="categoriaMaiorGastoMedia" class="text-xs text-gray-500">--</p>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fico de Tend√™ncia -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                            Evolu√ß√£o Mensal
                        </h3>
                        <div class="chart-container">
                            <canvas id="tendenciaMensalChart"></canvas>
                        </div>
                    </div>

                    <!-- Previs√µes -->
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-crystal-ball mr-2 text-purple-500"></i>
                            Proje√ß√£o do M√™s
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                <span class="text-sm text-green-700">Receitas Projetadas</span>
                                <span id="projecaoReceitasMes" class="font-bold text-green-600">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                                <span class="text-sm text-red-700">Despesas Projetadas</span>
                                <span id="projecaoDespesasMes" class="font-bold text-red-600">R$ 0,00</span>
                            </div>
                            <div
                                class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border-2 border-dashed">
                                <span class="text-sm text-gray-700">Saldo Projetado</span>
                                <span id="projecaoSaldoMes" class="font-bold">R$ 0,00</span>
                            </div>
                            <p class="text-xs text-gray-500 text-center">
                                *Baseado no ritmo atual de gastos e receitas
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Alertas e Recomenda√ß√µes -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-bell mr-2 text-orange-500"></i>
                        Alertas e Recomenda√ß√µes
                    </h3>
                    <div id="alertasContainer">
                        <div class="text-center py-8 text-gray-500">
                            <div class="spinner"></div>
                            Analisando seus dados financeiros...
                        </div>
                    </div>
            </div>
        </div>

        <!-- Or√ßamentos Tab -->
        <div id="orcamentos" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Or√ßamentos por Categoria</h2>
                <button onclick="abrirModalOrcamento()" 
                        class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Novo Or√ßamento
                </button>
            </div>

            <!-- Cards de Or√ßamentos -->
            <div id="orcamentosContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Or√ßamentos ser√£o inseridos aqui dinamicamente -->
            </div>

            <!-- Resumo Geral -->
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-chart-pie mr-2 text-blue-500"></i>
                    Resumo dos Or√ßamentos
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600" id="totalOrcamentos">R$ 0,00</div>
                        <div class="text-sm text-gray-600">Total Or√ßado</div>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="totalGasto">R$ 0,00</div>
                        <div class="text-sm text-gray-600">Total Gasto</div>
                    </div>
                    <div class="text-center p-4 bg-yellow-50 rounded-lg">
                        <div class="text-2xl font-bold text-yellow-600" id="totalDisponivel">R$ 0,00</div>
                        <div class="text-sm text-gray-600">Dispon√≠vel</div>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600" id="percentualGasto">0%</div>
                        <div class="text-sm text-gray-600">% Utilizado</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transa√ß√µes Recorrentes Tab -->
        <div id="recorrentes" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Transa√ß√µes Recorrentes</h2>
                <button onclick="abrirModalRecorrente()" 
                        class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Nova Recorrente
                </button>
            </div>

            <!-- Cards de Transa√ß√µes Recorrentes -->
            <div id="recorrentsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Transa√ß√µes recorrentes ser√£o inseridas aqui dinamicamente -->
            </div>

            <!-- Pr√≥ximas Execu√ß√µes -->
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-calendar-alt mr-2 text-blue-500"></i>
                    Pr√≥ximas Execu√ß√µes (30 dias)
                </h3>
                <div id="proximasExecucoes" class="space-y-3">
                    <!-- Pr√≥ximas execu√ß√µes ser√£o inseridas aqui -->
                </div>
            </div>
        </div>

        <!-- Fluxo de Caixa Tab -->
        <div id="fluxo" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Fluxo de Caixa</h2>
                <div class="flex space-x-3">
                    <select id="fluxoPeriodo" onchange="atualizarFluxoCaixa()"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="6">√öltimos 6 meses</option>
                        <option value="12" selected>√öltimos 12 meses</option>
                        <option value="24">√öltimos 24 meses</option>
                    </select>
                    <select id="fluxoTipo" onchange="atualizarFluxoCaixa()"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="mensal" selected>Mensal</option>
                        <option value="semanal">Semanal</option>
                        <option value="diario">Di√°rio</option>
                    </select>
                </div>
            </div>

            <!-- Resumo do Fluxo -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Entradas</p>
                            <p id="fluxoTotalEntradas" class="text-2xl font-bold text-green-600">R$ 0,00</p>
                        </div>
                        <div class="p-3 bg-green-100 rounded-full">
                            <i class="fas fa-arrow-up text-green-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Sa√≠das</p>
                            <p id="fluxoTotalSaidas" class="text-2xl font-bold text-red-600">R$ 0,00</p>
                        </div>
                        <div class="p-3 bg-red-100 rounded-full">
                            <i class="fas fa-arrow-down text-red-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Fluxo L√≠quido</p>
                            <p id="fluxoLiquido" class="text-2xl font-bold">R$ 0,00</p>
                        </div>
                        <div class="p-3 bg-blue-100 rounded-full">
                            <i class="fas fa-balance-scale text-blue-600"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">M√©dia Mensal</p>
                            <p id="fluxoMediaMensal" class="text-2xl font-bold text-purple-600">R$ 0,00</p>
                        </div>
                        <div class="p-3 bg-purple-100 rounded-full">
                            <i class="fas fa-chart-bar text-purple-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico de Fluxo de Caixa -->
            <div class="bg-white rounded-xl p-6 shadow-lg mb-8">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-chart-area mr-2 text-blue-500"></i>
                    Evolu√ß√£o do Fluxo de Caixa
                </h3>
                <div class="h-96">
                    <canvas id="fluxoCaixaChart"></canvas>
                </div>
            </div>

            <!-- An√°lise por Categoria -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Entradas por Categoria -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-arrow-up mr-2 text-green-500"></i>
                        Entradas por Categoria
                    </h3>
                    <div id="fluxoEntradasCategoria" class="space-y-3">
                        <!-- Categorias de entrada ser√£o inseridas aqui -->
                    </div>
                </div>

                <!-- Sa√≠das por Categoria -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-arrow-down mr-2 text-red-500"></i>
                        Sa√≠das por Categoria
                    </h3>
                    <div id="fluxoSaidasCategoria" class="space-y-3">
                        <!-- Categorias de sa√≠da ser√£o inseridas aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- An√°lise Comparativa Tab -->
        <div id="comparativo" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">An√°lise Comparativa</h2>
                <div class="flex space-x-3">
                    <select id="comparativoTipo" onchange="atualizarComparativo()"
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="mensal" selected>M√™s Atual vs Anterior</option>
                        <option value="trimestral">Trimestre Atual vs Anterior</option>
                        <option value="anual">Ano Atual vs Anterior</option>
                        <option value="personalizado">Per√≠odo Personalizado</option>
                    </select>
                    <div id="comparativoPersonalizado" class="hidden flex space-x-2">
                        <input id="comparativoPeriodo1Inicio" type="date" 
                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <input id="comparativoPeriodo1Fim" type="date" 
                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <span class="self-center text-gray-500">vs</span>
                        <input id="comparativoPeriodo2Inicio" type="date" 
                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <input id="comparativoPeriodo2Fim" type="date" 
                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button onclick="atualizarComparativo()" 
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                            Comparar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Resumo Comparativo -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-medium text-gray-600">Receitas</h3>
                        <i class="fas fa-arrow-up text-green-500"></i>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <span class="text-xs text-gray-500" id="comparativoReceitasPeriodo1Label">Per√≠odo 1</span>
                            <div class="text-lg font-bold text-green-600" id="comparativoReceitasPeriodo1">R$ 0,00</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500" id="comparativoReceitasPeriodo2Label">Per√≠odo 2</span>
                            <div class="text-lg font-bold text-green-600" id="comparativoReceitasPeriodo2">R$ 0,00</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i id="comparativoReceitasIcon" class="fas fa-arrow-up text-green-500"></i>
                            <span id="comparativoReceitasVariacao" class="text-sm font-medium">0%</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-medium text-gray-600">Despesas</h3>
                        <i class="fas fa-arrow-down text-red-500"></i>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <span class="text-xs text-gray-500" id="comparativoDespesasPeriodo1Label">Per√≠odo 1</span>
                            <div class="text-lg font-bold text-red-600" id="comparativoDespesasPeriodo1">R$ 0,00</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500" id="comparativoDespesasPeriodo2Label">Per√≠odo 2</span>
                            <div class="text-lg font-bold text-red-600" id="comparativoDespesasPeriodo2">R$ 0,00</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i id="comparativoDespesasIcon" class="fas fa-arrow-up text-red-500"></i>
                            <span id="comparativoDespesasVariacao" class="text-sm font-medium">0%</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-medium text-gray-600">Saldo</h3>
                        <i class="fas fa-balance-scale text-blue-500"></i>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <span class="text-xs text-gray-500" id="comparativoSaldoPeriodo1Label">Per√≠odo 1</span>
                            <div class="text-lg font-bold" id="comparativoSaldoPeriodo1">R$ 0,00</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500" id="comparativoSaldoPeriodo2Label">Per√≠odo 2</span>
                            <div class="text-lg font-bold" id="comparativoSaldoPeriodo2">R$ 0,00</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i id="comparativoSaldoIcon" class="fas fa-arrow-up text-green-500"></i>
                            <span id="comparativoSaldoVariacao" class="text-sm font-medium">0%</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-medium text-gray-600">Economia</h3>
                        <i class="fas fa-piggy-bank text-purple-500"></i>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <span class="text-xs text-gray-500" id="comparativoEconomiaPeriodo1Label">Per√≠odo 1</span>
                            <div class="text-lg font-bold text-purple-600" id="comparativoEconomiaPeriodo1">0%</div>
                        </div>
                        <div>
                            <span class="text-xs text-gray-500" id="comparativoEconomiaPeriodo2Label">Per√≠odo 2</span>
                            <div class="text-lg font-bold text-purple-600" id="comparativoEconomiaPeriodo2">0%</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i id="comparativoEconomiaIcon" class="fas fa-arrow-up text-purple-500"></i>
                            <span id="comparativoEconomiaVariacao" class="text-sm font-medium">0pp</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico Comparativo -->
            <div class="bg-white rounded-xl p-6 shadow-lg mb-8">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-chart-bar mr-2 text-blue-500"></i>
                    Compara√ß√£o por Categoria
                </h3>
                <div class="h-96">
                    <canvas id="comparativoChart"></canvas>
                </div>
            </div>

            <!-- An√°lise Detalhada -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Maiores Varia√ß√µes -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-orange-500"></i>
                        Maiores Varia√ß√µes
                    </h3>
                    <div id="comparativoVariacoes" class="space-y-3">
                        <!-- Varia√ß√µes ser√£o inseridas aqui -->
                    </div>
                </div>

                <!-- Insights e Recomenda√ß√µes -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                        Insights e Recomenda√ß√µes
                    </h3>
                    <div id="comparativoInsights" class="space-y-3">
                        <!-- Insights ser√£o inseridos aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Proje√ß√£o Tab -->
        <div id="projecao" class="tab-content hidden">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Proje√ß√£o Financeira Anual</h2>

                <!-- Controles de Simula√ß√£o -->
                <div class="filter-container mb-8">
                    <h3 class="text-lg font-semibold mb-4">Simulador de Cen√°rios</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Aumento de Receita (%)</label>
                            <input type="number" id="aumentoReceita" value="0" min="-50" max="100" step="5"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                onchange="updateProjecaoPersonalizada()">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Redu√ß√£o de Despesas
                                (%)</label>
                            <input type="number" id="reducaoDespesas" value="0" min="-50" max="50" step="5"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                onchange="updateProjecaoPersonalizada()">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2 text-gray-700">Meta de Economia
                                Mensal</label>
                            <input type="text" id="metaEconomia" placeholder="1.000,00"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                oninput="formatCurrency(this)" onchange="updateProjecaoPersonalizada()">
                        </div>
                    </div>
                </div>

                <!-- Gr√°fico de Proje√ß√£o -->
                <div class="bg-white rounded-xl p-6 shadow-lg mb-8">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-chart-bar mr-2 text-purple-500"></i>
                        Proje√ß√£o de Economia Mensal
                    </h3>
                    <div class="chart-container">
                        <canvas id="projecaoChart"></canvas>
                    </div>
                </div>

                <!-- Cen√°rios de Proje√ß√£o -->
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-6">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mr-3"></i>
                            <h3 class="text-lg font-bold text-yellow-700">Conservador</h3>
                        </div>
                        <p class="text-3xl font-bold text-yellow-600 mb-3" id="cenarioConservador">R$ 0,00</p>
                        <p class="text-sm text-gray-600 mb-4">Economia at√© dezembro</p>
                        <div class="space-y-2 text-xs text-gray-500">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-yellow-500 mr-2"></i>
                                <span>Considera imprevistos</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-yellow-500 mr-2"></i>
                                <span>Gastos emergenciais +10%</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-chart-line text-blue-500 text-2xl mr-3"></i>
                            <h3 class="text-lg font-bold text-blue-700">Realista</h3>
                        </div>
                        <p class="text-3xl font-bold text-blue-600 mb-3" id="cenarioRealista">R$ 0,00</p>
                        <p class="text-sm text-gray-600 mb-4">Economia at√© dezembro</p>
                        <div class="space-y-2 text-xs text-gray-500">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-blue-500 mr-2"></i>
                                <span>Padr√£o atual mantido</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-blue-500 mr-2"></i>
                                <span>Receita est√°vel</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-green-50 border-2 border-green-200 rounded-xl p-6">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-rocket text-green-500 text-2xl mr-3"></i>
                            <h3 class="text-lg font-bold text-green-700">Otimista</h3>
                        </div>
                        <p class="text-3xl font-bold text-green-600 mb-3" id="cenarioOtimista">R$ 0,00</p>
                        <p class="text-sm text-gray-600 mb-4">Economia at√© dezembro</p>
                        <div class="space-y-2 text-xs text-gray-500">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span>Aumento receita +15%</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span>Redu√ß√£o gastos -10%</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-6">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-cogs text-purple-500 text-2xl mr-3"></i>
                            <h3 class="text-lg font-bold text-purple-700">Personalizado</h3>
                        </div>
                        <p class="text-3xl font-bold text-purple-600 mb-3" id="cenarioPersonalizado">R$ 0,00</p>
                        <p class="text-sm text-gray-600 mb-4">Sua simula√ß√£o</p>
                        <div class="space-y-2 text-xs text-gray-500">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-purple-500 mr-2"></i>
                                <span id="personalizadoReceita">Receita: --</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-purple-500 mr-2"></i>
                                <span id="personalizadoDespesa">Despesa: --</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- An√°lise e Recomenda√ß√µes -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                            An√°lise Inteligente
                        </h3>
                        <div id="analiseInteligente" class="space-y-3 text-sm text-gray-600">
                            <!-- An√°lise ser√° gerada automaticamente -->
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-target mr-2 text-purple-500"></i>
                            Metas Sugeridas
                        </h3>
                        <div id="metasSugeridas" class="space-y-3 text-sm text-gray-600">
                            <!-- Metas ser√£o geradas automaticamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="confirmModal"
        class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md fade-in">
            <div class="flex items-center mb-4">
                <i id="confirmIcon" class="fas fa-question-circle text-3xl text-blue-500 mr-3"></i>
                <h3 id="confirmTitle" class="text-lg font-semibold">Confirmar A√ß√£o</h3>
            </div>
            <p id="confirmMessage" class="text-gray-600 mb-6">Deseja realmente executar esta a√ß√£o?</p>
            <div class="flex space-x-3">
                <button onclick="closeConfirmModal()"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button id="confirmButton"
                    class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o -->
    <div id="editModal"
        class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md fade-in">
            <div class="flex items-center justify-between mb-4">
                <h3 id="editTitle" class="text-lg font-semibold">Editar Item</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="editForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Descri√ß√£o</label>
                    <input id="editDescricao" type="text" required maxlength="100"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Valor</label>
                    <input id="editValor" type="text" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        oninput="formatCurrency(this)">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Categoria</label>
                    <select id="editCategoria" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
                    </select>
                </div>
                <div id="editDataContainer">
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Data</label>
                    <input id="editData" type="date" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="flex space-x-3">
                    <button type="button" onclick="closeEditModal()"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Or√ßamento -->
    <div id="orcamentoModal"
        class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md fade-in">
            <div class="flex items-center justify-between mb-4">
                <h3 id="orcamentoTitle" class="text-lg font-semibold">Novo Or√ßamento</h3>
                <button onclick="fecharModalOrcamento()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="orcamentoForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Categoria</label>
                    <select id="orcamentoCategoria" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Selecione uma categoria</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Valor do Or√ßamento</label>
                    <input id="orcamentoValor" type="text" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="R$ 0,00" oninput="formatCurrency(this)">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Per√≠odo</label>
                    <select id="orcamentoPeriodo" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="mensal">Mensal</option>
                        <option value="anual">Anual</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Descri√ß√£o (opcional)</label>
                    <textarea id="orcamentoDescricao" rows="3" maxlength="200"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Descreva o objetivo deste or√ßamento..."></textarea>
                </div>
                <div class="flex space-x-3">
                    <button type="button" onclick="fecharModalOrcamento()"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <span id="orcamentoSubmitText">Criar Or√ßamento</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Transa√ß√£o Recorrente -->
    <div id="recorrenteModal"
        class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md fade-in">
            <div class="flex items-center justify-between mb-4">
                <h3 id="recorrenteTitle" class="text-lg font-semibold">Nova Transa√ß√£o Recorrente</h3>
                <button onclick="fecharModalRecorrente()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="recorrenteForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Tipo</label>
                    <select id="recorrenteTipo" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="receita">Receita</option>
                        <option value="despesa">Despesa</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Descri√ß√£o</label>
                    <input id="recorrenteDescricao" type="text" required maxlength="100"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Ex: Sal√°rio, Aluguel, Internet...">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Valor</label>
                    <input id="recorrenteValor" type="text" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="R$ 0,00" oninput="formatCurrency(this)">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Categoria</label>
                    <select id="recorrenteCategoria" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Selecione uma categoria</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Frequ√™ncia</label>
                    <select id="recorrenteFrequencia" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="semanal">Semanal</option>
                        <option value="mensal" selected>Mensal</option>
                        <option value="bimestral">Bimestral</option>
                        <option value="trimestral">Trimestral</option>
                        <option value="semestral">Semestral</option>
                        <option value="anual">Anual</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Dia de Execu√ß√£o</label>
                    <input id="recorrenteDia" type="number" min="1" max="31" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Ex: 5 (dia 5 de cada m√™s)">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Data de In√≠cio</label>
                    <input id="recorrenteDataInicio" type="date" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Data de Fim (opcional)</label>
                    <input id="recorrenteDataFim" type="date"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="flex items-center">
                    <input id="recorrenteAtiva" type="checkbox" checked
                        class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="recorrenteAtiva" class="text-sm text-gray-700">Ativa (executar automaticamente)</label>
                </div>
                <div class="flex space-x-3">
                    <button type="button" onclick="fecharModalRecorrente()"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        <span id="recorrenteSubmitText">Criar Recorrente</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast de Notifica√ß√£o -->
    <div id="toast" class="toast-container">
        <div class="bg-white border-l-4 border-green-500 rounded-lg shadow-lg p-4 flex items-center space-x-3">
            <i id="toastIcon" class="fas fa-check-circle text-green-500"></i>
            <div>
                <p id="toastTitle" class="font-semibold text-gray-800">Sucesso</p>
                <p id="toastMessage" class="text-sm text-gray-600">Opera√ß√£o realizada com sucesso</p>
            </div>
        </div>
    </div>

    <!-- JavaScript Principal -->


    <script type="module">
        // ==================== IMPORTS E CONFIGURA√á√ÉO FIREBASE ====================
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import {
            getFirestore,
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            query,
            orderBy,
            onSnapshot,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Configura√ß√£o do Firebase
        const firebaseConfig = JSON.parse(document.getElementById('firebase-config').textContent);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // ==================== VARI√ÅVEIS GLOBAIS ====================
        let currentUser = null;
        let transacoes = [];
        let patrimonio = [];
        let orcamentos = [];
        let recorrentes = [];
        let unsubscribeTransacoes = null;
        let unsubscribePatrimonio = null;
        let unsubscribeOrcamentos = null;
        let unsubscribeRecorrentes = null;

        // Filtros de per√≠odo
        let filtroMesAtual = null;
        let filtroAnoAtual = null;

        // Vari√°veis para edi√ß√£o
        let orcamentoEditando = null;
        let recorrenteEditando = null;

        // Gr√°ficos
        let evolucaoChart = null;
        let categoriaChart = null;
        let projecaoChart = null;
        let tendenciaMensalChart = null;
        let fluxoCaixaChart = null;
        let comparativoChart = null;

        // Vari√°veis para relat√≥rios - CORRIGIDAS
        let transacoesFiltradas = [];
        let ordenacaoAtual = { campo: 'data', direcao: 'desc' };

        // ==================== UTILIT√ÅRIOS ====================

        /**
         * Formata valor para moeda brasileira
         * @param {number} value - Valor num√©rico
         * @returns {string} - Valor formatado
         */
        function formatBRL(value) {
            if (typeof value !== 'number' || isNaN(value)) return 'R$ 0,00';
            return value.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        }

        /**
         * Converte string monet√°ria para n√∫mero
         * @param {string} str - String no formato "1.000,00"
         * @returns {number} - Valor num√©rico
         */
        function parseBRL(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
        }

        /**
         * Formata campo de moeda durante digita√ß√£o
         * @param {HTMLInputElement} input - Campo de entrada
         */
        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, '');
            if (value === '') {
                input.value = '';
                return;
            }

            value = parseInt(value);
            const max = parseInt(input.dataset.max) || 999999999;
            if (value > max) value = max;

            input.value = (value / 100).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        /**
         * Sanitiza string para prevenir XSS
         * @param {string} str - String a ser sanitizada
         * @returns {string} - String sanitizada
         */
        function sanitizeString(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        /**
         * Valida se data √© v√°lida
         * @param {string} dateString - String de data
         * @returns {boolean} - Se √© v√°lida
         */
        function isValidDate(dateString) {
            const date = new Date(dateString);
            return date instanceof Date && !isNaN(date);
        }

        /**
         * Define data de hoje nos campos de data
         */
        function setToday() {
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = ['receita-data', 'despesa-data'];
            dateInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input && !input.value) {
                    input.value = today;
                }
            });
        }

        /**
         * Exibe toast de notifica√ß√£o
         * @param {string} title - T√≠tulo da notifica√ß√£o
         * @param {string} message - Mensagem
         * @param {string} type - Tipo (success, error, warning, info)
         */
        function showToast(title, message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const titleEl = document.getElementById('toastTitle');
            const messageEl = document.getElementById('toastMessage');

            const config = {
                success: { icon: 'fas fa-check-circle text-green-500', border: 'border-green-500' },
                error: { icon: 'fas fa-times-circle text-red-500', border: 'border-red-500' },
                warning: { icon: 'fas fa-exclamation-triangle text-yellow-500', border: 'border-yellow-500' },
                info: { icon: 'fas fa-info-circle text-blue-500', border: 'border-blue-500' }
            };

            const { icon: iconClass, border } = config[type] || config.success;

            icon.className = iconClass;
            titleEl.textContent = title;
            messageEl.textContent = message;
            toast.querySelector('div').className = `bg-white ${border} border-l-4 rounded-lg shadow-lg p-4 flex items-center space-x-3`;

            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        /**
         * Mostra erro em campo espec√≠fico
         * @param {HTMLInputElement} input - Campo com erro
         * @param {string} message - Mensagem de erro
         */
        function showFieldError(input, message) {
            input.classList.add('input-error');
            input.classList.remove('input-success');

            const errorId = input.id + '-error';
            const errorEl = document.getElementById(errorId);
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            }
        }

        /**
         * Esconde erro em campo espec√≠fico
         * @param {HTMLInputElement} input - Campo
         */
        function hideFieldError(input) {
            input.classList.remove('input-error');
            input.classList.add('input-success');

            const errorId = input.id + '-error';
            const errorEl = document.getElementById(errorId);
            if (errorEl) {
                errorEl.classList.add('hidden');
            }
        }

        /**
         * Valida formul√°rio com regras espec√≠ficas
         * @param {HTMLFormElement} form - Formul√°rio
         * @param {string} type - Tipo (receita, despesa, patrimonio)
         * @returns {Object|null} - Dados validados ou null se inv√°lido
         */
        function validateForm(form, type) {
            const errors = {};
            let isValid = true;

            // Limpa erros anteriores
            form.querySelectorAll('.input-error').forEach(input => {
                hideFieldError(input);
            });

            // Valida√ß√£o de descri√ß√£o
            const descricao = form.descricao.value.trim();
            if (!descricao) {
                errors.descricao = 'Descri√ß√£o √© obrigat√≥ria';
                isValid = false;
            } else if (descricao.length < 3) {
                errors.descricao = 'Descri√ß√£o deve ter pelo menos 3 caracteres';
                isValid = false;
            } else if (descricao.length > 100) {
                errors.descricao = 'Descri√ß√£o deve ter no m√°ximo 100 caracteres';
                isValid = false;
            }

            // Valida√ß√£o de valor
            const valorStr = form.valor.value.trim();
            if (!valorStr) {
                errors.valor = 'Valor √© obrigat√≥rio';
                isValid = false;
            } else {
                const valor = parseBRL(valorStr);
                if (valor <= 0) {
                    errors.valor = 'Valor deve ser maior que zero';
                    isValid = false;
                } else if (valor > 999999999) {
                    errors.valor = 'Valor muito alto';
                    isValid = false;
                }
            }

            // Valida√ß√£o de categoria
            if (!form.categoria.value) {
                errors.categoria = 'Categoria √© obrigat√≥ria';
                isValid = false;
            }

            // Valida√ß√£o de data (apenas para transa√ß√µes)
            if (type !== 'patrimonio') {
                const dataValue = form.data.value;
                if (!dataValue) {
                    errors.data = 'Data √© obrigat√≥ria';
                    isValid = false;
                } else if (!isValidDate(dataValue)) {
                    errors.data = 'Data inv√°lida';
                    isValid = false;
                } else {
                const dataTransacao = new Date(dataValue + 'T00:00:00');
                    const hoje = new Date();
                    const umAnoAtras = new Date();
                    umAnoAtras.setFullYear(hoje.getFullYear() - 1);

                    if (dataTransacao > hoje) {
                        errors.data = 'Data n√£o pode ser futura';
                        isValid = false;
                    } else if (dataTransacao < umAnoAtras) {
                        errors.data = 'Data muito antiga (m√°ximo 1 ano)';
                        isValid = false;
                    }
                }
            }

            // Valida√ß√£o espec√≠fica para patrim√¥nio
            if (type === 'patrimonio') {
                if (!['bem', 'divida'].includes(form.tipo.value)) {
                    errors.tipo = 'Tipo inv√°lido';
                    isValid = false;
                }
            }

            // Exibe erros
            Object.keys(errors).forEach(field => {
                const input = form[field];
                if (input) {
                    showFieldError(input, errors[field]);
                }
            });

            if (!isValid) {
                showToast('Erro de Valida√ß√£o', 'Por favor, corrija os erros no formul√°rio', 'error');
                return null;
            }

            // Retorna dados validados
            const data = {
                descricao: descricao,
                valor: parseBRL(valorStr),
                categoria: form.categoria.value
            };

            if (type !== 'patrimonio') {
                data.tipo = type;
                data.data = form.data.value;
            } else {
                data.tipo = form.tipo.value;
            }

            return data;
        }

        // ==================== AUTENTICA√á√ÉO ====================

        async function loginWithGoogle() {
            const loginBtn = document.getElementById('loginBtn');
            try {
                loginBtn.classList.add('loading');
                loginBtn.innerHTML = '<div class="spinner"></div>Conectando...';
                const result = await signInWithPopup(auth, provider);
                currentUser = result.user;
                showToast('Sucesso', 'Login realizado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro no login:', error);
                let errorMessage = 'Falha ao fazer login. Tente novamente.';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Login cancelado pelo usu√°rio';
                } else if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'Pop-up bloqueado. Permita pop-ups para este site';
                }
                showToast('Erro', errorMessage, 'error');
            } finally {
                loginBtn.classList.remove('loading');
                loginBtn.innerHTML = '<i class="fab fa-google mr-2"></i>Entrar com Google';
            }
        }

        async function logout() {
            try {
                await signOut(auth);
                showToast('Sucesso', 'Logout realizado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro no logout:', error);
                showToast('Erro', 'Erro ao fazer logout', 'error');
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showApp();
                initializeUserData();
            } else {
                currentUser = null;
                showLogin();
                cleanupListeners();
            }
        });

        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appScreen').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');

            document.getElementById('userName').textContent = currentUser.displayName;
            document.getElementById('userPhoto').src = currentUser.photoURL ||
                'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM2MzY2RjEiLz4KPHRleHQgeD0iNTAlIiB5PSI1MCUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBkeT0iLjNlbSIgZm9udC1zaXplPSIxNCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiPjw/dGV4dD4KPC9zdmc+';

            setToday();
            initYearFilter();
            const savedTab = localStorage.getItem('currentTab') || 'dashboard';
            showTab(savedTab);
        }

        // ==================== FIRESTORE OPERATIONS ====================

        function initializeUserData() {
            if (!currentUser) return;
            try {
                setupTransacoesListener();
                setupPatrimonioListener();
                setupOrcamentosListener();
                setupRecorrentesListener();
                initCharts();
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                showToast('Erro', 'Erro ao carregar dados do usu√°rio', 'error');
            }
        }

        function setupTransacoesListener() {
            if (unsubscribeTransacoes) unsubscribeTransacoes();
            try {
                const q = query(
                    collection(db, 'users', currentUser.uid, 'transacoes'),
                    orderBy('createdAt', 'desc')
                );

                unsubscribeTransacoes = onSnapshot(q, (snapshot) => {
                    transacoes = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.valor && data.descricao && data.categoria) {
                            transacoes.push({ id: doc.id, ...data });
                        }
                    });

                    renderTransacoes();
                    updateDashboard();
                    updateCharts();
                    updateRelatorios();
                    updateInsights();
                }, (error) => {
                    console.error('Erro ao carregar transa√ß√µes:', error);
                    showToast('Erro', 'Erro ao carregar transa√ß√µes. Verifique sua conex√£o.', 'error');
                });
            } catch (error) {
                console.error('Erro no listener de transa√ß√µes:', error);
                showToast('Erro', 'Erro na configura√ß√£o do sincronismo', 'error');
            }
        }

        function setupPatrimonioListener() {
            if (unsubscribePatrimonio) unsubscribePatrimonio();
            try {
                const q = query(collection(db, 'users', currentUser.uid, 'patrimonio'));

                unsubscribePatrimonio = onSnapshot(q, (snapshot) => {
                    patrimonio = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.valor && data.descricao && data.categoria && data.tipo) {
                            patrimonio.push({ id: doc.id, ...data });
                        }
                    });
                    renderPatrimonio();
                }, (error) => {
                    console.error('Erro ao carregar patrim√¥nio:', error);
                    showToast('Erro', 'Erro ao carregar patrim√¥nio. Verifique sua conex√£o.', 'error');
                });
            } catch (error) {
                console.error('Erro no listener de patrim√¥nio:', error);
                showToast('Erro', 'Erro na configura√ß√£o do sincronismo', 'error');
            }
        }

        function cleanupListeners() {
            try {
                if (unsubscribeTransacoes) {
                    unsubscribeTransacoes();
                    unsubscribeTransacoes = null;
                }
                if (unsubscribePatrimonio) {
                    unsubscribePatrimonio();
                    unsubscribePatrimonio = null;
                }
                if (unsubscribeOrcamentos) {
                    unsubscribeOrcamentos();
                    unsubscribeOrcamentos = null;
                }
                if (unsubscribeRecorrentes) {
                    unsubscribeRecorrentes();
                    unsubscribeRecorrentes = null;
                }
            } catch (error) {
                console.error('Erro ao limpar listeners:', error);
            }
        }

        async function addTransaction(data) {
            try {
                if (!currentUser) throw new Error('Usu√°rio n√£o autenticado');
                await addDoc(collection(db, 'users', currentUser.uid, 'transacoes'), {
                    ...data,
                    createdAt: serverTimestamp()
                });
                showToast('Sucesso', `${data.tipo === 'receita' ? 'Receita' : 'Despesa'} adicionada com sucesso!`, 'success');
            } catch (error) {
                console.error('Erro ao salvar transa√ß√£o:', error);
                let errorMessage = 'Erro ao salvar transa√ß√£o';
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permiss√£o negada. Verifique suas credenciais.';
                } else if (error.code === 'unavailable') {
                    errorMessage = 'Servi√ßo indispon√≠vel. Tente novamente.';
                }
                showToast('Erro', errorMessage, 'error');
                throw error;
            }
        }

        async function addPatrimony(data) {
            try {
                if (!currentUser) throw new Error('Usu√°rio n√£o autenticado');
                await addDoc(collection(db, 'users', currentUser.uid, 'patrimonio'), {
                    ...data,
                    createdAt: serverTimestamp()
                });
                showToast('Sucesso', `${data.tipo === 'bem' ? 'Bem' : 'D√≠vida'} adicionado(a) com sucesso!`, 'success');
            } catch (error) {
                console.error('Erro ao salvar patrim√¥nio:', error);
                let errorMessage = 'Erro ao salvar patrim√¥nio';
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permiss√£o negada. Verifique suas credenciais.';
                }
                showToast('Erro', errorMessage, 'error');
                throw error;
            }
        }

        async function updateItem(collectionName, id, data) {
            try {
                if (!currentUser || !id) throw new Error('Dados inv√°lidos para atualiza√ß√£o');
                const docRef = doc(db, 'users', currentUser.uid, collectionName, id);
                await updateDoc(docRef, data);
                showToast('Sucesso', 'Item atualizado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao atualizar:', error);
                showToast('Erro', 'Erro ao atualizar item', 'error');
                throw error;
            }
        }

        async function deleteItem(collectionName, id) {
            try {
                if (!currentUser || !id) throw new Error('Dados inv√°lidos para exclus√£o');
                await deleteDoc(doc(db, 'users', currentUser.uid, collectionName, id));
                showToast('Sucesso', 'Item removido com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao excluir:', error);
                showToast('Erro', 'Erro ao excluir item', 'error');
                throw error;
            }
        }

        // ==================== FILTROS DE PER√çODO ====================

        function initYearFilter() {
            const yearSelect = document.getElementById('dashboardYear');
            if (!yearSelect) return;

            yearSelect.innerHTML = '<option value="">Todos os anos</option>';
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }

            // Define m√™s atual por padr√£o
            const monthSelect = document.getElementById('dashboardMonth');
            if (monthSelect) {
                monthSelect.value = new Date().getMonth();
            }

            filtroMesAtual = new Date().getMonth();
            filtroAnoAtual = currentYear;
        }

        function updateDashboardPeriod() {
            const monthSelect = document.getElementById('dashboardMonth');
            const yearSelect = document.getElementById('dashboardYear');

            filtroMesAtual = monthSelect.value === '' ? null : parseInt(monthSelect.value);
            filtroAnoAtual = yearSelect.value === '' ? null : parseInt(yearSelect.value);

            // Sincroniza filtros em todas as abas
            syncFiltersAcrossTabs();

            updateDashboard();
            updateCharts();
            updateInsights();
            updateRelatorios();
        }

        // Nova fun√ß√£o para sincronizar filtros entre todas as abas
        function syncFiltersAcrossTabs() {
            const monthSelect = document.getElementById('dashboardMonth');
            const yearSelect = document.getElementById('dashboardYear');
            
            // Sincroniza filtros de relat√≥rios se existirem
            const relatorioMes = document.getElementById('filtroMes');
            const relatorioAno = document.getElementById('filtroAno');
            
            if (relatorioMes && relatorioAno) {
                relatorioMes.value = monthSelect.value;
                relatorioAno.value = yearSelect.value;
            }
            
            // Atualiza insights se a aba estiver ativa
            if (document.getElementById('insights') && !document.getElementById('insights').classList.contains('hidden')) {
                updateInsights();
            }
            
            // Atualiza relat√≥rios se a aba estiver ativa
            if (document.getElementById('relatorios') && !document.getElementById('relatorios').classList.contains('hidden')) {
                if (typeof aplicarFiltros === 'function') {
                    aplicarFiltros();
                }
            }
        }

        // Nova fun√ß√£o para sincronizar filtros a partir dos relat√≥rios
        function syncFiltersFromReports() {
            const relatorioMes = document.getElementById('filtroMes');
            const relatorioAno = document.getElementById('filtroAno');
            const monthSelect = document.getElementById('dashboardMonth');
            const yearSelect = document.getElementById('dashboardYear');
            
            if (relatorioMes && relatorioAno && monthSelect && yearSelect) {
                monthSelect.value = relatorioMes.value;
                yearSelect.value = relatorioAno.value;
                
                // Atualiza as vari√°veis globais de filtro
                filtroMesAtual = relatorioMes.value === '' ? null : parseInt(relatorioMes.value);
                filtroAnoAtual = relatorioAno.value === '' ? null : parseInt(relatorioAno.value);
                
                // Atualiza todas as abas
                updateDashboard();
                updateCharts();
                updateInsights();
                aplicarFiltros();
            }
        }

        function filterTransactionsByPeriod(transactions) {
            if (!filtroMesAtual && filtroMesAtual !== 0 && !filtroAnoAtual) {
                return transactions;
            }

            return transactions.filter(t => {
                if (!t.data) return false;
                const dataTransacao = new Date(t.data + 'T00:00:00');

                let mesMatch = true;
                let anoMatch = true;

                if (filtroMesAtual || filtroMesAtual === 0) {
                    mesMatch = dataTransacao.getMonth() === filtroMesAtual;
                }

                if (filtroAnoAtual) {
                    anoMatch = dataTransacao.getFullYear() === filtroAnoAtual;
                }

                return mesMatch && anoMatch;
            });
        }

        // ==================== UI RENDERING APRIMORADO ====================

        function renderTransacoes() {
            const tbody = document.getElementById('transacoesTableBody');
            const totalEl = document.getElementById('totalTransacoes');
            const receitasList = document.getElementById('receitasList');
            const despesasList = document.getElementById('despesasList');

            if (!tbody || !totalEl || !receitasList || !despesasList) return;

            tbody.innerHTML = '';
            receitasList.innerHTML = '';
            despesasList.innerHTML = '';

            // Aplica filtro de per√≠odo
            const transacoesFiltradas = filterTransactionsByPeriod(transacoes);
            totalEl.textContent = `${transacoesFiltradas.length} transa√ß√µes`;

            try {
                // Renderiza √∫ltimas 10 transa√ß√µes na tabela
                transacoesFiltradas.slice(0, 10).forEach(transacao => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors';

                    const data = new Date(transacao.data + 'T00:00:00').toLocaleDateString('pt-BR');
                    const valor = formatBRL(transacao.valor);
                    const tipo = transacao.tipo;
                    const corValor = tipo === 'receita' ? 'text-green-600' : 'text-red-600';
                    const icone = tipo === 'receita' ? 'fa-arrow-up' : 'fa-arrow-down';
                    const emoji = tipo === 'receita' ? 'üí∞' : 'üí∏';

                    row.innerHTML = `
                        <td class="px-4 py-3">${data}</td>
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                <span class="mr-2">${emoji}</span>
                                <span class="font-medium">${sanitizeString(transacao.descricao)}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 bg-gray-100 rounded-full text-xs">${sanitizeString(transacao.categoria)}</span>
                        </td>
                        <td class="px-4 py-3 ${corValor} font-semibold text-right">
                            <i class="fas ${icone} mr-1"></i>${valor}
                        </td>
                        <td class="px-4 py-3 text-center no-print">
                            <button onclick="editTransaction('${transacao.id}')" 
                                    class="text-blue-500 hover:text-blue-700 mr-2" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTransactionConfirm('${transacao.id}')" 
                                    class="text-red-500 hover:text-red-700" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Renderiza listas espec√≠ficas por tipo
                const receitas = transacoesFiltradas.filter(t => t.tipo === 'receita').slice(0, 5);
                const despesas = transacoesFiltradas.filter(t => t.tipo === 'despesa').slice(0, 5);

                receitas.forEach(receita => {
                    const item = createTransactionListItem(receita, 'green');
                    receitasList.appendChild(item);
                });

                despesas.forEach(despesa => {
                    const item = createTransactionListItem(despesa, 'red');
                    despesasList.appendChild(item);
                });

                // Mensagens quando vazio
                if (receitas.length === 0) {
                    receitasList.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhuma receita encontrada</p>';
                }
                if (despesas.length === 0) {
                    despesasList.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhuma despesa encontrada</p>';
                }

            } catch (error) {
                console.error('Erro ao renderizar transa√ß√µes:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Erro ao carregar transa√ß√µes</td></tr>';
            }
        }

        function createTransactionListItem(transacao, color) {
            const element = document.createElement('div');
            element.className = `flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors`;

            try {
                const data = new Date(transacao.data).toLocaleDateString('pt-BR');
                const valor = formatBRL(transacao.valor);
                const emoji = transacao.tipo === 'receita' ? 'üí∞' : 'üí∏';

                element.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">${emoji}</span>
                        <div>
                            <p class="font-medium text-gray-800">${sanitizeString(transacao.descricao)}</p>
                            <p class="text-xs text-gray-600">${data} ‚Ä¢ ${sanitizeString(transacao.categoria)}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-${color}-700">${valor}</p>
                        <div class="space-x-1 no-print">
                            <button onclick="editTransaction('${transacao.id}')" 
                                    class="text-blue-500 hover:text-blue-700 text-xs" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTransactionConfirm('${transacao.id}')" 
                                    class="text-red-500 hover:text-red-700 text-xs" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Erro ao criar item de transa√ß√£o:', error);
                element.innerHTML = '<p class="text-red-500">Erro ao carregar item</p>';
            }

            return element;
        }

        function renderPatrimonio() {
            const patrimonioList = document.getElementById('patrimonioList');
            if (!patrimonioList) return;

            patrimonioList.innerHTML = '';

            try {
                const bens = patrimonio.filter(p => p.tipo === 'bem');
                const dividas = patrimonio.filter(p => p.tipo === 'divida');

                const totalBens = bens.reduce((sum, b) => sum + (b.valor || 0), 0);
                const totalDividas = dividas.reduce((sum, d) => sum + (d.valor || 0), 0);
                const patrimonioLiquido = totalBens - totalDividas;

                // Atualiza resumo
                document.getElementById('totalBens').textContent = formatBRL(totalBens);
                document.getElementById('totalDividas').textContent = formatBRL(totalDividas);
                document.getElementById('patrimonioLiquido').textContent = formatBRL(patrimonioLiquido);
                document.getElementById('quantidadeBens').textContent = `${bens.length} itens`;
                document.getElementById('quantidadeDividas').textContent = `${dividas.length} itens`;
                document.getElementById('statusPatrimonio').textContent = patrimonioLiquido >= 0 ? 'Positivo' : 'Negativo';

                // Renderiza itens
                patrimonio.forEach(item => {
                    const element = createPatrimonioListItem(item);
                    patrimonioList.appendChild(element);
                });

                if (patrimonio.length === 0) {
                    patrimonioList.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum item de patrim√¥nio cadastrado</p>';
                }

            } catch (error) {
                console.error('Erro ao renderizar patrim√¥nio:', error);
                patrimonioList.innerHTML = '<p class="text-red-500 text-center py-4">Erro ao carregar patrim√¥nio</p>';
            }
        }

        function createPatrimonioListItem(item) {
            const element = document.createElement('div');
            element.className = `flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors`;

            try {
                const valor = formatBRL(item.valor);
                const color = item.tipo === 'bem' ? 'green' : 'red';
                const emoji = item.tipo === 'bem' ? 'üí∞' : 'üí∏';

                element.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">${emoji}</span>
                        <div>
                            <p class="font-medium text-gray-800">${sanitizeString(item.descricao)}</p>
                            <p class="text-xs text-gray-600">${sanitizeString(item.categoria)}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-${color}-700">${valor}</p>
                        <div class="space-x-1 no-print">
                            <button onclick="editPatrimonio('${item.id}')" 
                                    class="text-blue-500 hover:text-blue-700 text-xs" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deletePatrimonioConfirm('${item.id}')" 
                                    class="text-red-500 hover:text-red-700 text-xs" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Erro ao criar item de patrim√¥nio:', error);
                element.innerHTML = '<p class="text-red-500">Erro ao carregar item</p>';
            }

            return element;
        }

        // ==================== DASHBOARD E C√ÅLCULOS APRIMORADOS ====================

        function updateDashboard() {
            try {
                // Filtra transa√ß√µes do per√≠odo selecionado
                const transacoesPeriodo = filterTransactionsByPeriod(transacoes);

                const receitas = transacoesPeriodo.filter(t => t.tipo === 'receita');
                const despesas = transacoesPeriodo.filter(t => t.tipo === 'despesa');

                const totalReceitas = receitas.reduce((sum, t) => sum + (t.valor || 0), 0);
                const totalDespesas = despesas.reduce((sum, t) => sum + (t.valor || 0), 0);
                const saldoPeriodo = totalReceitas - totalDespesas;

                // Calcula m√©dias gerais (todos os dados)
                const receitasGerais = transacoes.filter(t => t.tipo === 'receita');
                const despesasGerais = transacoes.filter(t => t.tipo === 'despesa');

                const mediaReceitas = receitasGerais.length > 0 ?
                    receitasGerais.reduce((sum, t) => sum + (t.valor || 0), 0) / 12 : 0;
                const mediaDespesas = despesasGerais.length > 0 ?
                    despesasGerais.reduce((sum, t) => sum + (t.valor || 0), 0) / 12 : 0;

                // Atualiza elementos do dashboard
                document.getElementById('saldoAtual').textContent = formatBRL(saldoPeriodo);
                document.getElementById('receitasMes').textContent = formatBRL(totalReceitas);
                document.getElementById('despesasMes').textContent = formatBRL(totalDespesas);
                document.getElementById('economiaMensal').textContent = formatBRL(saldoPeriodo);

                document.getElementById('mediaReceitas').textContent = `M√©dia: ${formatBRL(mediaReceitas)}`;
                document.getElementById('mediaDespesas').textContent = `M√©dia: ${formatBRL(mediaDespesas)}`;

                // Atualiza resumos espec√≠ficos
                document.getElementById('totalReceitasMes').textContent = formatBRL(totalReceitas);
                document.getElementById('totalDespesasMes').textContent = formatBRL(totalDespesas);
                document.getElementById('mediaReceitasMensal').textContent = formatBRL(mediaReceitas);
                document.getElementById('mediaDespesasMensal').textContent = formatBRL(mediaDespesas);

                // Calcula percentuais
                const percentualEconomia = totalReceitas > 0 ? (saldoPeriodo / totalReceitas * 100) : 0;
                document.getElementById('percentualEconomia').textContent = `${percentualEconomia.toFixed(1)}% da receita`;

                // Atualiza estat√≠sticas avan√ßadas
                updateAdvancedStats(transacoesPeriodo);

                // Chama c√°lculos de proje√ß√£o
                updateProjecaoCalculations();
            } catch (error) {
                console.error('Erro ao atualizar dashboard:', error);
                showToast('Erro', 'Erro ao atualizar dashboard', 'error');
            }
        }

        function updateAdvancedStats(transacoesPeriodo) {
            try {
                // Tend√™ncias
                updateTendencias();

                // Maior categoria
                updateMaiorCategoria(transacoesPeriodo);

                // M√©dias di√°rias
                updateMediasDiarias(transacoesPeriodo);
            } catch (error) {
                console.error('Erro nas estat√≠sticas avan√ßadas:', error);
            }
        }

        function updateTendencias() {
            try {
                const agora = new Date();
                const mesAtual = agora.getMonth();
                const anoAtual = agora.getFullYear();

                // Calcula dados do m√™s atual e anterior
                const transacoesMesAtual = transacoes.filter(t => {
                    const data = new Date(t.data + 'T00:00:00');
                    return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
                });

                const mesAnterior = mesAtual === 0 ? 11 : mesAtual - 1;
                const anoAnterior = mesAtual === 0 ? anoAtual - 1 : anoAtual;

                const transacoesMesAnterior = transacoes.filter(t => {
                    const data = new Date(t.data + 'T00:00:00');
                    return data.getMonth() === mesAnterior && data.getFullYear() === anoAnterior;
                });

                // Calcula totais
                const receitasAtual = transacoesMesAtual.filter(t => t.tipo === 'receita').reduce((sum, t) => sum + t.valor, 0);
                const despesasAtual = transacoesMesAtual.filter(t => t.tipo === 'despesa').reduce((sum, t) => sum + t.valor, 0);
                const economiaAtual = receitasAtual - despesasAtual;

                const receitasAnterior = transacoesMesAnterior.filter(t => t.tipo === 'receita').reduce((sum, t) => sum + t.valor, 0);
                const despesasAnterior = transacoesMesAnterior.filter(t => t.tipo === 'despesa').reduce((sum, t) => sum + t.valor, 0);
                const economiaAnterior = receitasAnterior - despesasAnterior;

                // Calcula percentuais de mudan√ßa
                const tendenciaReceitas = receitasAnterior > 0 ? ((receitasAtual - receitasAnterior) / receitasAnterior * 100) : 0;
                const tendenciaDespesas = despesasAnterior > 0 ? ((despesasAtual - despesasAnterior) / despesasAnterior * 100) : 0;
                const tendenciaEconomia = economiaAnterior !== 0 ? ((economiaAtual - economiaAnterior) / Math.abs(economiaAnterior) * 100) : 0;

                // Atualiza elementos
                updateTrendElement('tendenciaReceitas', tendenciaReceitas);
                updateTrendElement('tendenciaDespesas', tendenciaDespesas * -1); // Inverte para despesas
                updateTrendElement('tendenciaEconomia', tendenciaEconomia);
            } catch (error) {
                console.error('Erro no c√°lculo de tend√™ncias:', error);
            }
        }

        function updateTrendElement(elementId, percentage) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const isPositive = percentage > 0;
            const isNegative = percentage < 0;
            const isNeutral = percentage === 0;

            const icon = isPositive ? '‚ÜóÔ∏è' : isNegative ? '‚ÜòÔ∏è' : '‚û°Ô∏è';
            const className = isPositive ? 'stat-trend-up' : isNegative ? 'stat-trend-down' : 'stat-neutral';

            element.textContent = `${icon} ${Math.abs(percentage).toFixed(1)}%`;
            element.className = `text-sm font-medium ${className}`;
        }

        function updateMaiorCategoria(transacoesPeriodo) {
            try {
                const despesas = transacoesPeriodo.filter(t => t.tipo === 'despesa');
                if (despesas.length === 0) {
                    document.getElementById('maiorCategoriaNome').textContent = 'Nenhuma despesa';
                    document.getElementById('maiorCategoriaValor').textContent = 'R$ 0,00';
                    document.getElementById('maiorCategoriaPercent').textContent = '0% do total';
                    return;
                }

                const categorias = {};
                despesas.forEach(d => {
                    categorias[d.categoria] = (categorias[d.categoria] || 0) + d.valor;
                });

                const categoriasMaior = Object.entries(categorias).sort(([, a], [, b]) => b - a);
                const [nomeCategoria, valorCategoria] = categoriasMaior[0];
                const totalDespesas = despesas.reduce((sum, d) => sum + d.valor, 0);
                const percentual = (valorCategoria / totalDespesas * 100).toFixed(1);

                // Mapeia emojis por categoria
                const emojis = {
                    'Habita√ß√£o': 'üè†', 'Alimenta√ß√£o': 'üçΩÔ∏è', 'Transporte': 'üöó',
                    'Lazer': 'üéØ', 'Sa√∫de': '‚öïÔ∏è', 'Educa√ß√£o': 'üìö', 'Roupas': 'üëï',
                    'Tecnologia': 'üíª', 'Contas': 'üìÑ', 'Outros': 'üìù'
                };

                document.getElementById('maiorCategoriaIcon').textContent = emojis[nomeCategoria] || 'üìä';
                document.getElementById('maiorCategoriaNome').textContent = nomeCategoria;
                document.getElementById('maiorCategoriaValor').textContent = formatBRL(valorCategoria);
                document.getElementById('maiorCategoriaPercent').textContent = `${percentual}% do total`;
            } catch (error) {
                console.error('Erro na maior categoria:', error);
            }
        }

        function updateMediasDiarias(transacoesPeriodo) {
            try {
                if (transacoesPeriodo.length === 0) {
                    document.getElementById('mediaDiariaReceitas').textContent = 'R$ 0,00';
                    document.getElementById('mediaDiariaDespesas').textContent = 'R$ 0,00';
                    document.getElementById('mediaDiariaSaldo').textContent = 'R$ 0,00';
                    return;
                }

                // Calcula n√∫mero de dias no per√≠odo
                const datas = transacoesPeriodo.map(t => new Date(t.data + 'T00:00:00'));
                const minData = new Date(Math.min(...datas));
                const maxData = new Date(Math.max(...datas));
                const diasPeriodo = Math.max(1, Math.ceil((maxData - minData) / (1000 * 60 * 60 * 24)) + 1);

                const receitas = transacoesPeriodo.filter(t => t.tipo === 'receita');
                const despesas = transacoesPeriodo.filter(t => t.tipo === 'despesa');

                const totalReceitas = receitas.reduce((sum, t) => sum + t.valor, 0);
                const totalDespesas = despesas.reduce((sum, t) => sum + t.valor, 0);

                const mediaDiariaReceitas = totalReceitas / diasPeriodo;
                const mediaDiariaDespesas = totalDespesas / diasPeriodo;
                const mediaDiariaSaldo = mediaDiariaReceitas - mediaDiariaDespesas;

                document.getElementById('mediaDiariaReceitas').textContent = formatBRL(mediaDiariaReceitas);
                document.getElementById('mediaDiariaDespesas').textContent = formatBRL(mediaDiariaDespesas);
                document.getElementById('mediaDiariaSaldo').textContent = formatBRL(mediaDiariaSaldo);
            } catch (error) {
                console.error('Erro nas m√©dias di√°rias:', error);
            }
        }

        function updateProjecaoCalculations() {
            try {
                const agora = new Date();
                const mesesRestantes = 12 - agora.getMonth();

                // Calcula economia mensal m√©dia baseada no hist√≥rico
                const receitaTotal = transacoes
                    .filter(t => t.tipo === 'receita' && new Date(t.data).getFullYear() === agora.getFullYear())
                    .reduce((sum, t) => sum + (t.valor || 0), 0);

                const despesaTotal = transacoes
                    .filter(t => t.tipo === 'despesa' && new Date(t.data).getFullYear() === agora.getFullYear())
                    .reduce((sum, t) => sum + (t.valor || 0), 0);

                const mesesDecorridos = agora.getMonth() + 1;
                const economiaMensalMedia = mesesDecorridos > 0 ?
                    (receitaTotal - despesaTotal) / mesesDecorridos : 0;

                // Calcula cen√°rios
                const conservador = economiaMensalMedia * 0.7 * mesesRestantes;
                const realista = economiaMensalMedia * mesesRestantes;
                const otimista = economiaMensalMedia * 1.3 * mesesRestantes;

                // Atualiza elementos
                document.getElementById('cenarioConservador').textContent = formatBRL(conservador);
                document.getElementById('cenarioRealista').textContent = formatBRL(realista);
                document.getElementById('cenarioOtimista').textContent = formatBRL(otimista);

                // Gera an√°lise inteligente
                generateAnaliseInteligente(economiaMensalMedia, receitaTotal, despesaTotal);

                // Gera metas sugeridas
                generateMetasSugeridas(economiaMensalMedia);
            } catch (error) {
                console.error('Erro nos c√°lculos de proje√ß√£o:', error);
            }
        }

        function updateProjecaoPersonalizada() {
            try {
                const aumentoReceita = parseFloat(document.getElementById('aumentoReceita').value) / 100;
                const reducaoDespesas = parseFloat(document.getElementById('reducaoDespesas').value) / 100;
                const metaEconomiaStr = document.getElementById('metaEconomia').value;
                const metaEconomia = metaEconomiaStr ? parseBRL(metaEconomiaStr) : null;

                const agora = new Date();
                const mesesRestantes = 12 - agora.getMonth();

                // Calcula m√©dias atuais
                const receitaTotal = transacoes
                    .filter(t => t.tipo === 'receita' && new Date(t.data).getFullYear() === agora.getFullYear())
                    .reduce((sum, t) => sum + (t.valor || 0), 0);

                const despesaTotal = transacoes
                    .filter(t => t.tipo === 'despesa' && new Date(t.data).getFullYear() === agora.getFullYear())
                    .reduce((sum, t) => sum + (t.valor || 0), 0);

                const mesesDecorridos = agora.getMonth() + 1;
                const receitaMensalMedia = mesesDecorridos > 0 ? receitaTotal / mesesDecorridos : 0;
                const despesaMensalMedia = mesesDecorridos > 0 ? despesaTotal / mesesDecorridos : 0;

                // Aplica modifica√ß√µes
                const novaReceita = receitaMensalMedia * (1 + aumentoReceita);
                const novaDespesa = despesaMensalMedia * (1 - reducaoDespesas);
                const novaEconomia = novaReceita - novaDespesa;

                const projecaoPersonalizada = novaEconomia * mesesRestantes;

                // Atualiza elementos
                document.getElementById('cenarioPersonalizado').textContent = formatBRL(projecaoPersonalizada);
                document.getElementById('personalizadoReceita').textContent = `Receita: ${(aumentoReceita * 100).toFixed(0)}%`;
                document.getElementById('personalizadoDespesa').textContent = `Despesa: ${(reducaoDespesas * 100).toFixed(0)}%`;

                updateProjecaoChart();
            } catch (error) {
                console.error('Erro na proje√ß√£o personalizada:', error);
            }
        }

        function generateAnaliseInteligente(economiaMensal, receitas, despesas) {
            const container = document.getElementById('analiseInteligente');
            if (!container) return;

            try {
                const analyses = [];

                // An√°lise de economia
                if (economiaMensal > 0) {
                    const percentual = receitas > 0 ? (economiaMensal / (receitas / 12) * 100) : 0;
                    if (percentual >= 20) {
                        analyses.push(`‚úÖ Excelente! Voc√™ est√° economizando ${percentual.toFixed(1)}% da sua receita mensal.`);
                    } else if (percentual >= 10) {
                        analyses.push(`‚ö†Ô∏è Boa economia de ${percentual.toFixed(1)}%, mas pode melhorar. Meta ideal: 20%.`);
                    } else {
                        analyses.push(`üî¥ Economia baixa (${percentual.toFixed(1)}%). Revise seus gastos para atingir 20%.`);
                    }
                } else {
                    analyses.push(`üö® Aten√ß√£o! Suas despesas excedem as receitas em ${formatBRL(Math.abs(economiaMensal))}.`);
                }

                // An√°lise de estabilidade
                const mesesComDados = new Set(transacoes.map(t => t.data.substring(0, 7))).size;
                if (mesesComDados >= 3) {
                    analyses.push(`üìä Voc√™ tem ${mesesComDados} meses de hist√≥rico, permitindo an√°lises mais precisas.`);
                } else {
                    analyses.push(`üìà Continue registrando para an√°lises mais precisas (${mesesComDados} meses de dados).`);
                }

                // An√°lise de categorias
                const despesasPorCategoria = {};
                transacoes.filter(t => t.tipo === 'despesa').forEach(t => {
                    despesasPorCategoria[t.categoria] = (despesasPorCategoria[t.categoria] || 0) + t.valor;
                });

                const totalDespesas = Object.values(despesasPorCategoria).reduce((sum, val) => sum + val, 0);
                const categoriasMaiores = Object.entries(despesasPorCategoria)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 2);

                if (categoriasMaiores.length > 0) {
                    const [categoria, valor] = categoriasMaiores[0];
                    const percentual = (valor / totalDespesas * 100).toFixed(1);
                    analyses.push(`üéØ Sua maior categoria de gasto √© "${categoria}" (${percentual}% do total).`);
                }

                container.innerHTML = analyses.map(analysis =>
                    `<div class="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">${analysis}</div>`
                ).join('');

            } catch (error) {
                console.error('Erro na an√°lise inteligente:', error);
                container.innerHTML = '<p class="text-red-500">Erro ao gerar an√°lise</p>';
            }
        }

        function generateMetasSugeridas(economiaMensal) {
            const container = document.getElementById('metasSugeridas');
            if (!container) return;

            try {
                const metas = [];

                // Meta de economia
                if (economiaMensal > 0) {
                    const metaAnual = economiaMensal * 12;
                    metas.push(`üéØ Meta anual: Economizar ${formatBRL(metaAnual)} mantendo o ritmo atual.`);

                    const metaEmergencia = economiaMensal * 6;
                    metas.push(`üö® Reserva de emerg√™ncia: Acumule ${formatBRL(metaEmergencia)} (6 meses de economia).`);
                } else {
                    metas.push(`‚ö†Ô∏è Prioridade: Equilibrar receitas e despesas antes de definir metas de economia.`);
                }

                // Meta de redu√ß√£o de gastos
                const despesaTotal = transacoes
                    .filter(t => t.tipo === 'despesa')
                    .reduce((sum, t) => sum + t.valor, 0);

                if (despesaTotal > 0) {
                    const reducao5 = despesaTotal * 0.05;
                    metas.push(`üí° Tente reduzir 5% dos gastos mensais: ${formatBRL(reducao5 / 12)}.`);
                }

                // Meta de aumento de receita
                const receitaTotal = transacoes
                    .filter(t => t.tipo === 'receita')
                    .reduce((sum, t) => sum + t.valor, 0);

                if (receitaTotal > 0) {
                    const aumento10 = receitaTotal * 0.1;
                    metas.push(`üìà Busque aumentar sua receita em 10%: ${formatBRL(aumento10 / 12)} por m√™s.`);
                }

                // Meta de investimento
                if (economiaMensal > 1000) {
                    const investimento = economiaMensal * 0.7;
                    metas.push(`üí∞ Considere investir ${formatBRL(investimento)} mensais para fazer o dinheiro crescer.`);
                }

                container.innerHTML = metas.map(meta =>
                    `<div class="p-3 bg-purple-50 rounded-lg border-l-4 border-purple-400">${meta}</div>`
                ).join('');

            } catch (error) {
                console.error('Erro nas metas sugeridas:', error);
                container.innerHTML = '<p class="text-red-500">Erro ao gerar metas</p>';
            }
        }

        // ==================== GR√ÅFICOS CORRIGIDOS ====================

        /**
         * Inicializa todos os gr√°ficos
         */
        function initCharts() {
            try {
                initEvolucaoChart();
                initCategoriaChart();
                initProjecaoChart();
                initTendenciaMensalChart();
            } catch (error) {
                console.error('Erro ao inicializar gr√°ficos:', error);
            }
        }

        /**
         * Inicializa gr√°fico de evolu√ß√£o mensal
         */
        function initEvolucaoChart() {
            const ctx = document.getElementById('evolucaoChart');
            if (!ctx) return;

            try {
                evolucaoChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                            'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                        datasets: [{
                            label: 'Receitas',
                            data: Array(12).fill(0),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Despesas',
                            data: Array(12).fill(0),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.dataset.label + ': ' + formatBRL(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return formatBRL(value);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro no gr√°fico de evolu√ß√£o:', error);
            }
        }

        /**
         * Inicializa gr√°fico de categorias
         */
        function initCategoriaChart() {
            const ctx = document.getElementById('categoriaChart');
            if (!ctx) return;

            try {
                categoriaChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#3b82f6', '#ef4444', '#10b981', '#f59e0b',
                                '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16',
                                '#f97316', '#6366f1', '#14b8a6', '#f43f5e'
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.label || '';
                                        const value = formatBRL(context.parsed);
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro no gr√°fico de categorias:', error);
            }
        }

        /**
         * Inicializa gr√°fico de proje√ß√£o
         */
        function initProjecaoChart() {
            const ctx = document.getElementById('projecaoChart');
            if (!ctx) return;

            try {
                projecaoChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                            'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                        datasets: [{
                            label: 'Economia Acumulada',
                            data: Array(12).fill(0),
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return 'Economia: ' + formatBRL(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return formatBRL(value);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro no gr√°fico de proje√ß√£o:', error);
            }
        }

        /**
         * Inicializa gr√°fico de tend√™ncia mensal para insights
         */
        function initTendenciaMensalChart() {
            const ctx = document.getElementById('tendenciaMensalChart');
            if (!ctx) return;

            try {
                tendenciaMensalChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Receitas',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Despesas',
                            data: [],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Tend√™ncia dos √öltimos 6 Meses'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return formatBRL(value);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro no gr√°fico de tend√™ncia mensal:', error);
            }
        }

        /**
         * Atualiza dados dos gr√°ficos
         */
        function updateCharts() {
            try {
                updateEvolucaoChart();
                updateCategoriaChart();
                updateProjecaoChart();
                updateTendenciaMensalChart();
            } catch (error) {
                console.error('Erro ao atualizar gr√°ficos:', error);
            }
        }

        /**
         * Atualiza gr√°fico de evolu√ß√£o
         */
        function updateEvolucaoChart() {
            if (!evolucaoChart) return;

            try {
                const receitasMeses = Array(12).fill(0);
                const despesasMeses = Array(12).fill(0);

                transacoes.forEach(transacao => {
                    if (transacao.data && transacao.valor) {
                        const data = new Date(transacao.data + 'T00:00:00');
                        const mes = data.getMonth();

                        if (mes >= 0 && mes < 12) {
                            if (transacao.tipo === 'receita') {
                                receitasMeses[mes] += transacao.valor;
                            } else {
                                despesasMeses[mes] += transacao.valor;
                            }
                        }
                    }
                });

                evolucaoChart.data.datasets[0].data = receitasMeses;
                evolucaoChart.data.datasets[1].data = despesasMeses;
                evolucaoChart.update('none');
            } catch (error) {
                console.error('Erro ao atualizar gr√°fico de evolu√ß√£o:', error);
            }
        }

        /**
         * Atualiza gr√°fico de categorias
         */
        function updateCategoriaChart() {
            if (!categoriaChart) return;

            try {
                const categorias = {};

                transacoes
                    .filter(t => t.tipo === 'despesa' && t.categoria && t.valor)
                    .forEach(transacao => {
                        categorias[transacao.categoria] = (categorias[transacao.categoria] || 0) + transacao.valor;
                    });

                categoriaChart.data.labels = Object.keys(categorias);
                categoriaChart.data.datasets[0].data = Object.values(categorias);
                categoriaChart.update('none');
            } catch (error) {
                console.error('Erro ao atualizar gr√°fico de categorias:', error);
            }
        }

        /**
         * Atualiza gr√°fico de proje√ß√£o
         */
        function updateProjecaoChart() {
            if (!projecaoChart) return;

            try {
                const agora = new Date();
                const receitaTotal = transacoes
                    .filter(t => t.tipo === 'receita' && t.data && new Date(t.data).getFullYear() === agora.getFullYear())
                    .reduce((sum, t) => sum + (t.valor || 0), 0);

                const despesaTotal = transacoes
                    .filter(t => t.tipo === 'despesa' && t.data && new Date(t.data).getFullYear() === agora.getFullYear())
                    .reduce((sum, t) => sum + (t.valor || 0), 0);

                const mesesDecorridos = agora.getMonth() + 1;
                const economiaMensalMedia = mesesDecorridos > 0 ?
                    (receitaTotal - despesaTotal) / mesesDecorridos : 0;

                const projecaoMensal = Array(12).fill().map((_, i) =>
                    economiaMensalMedia * (i + 1)
                );

                projecaoChart.data.datasets[0].data = projecaoMensal;
                projecaoChart.update('none');
            } catch (error) {
                console.error('Erro ao atualizar gr√°fico de proje√ß√£o:', error);
            }
        }

        /**
         * Atualiza gr√°fico de tend√™ncia mensal
         */
        function updateTendenciaMensalChart() {
            if (!tendenciaMensalChart) return;

            try {
                const ultimosSeisMeses = obterUltimosSeisMeses();
                const dadosReceitas = ultimosSeisMeses.map(mes =>
                    transacoes.filter(r => r.tipo === 'receita' && r.data && r.data.startsWith(mes))
                        .reduce((sum, r) => sum + (r.valor || 0), 0)
                );
                const dadosDespesas = ultimosSeisMeses.map(mes =>
                    transacoes.filter(d => d.tipo === 'despesa' && d.data && d.data.startsWith(mes))
                        .reduce((sum, d) => sum + (d.valor || 0), 0)
                );

                tendenciaMensalChart.data.labels = ultimosSeisMeses.map(mes => formatarMesAbrev(mes));
                tendenciaMensalChart.data.datasets[0].data = dadosReceitas;
                tendenciaMensalChart.data.datasets[1].data = dadosDespesas;
                tendenciaMensalChart.update('none');
            } catch (error) {
                console.error('Erro ao atualizar gr√°fico de tend√™ncia mensal:', error);
            }
        }

        // ==================== FORM HANDLERS CORRIGIDOS ====================

        /**
         * Handler do formul√°rio de receitas com valida√ß√£o aprimorada
         * @param {Event} event - Evento do formul√°rio
         */
        async function handleReceitaForm(event) {
            event.preventDefault();

            const form = event.target;
            const submitBtn = document.getElementById('receitaSubmitBtn');

            try {
                submitBtn.classList.add('loading');
                submitBtn.innerHTML = '<div class="spinner"></div>Salvando...';

                // Validar formul√°rio
                const data = validateForm(form, 'receita');
                if (!data) return;

                await addTransaction(data);

                // Reset form and clear errors
                form.reset();
                form.querySelectorAll('.input-error').forEach(input => {
                    input.classList.remove('input-error', 'input-success');
                    hideFieldError(input);
                });
                setToday();

            } catch (error) {
                console.error('Erro ao salvar receita:', error);
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Adicionar Receita';
            }
        }

        /**
         * Handler do formul√°rio de despesas com valida√ß√£o aprimorada
         * @param {Event} event - Evento do formul√°rio
         */
        async function handleDespesaForm(event) {
            event.preventDefault();

            const form = event.target;
            const submitBtn = document.getElementById('despesaSubmitBtn');

            try {
                submitBtn.classList.add('loading');
                submitBtn.innerHTML = '<div class="spinner"></div>Salvando...';

                // Validar formul√°rio
                const data = validateForm(form, 'despesa');
                if (!data) return;

                await addTransaction(data);

                // Reset form and clear errors
                form.reset();
                form.querySelectorAll('.input-error').forEach(input => {
                    input.classList.remove('input-error', 'input-success');
                    hideFieldError(input);
                });
                setToday();

            } catch (error) {
                console.error('Erro ao salvar despesa:', error);
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Adicionar Despesa';
            }
        }

        /**
         * Handler do formul√°rio de patrim√¥nio com valida√ß√£o aprimorada
         * @param {Event} event - Evento do formul√°rio
         */
        async function handlePatrimonioForm(event) {
            event.preventDefault();

            const form = event.target;
            const submitBtn = document.getElementById('patrimonioSubmitBtn');

            try {
                submitBtn.classList.add('loading');
                submitBtn.innerHTML = '<div class="spinner"></div>Salvando...';

                // Validar formul√°rio
                const data = validateForm(form, 'patrimonio');
                if (!data) return;

                await addPatrimony(data);

                // Reset form and clear errors
                form.reset();
                form.querySelectorAll('.input-error').forEach(input => {
                    input.classList.remove('input-error', 'input-success');
                });

            } catch (error) {
                console.error('Erro ao salvar patrim√¥nio:', error);
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Adicionar Item';
            }
        }

        // ==================== MODAL FUNCTIONS ====================

        let currentEditId = null;
        let currentEditCollection = null;

        /**
         * Abre modal de confirma√ß√£o
         * @param {string} title - T√≠tulo do modal
         * @param {string} message - Mensagem do modal
         * @param {Function} callback - Fun√ß√£o a executar se confirmado
         * @param {string} type - Tipo do modal (danger, warning, info)
         */
        function openConfirmModal(title, message, callback, type = 'danger') {
            const modal = document.getElementById('confirmModal');
            const icon = document.getElementById('confirmIcon');
            const titleEl = document.getElementById('confirmTitle');
            const messageEl = document.getElementById('confirmMessage');
            const confirmBtn = document.getElementById('confirmButton');

            const icons = {
                danger: 'fas fa-exclamation-triangle text-red-500',
                warning: 'fas fa-exclamation-triangle text-yellow-500',
                info: 'fas fa-info-circle text-blue-500'
            };

            const btnColors = {
                danger: 'bg-red-500 hover:bg-red-600',
                warning: 'bg-yellow-500 hover:bg-yellow-600',
                info: 'bg-blue-500 hover:bg-blue-600'
            };

            icon.className = icons[type] || icons.danger;
            titleEl.textContent = title;
            messageEl.textContent = message;
            confirmBtn.className = `flex-1 px-4 py-2 text-white rounded-lg transition-colors ${btnColors[type]}`;

            confirmBtn.onclick = () => {
                closeConfirmModal();
                callback();
            };

            modal.classList.remove('hidden');
        }

        /**
         * Fecha modal de confirma√ß√£o
         */
        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        /**
         * Abre modal de edi√ß√£o para transa√ß√£o com valida√ß√£o
         * @param {string} id - ID da transa√ß√£o
         */
        function editTransaction(id) {
            const transacao = transacoes.find(t => t.id === id);
            if (!transacao) {
                showToast('Erro', 'Transa√ß√£o n√£o encontrada', 'error');
                return;
            }

            try {
                currentEditId = id;
                currentEditCollection = 'transacoes';

                const modal = document.getElementById('editModal');
                const form = document.getElementById('editForm');
                const title = document.getElementById('editTitle');

                title.textContent = `Editar ${transacao.tipo === 'receita' ? 'Receita' : 'Despesa'}`;

                // Preenche campos com sanitiza√ß√£o
                document.getElementById('editDescricao').value = sanitizeString(transacao.descricao);
                document.getElementById('editValor').value = transacao.valor.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).replace('.', ',');
                document.getElementById('editData').value = transacao.data;

                // Preenche categorias
                const categoriaSelect = document.getElementById('editCategoria');
                categoriaSelect.innerHTML = '';

                const categorias = transacao.tipo === 'receita' ?
                    ['Sal√°rio', 'Freelancer', 'Investimentos', 'Vendas', 'Aluguel', 'Bonus', 'Outros'] :
                    ['Habita√ß√£o', 'Alimenta√ß√£o', 'Transporte', 'Lazer', 'Sa√∫de', 'Educa√ß√£o', 'Roupas', 'Tecnologia', 'Contas', 'Outros'];

                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    option.selected = cat === transacao.categoria;
                    categoriaSelect.appendChild(option);
                });

                // Mostra campo de data
                document.getElementById('editDataContainer').style.display = 'block';

                // Handler do formul√°rio
                form.onsubmit = handleEditSubmit;

                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao abrir edi√ß√£o:', error);
                showToast('Erro', 'Erro ao abrir formul√°rio de edi√ß√£o', 'error');
            }
        }

        /**
         * Abre modal de edi√ß√£o para patrim√¥nio
         * @param {string} id - ID do patrim√¥nio
         */
        function editPatrimonio(id) {
            const item = patrimonio.find(p => p.id === id);
            if (!item) {
                showToast('Erro', 'Item n√£o encontrado', 'error');
                return;
            }

            try {
                currentEditId = id;
                currentEditCollection = 'patrimonio';

                const modal = document.getElementById('editModal');
                const form = document.getElementById('editForm');
                const title = document.getElementById('editTitle');

                title.textContent = `Editar ${item.tipo === 'bem' ? 'Bem' : 'D√≠vida'}`;

                // Preenche campos
                document.getElementById('editDescricao').value = sanitizeString(item.descricao);
                document.getElementById('editValor').value = item.valor.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).replace('.', ',');

                // Preenche categorias
                const categoriaSelect = document.getElementById('editCategoria');
                categoriaSelect.innerHTML = '';

                const categorias = ['Im√≥veis', 'Ve√≠culos', 'Investimentos', 'Conta Corrente', 'Poupan√ßa',
                    'Cart√£o de Cr√©dito', 'Financiamentos', 'Empr√©stimos', 'Outros'];

                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    option.selected = cat === item.categoria;
                    categoriaSelect.appendChild(option);
                });

                // Esconde campo de data
                document.getElementById('editDataContainer').style.display = 'none';

                // Handler do formul√°rio
                form.onsubmit = handleEditSubmit;

                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao abrir edi√ß√£o:', error);
                showToast('Erro', 'Erro ao abrir formul√°rio de edi√ß√£o', 'error');
            }
        }

        /**
         * Handler do formul√°rio de edi√ß√£o
         * @param {Event} event - Evento do formul√°rio
         */
        async function handleEditSubmit(event) {
            event.preventDefault();

            const form = event.target;

            try {
                // Valida√ß√£o b√°sica
                const descricao = form.querySelector('#editDescricao').value.trim();
                const valorStr = form.querySelector('#editValor').value.trim();
                const categoria = form.querySelector('#editCategoria').value;

                if (!descricao || !valorStr || !categoria) {
                    showToast('Erro', 'Todos os campos s√£o obrigat√≥rios', 'error');
                    return;
                }

                const valor = parseBRL(valorStr);
                if (valor <= 0) {
                    showToast('Erro', 'Valor deve ser maior que zero', 'error');
                    return;
                }

                const data = {
                    descricao: descricao,
                    valor: valor,
                    categoria: categoria
                };

                // Adiciona data se for transa√ß√£o
                if (currentEditCollection === 'transacoes') {
                    const dataValue = form.querySelector('#editData').value;
                    if (!isValidDate(dataValue)) {
                        showToast('Erro', 'Data inv√°lida', 'error');
                        return;
                    }
                    data.data = dataValue + 'T00:00:00';
                }

                await updateItem(currentEditCollection, currentEditId, data);
                closeEditModal();

            } catch (error) {
                console.error('Erro ao atualizar:', error);
            }
        }

        /**
         * Fecha modal de edi√ß√£o
         */
        function closeEditModal() {
            const modal = document.getElementById('editModal');
            if (modal) {
                modal.classList.add('hidden');
            }
            currentEditId = null;
            currentEditCollection = null;
        }

        // ==================== DELETE FUNCTIONS ====================

        /**
         * Confirma exclus√£o de transa√ß√£o
         * @param {string} id - ID da transa√ß√£o
         */
        function deleteTransactionConfirm(id) {
            const transacao = transacoes.find(t => t.id === id);
            if (!transacao) {
                showToast('Erro', 'Transa√ß√£o n√£o encontrada', 'error');
                return;
            }

            openConfirmModal(
                'Confirmar Exclus√£o',
                `Deseja realmente excluir a ${transacao.tipo} "${sanitizeString(transacao.descricao)}" no valor de ${formatBRL(transacao.valor)}?`,
                () => deleteItem('transacoes', id),
                'danger'
            );
        }

        /**
         * Confirma exclus√£o de patrim√¥nio
         * @param {string} id - ID do patrim√¥nio
         */
        function deletePatrimonioConfirm(id) {
            const item = patrimonio.find(p => p.id === id);
            if (!item) {
                showToast('Erro', 'Item n√£o encontrado', 'error');
                return;
            }

            openConfirmModal(
                'Confirmar Exclus√£o',
                `Deseja realmente excluir o ${item.tipo} "${sanitizeString(item.descricao)}" no valor de ${formatBRL(item.valor)}?`,
                () => deleteItem('patrimonio', id),
                'danger'
            );
        }

        // ==================== TAB NAVIGATION ====================

        /**
         * Mostra tab espec√≠fica
         * @param {string} tabName - Nome da tab
         */
        function showTab(tabName) {
            try {
                // Esconde todas as tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.add('hidden');
                });

                // Remove classe ativa de todos os bot√µes
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.className = 'tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap hover:bg-gray-200 transition-colors';
                });

                // Mostra tab selecionada
                const selectedTab = document.getElementById(tabName);
                if (selectedTab) {
                    selectedTab.classList.remove('hidden');
                    selectedTab.classList.add('fade-in');
                }

                // Ativa bot√£o da tab
                const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
                if (selectedBtn) {
                    selectedBtn.className = 'tab-btn px-4 py-2 rounded-lg text-sm font-medium gradient-info text-white whitespace-nowrap';
                }

                // Inicializa funcionalidades espec√≠ficas das tabs
                switch (tabName) {
                    case 'relatorios':
                        inicializarRelatorios();
                        break;
                    case 'insights':
                        inicializarInsights();
                        break;
                }

                // Salva tab atual
                localStorage.setItem('currentTab', tabName);
            } catch (error) {
                console.error('Erro ao navegar entre tabs:', error);
            }
        }

        // ==================== RELAT√ìRIOS DETALHADOS - CORRIGIDOS ====================

        /**
         * Inicializar relat√≥rios ao carregar a aba
         */
        function inicializarRelatorios() {
            try {
                // Inicializar filtros de ano
                const anoSelect = document.getElementById('filtroAno');
                if (anoSelect) {
                    anoSelect.innerHTML = '<option value="">Todos</option>';
                    const currentYear = new Date().getFullYear();
                    for (let year = currentYear; year >= currentYear - 5; year--) {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        anoSelect.appendChild(option);
                    }
                }

                // Sincronizar com filtros do dashboard
                const monthSelect = document.getElementById('dashboardMonth');
                const yearSelect = document.getElementById('dashboardYear');
                const relatorioMes = document.getElementById('filtroMes');
                const relatorioAno = document.getElementById('filtroAno');
                
                if (monthSelect && yearSelect && relatorioMes && relatorioAno) {
                    relatorioMes.value = monthSelect.value;
                    relatorioAno.value = yearSelect.value;
                }

                // Carregar categorias no filtro
                carregarCategoriasFiltro();

                // Aplicar filtros iniciais
                aplicarFiltros();
            } catch (error) {
                console.error('Erro ao inicializar relat√≥rios:', error);
            }
        }

        /**
         * Carregar categorias para o filtro
         */
        function carregarCategoriasFiltro() {
            try {
                const categorias = new Set();
                transacoes.forEach(t => {
                    if (t.categoria) {
                        categorias.add(t.categoria);
                    }
                });

                const select = document.getElementById('filtroCategoria');
                if (select) {
                    select.innerHTML = '<option value="">Todas</option>';

                    [...categorias].sort().forEach(categoria => {
                        const option = document.createElement('option');
                        option.value = categoria;
                        option.textContent = categoria;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        /**
         * Aplicar filtros
         */
        function aplicarFiltros() {
            try {
                const mesSelect = document.getElementById('filtroMes');
                const anoSelect = document.getElementById('filtroAno');
                const dataInicio = document.getElementById('filtroDataInicio').value;
                const dataFim = document.getElementById('filtroDataFim').value;
                const tipo = document.getElementById('filtroTipo').value;
                const categoria = document.getElementById('filtroCategoria').value;

                // Obter valores de m√™s e ano
                const mesFiltro = mesSelect && mesSelect.value !== '' ? parseInt(mesSelect.value) : null;
                const anoFiltro = anoSelect && anoSelect.value !== '' ? parseInt(anoSelect.value) : null;

                // Aplicar filtros
                transacoesFiltradas = transacoes.filter(transacao => {
                    if (!transacao.data) return false;

                    const dataTransacao = new Date(transacao.data + 'T00:00:00');
                    const filtroDataInicioDate = dataInicio ? new Date(dataInicio + 'T00:00:00') : null;
                    const filtroDataFimDate = dataFim ? new Date(dataFim + 'T00:00:00') : null;

                    // Filtro por m√™s e ano (prioridade sobre datas espec√≠ficas)
                    if (mesFiltro !== null || anoFiltro !== null) {
                        let mesMatch = true;
                        let anoMatch = true;

                        if (mesFiltro !== null) {
                            mesMatch = dataTransacao.getMonth() === mesFiltro;
                        }

                        if (anoFiltro !== null) {
                            anoMatch = dataTransacao.getFullYear() === anoFiltro;
                        }

                        if (!mesMatch || !anoMatch) return false;
                    } else {
                        // Filtro por data espec√≠fica (apenas se m√™s/ano n√£o estiverem definidos)
                        if (filtroDataInicioDate && dataTransacao < filtroDataInicioDate) return false;
                        if (filtroDataFimDate && dataTransacao > filtroDataFimDate) return false;
                    }

                    // Filtro por tipo
                    if (tipo && transacao.tipo !== tipo) return false;

                    // Filtro por categoria
                    if (categoria && transacao.categoria !== categoria) return false;

                    return true;
                });

                // Aplicar ordena√ß√£o atual
                ordenarTransacoes();

                // Atualizar resumo e tabela
                atualizarResumoFiltros();
                atualizarTabelaRelatorios();
            } catch (error) {
                console.error('Erro ao aplicar filtros:', error);
            }
        }

        /**
         * Ordenar transa√ß√µes
         */
        function ordenarTransacoes() {
            try {
                transacoesFiltradas.sort((a, b) => {
                    let valorA = a[ordenacaoAtual.campo];
                    let valorB = b[ordenacaoAtual.campo];

                    if (ordenacaoAtual.campo === 'valor') {
                        valorA = parseFloat(valorA) || 0;
                        valorB = parseFloat(valorB) || 0;
                    } else if (ordenacaoAtual.campo === 'data') {
                        valorA = new Date(valorA);
                        valorB = new Date(valorB);
                    }

                    if (ordenacaoAtual.direcao === 'asc') {
                        return valorA > valorB ? 1 : -1;
                    } else {
                        return valorA < valorB ? 1 : -1;
                    }
                });
            } catch (error) {
                console.error('Erro ao ordenar transa√ß√µes:', error);
            }
        }

        /**
         * Alterar ordena√ß√£o
         * @param {string} campo - Campo para ordenar
         */
        function alterarOrdenacao(campo) {
            try {
                if (ordenacaoAtual.campo === campo) {
                    ordenacaoAtual.direcao = ordenacaoAtual.direcao === 'asc' ? 'desc' : 'asc';
                } else {
                    ordenacaoAtual.campo = campo;
                    ordenacaoAtual.direcao = 'desc';
                }

                ordenarTransacoes();
                atualizarTabelaRelatorios();
            } catch (error) {
                console.error('Erro ao alterar ordena√ß√£o:', error);
            }
        }

        /**
         * Atualizar resumo dos filtros
         */
        function atualizarResumoFiltros() {
            try {
                const totalReceitas = transacoesFiltradas
                    .filter(t => t.tipo === 'receita')
                    .reduce((sum, t) => sum + (t.valor || 0), 0);

                const totalDespesas = transacoesFiltradas
                    .filter(t => t.tipo === 'despesa')
                    .reduce((sum, t) => sum + (t.valor || 0), 0);

                const saldo = totalReceitas - totalDespesas;

                document.getElementById('filtroTotalRegistros').textContent = transacoesFiltradas.length;
                document.getElementById('filtroTotalReceitas').textContent = formatBRL(totalReceitas);
                document.getElementById('filtroTotalDespesas').textContent = formatBRL(totalDespesas);

                const saldoElement = document.getElementById('filtroSaldoPeriodo');
                saldoElement.textContent = formatBRL(saldo);
                saldoElement.className = `text-3xl font-bold ${saldo >= 0 ? 'text-green-600' : 'text-red-600'}`;
            } catch (error) {
                console.error('Erro ao atualizar resumo:', error);
            }
        }

        /**
         * Atualizar tabela de relat√≥rios
         */
        function atualizarTabelaRelatorios() {
            try {
                const tbody = document.getElementById('relatoriosTableBody');
                if (!tbody) return;

                tbody.innerHTML = '';

                if (transacoesFiltradas.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-8 text-gray-500">
                                <i class="fas fa-search text-3xl mb-2"></i>
                                <p>Nenhuma transa√ß√£o encontrada com os filtros aplicados</p>
                            </td>
                        </tr>`;
                    return;
                }

                transacoesFiltradas.forEach(transacao => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100 hover:bg-gray-50';

                    const tipoIcon = transacao.tipo === 'receita' ?
                        '<i class="fas fa-arrow-up text-green-500"></i>' :
                        '<i class="fas fa-arrow-down text-red-500"></i>';

                    const valorClass = transacao.tipo === 'receita' ? 'text-green-600' : 'text-red-600';
                    const valorPrefix = transacao.tipo === 'receita' ? '+' : '-';

                    const data = new Date(transacao.data + 'T00:00:00').toLocaleDateString('pt-BR');

                    row.innerHTML = `
                        <td class="py-3 px-4">
                            <div class="flex items-center space-x-2">
                                ${tipoIcon}
                                <span class="text-xs ${transacao.tipo === 'receita' ? 'text-green-600' : 'text-red-600'} font-medium">
                                    ${transacao.tipo.toUpperCase()}
                                </span>
                            </div>
                        </td>
                        <td class="py-3 px-4">${data}</td>
                        <td class="py-3 px-4">
                            <div>
                                <p class="font-medium">${sanitizeString(transacao.descricao)}</p>
                                <p class="text-xs text-gray-500">${sanitizeString(transacao.categoria)}</p>
                            </div>
                        </td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700">
                                ${sanitizeString(transacao.categoria)}
                            </span>
                        </td>
                        <td class="py-3 px-4 text-right">
                            <span class="font-bold ${valorClass}">
                                ${valorPrefix} ${formatBRL(transacao.valor)}
                            </span>
                        </td>
                        <td class="py-3 px-4 text-center no-print">
                            <button onclick="editTransaction('${transacao.id}')" 
                                    class="text-blue-500 hover:text-blue-700 mr-2" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTransactionConfirm('${transacao.id}')" 
                                    class="text-red-500 hover:text-red-700" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;

                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Erro ao atualizar tabela:', error);
            }
        }

        /**
         * Limpar filtros
         */
        function limparFiltros() {
            try {
                document.getElementById('filtroMes').value = '';
                document.getElementById('filtroAno').value = '';
                document.getElementById('filtroDataInicio').value = '';
                document.getElementById('filtroDataFim').value = '';
                document.getElementById('filtroTipo').value = '';
                document.getElementById('filtroCategoria').value = '';

                // Sincronizar com dashboard
                const monthSelect = document.getElementById('dashboardMonth');
                const yearSelect = document.getElementById('dashboardYear');
                if (monthSelect && yearSelect) {
                    monthSelect.value = '';
                    yearSelect.value = '';
                    filtroMesAtual = null;
                    filtroAnoAtual = null;
                    updateDashboard();
                    updateCharts();
                    updateInsights();
                }

                aplicarFiltros();
            } catch (error) {
                console.error('Erro ao limpar filtros:', error);
            }
        }

        /**
         * Exportar para CSV
         */
        function exportarCSV() {
            try {
                if (transacoesFiltradas.length === 0) {
                    showToast('Aviso', 'Nenhuma transa√ß√£o para exportar', 'warning');
                    return;
                }

                const headers = ['Tipo', 'Data', 'Descri√ß√£o', 'Categoria', 'Valor'];
                const csvContent = [
                    headers.join(','),
                    ...transacoesFiltradas.map(t => [
                        t.tipo,
                        t.data,
                        `"${t.descricao}"`,
                        `"${t.categoria}"`,
                        t.valor.toString().replace('.', ',')
                    ].join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');

                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `relatorio-financeiro-${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    showToast('Sucesso', 'Relat√≥rio exportado com sucesso!', 'success');
                }
            } catch (error) {
                console.error('Erro ao exportar CSV:', error);
                showToast('Erro', 'Erro ao exportar relat√≥rio', 'error');
            }
        }

        // ==================== INSIGHTS DETALHADOS - CORRIGIDOS ====================

        /**
         * Inicializar insights ao carregar a aba
         */
        function inicializarInsights() {
            try {
                updateInsights();
            } catch (error) {
                console.error('Erro ao inicializar insights:', error);
            }
        }

        /**
         * Atualizar insights
         */
        function updateInsights() {
            try {
                if (transacoes.length === 0) {
                    document.getElementById('alertasContainer').innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-chart-line text-4xl mb-2"></i>
                            <p>Adicione algumas transa√ß√µes para ver insights personalizados!</p>
                        </div>`;
                    return;
                }

                // An√°lise trimestral
                analisarTendenciaTrimestral();

                // An√°lise de atividade mensal
                analisarAtividadeMensal();

                // An√°lise de categorias
                analisarCategorias();

                // Gerar alertas
                gerarAlertas();

                // Gerar previs√µes
                gerarPrevisoes();

                // Atualizar gr√°fico de tend√™ncia mensal
                updateTendenciaMensalChart();
            } catch (error) {
                console.error('Erro ao atualizar insights:', error);
            }
        }

        /**
         * Analisar tend√™ncia trimestral
         */
        function analisarTendenciaTrimestral() {
            try {
                const ultimosTresMeses = obterUltimosTresMeses();

                const dadosReceitas = ultimosTresMeses.map(mes =>
                    transacoes.filter(r => r.tipo === 'receita' && r.data && r.data.startsWith(mes))
                        .reduce((sum, r) => sum + (r.valor || 0), 0)
                );

                const dadosDespesas = ultimosTresMeses.map(mes =>
                    transacoes.filter(d => d.tipo === 'despesa' && d.data && d.data.startsWith(mes))
                        .reduce((sum, d) => sum + (d.valor || 0), 0)
                );

                const dadosEconomia = dadosReceitas.map((r, i) => r - dadosDespesas[i]);

                // Calcular tend√™ncias
                const tendenciaReceitas = calcularTendencia(dadosReceitas);
                const tendenciaDespesas = calcularTendencia(dadosDespesas);
                const tendenciaEconomia = calcularTendencia(dadosEconomia);

                // Atualizar elementos
                document.getElementById('tendenciaReceitasTrimestre').textContent = formatarTendencia(tendenciaReceitas);
                document.getElementById('tendenciaDespesasTrimestre').textContent = formatarTendencia(tendenciaDespesas);
                document.getElementById('tendenciaEconomiaTrimestre').textContent = formatarTendencia(tendenciaEconomia);

                // Aplicar classes de cor
                aplicarClasseTendencia('tendenciaReceitasTrimestre', tendenciaReceitas);
                aplicarClasseTendencia('tendenciaDespesasTrimestre', -tendenciaDespesas); // Inverte para despesas
                aplicarClasseTendencia('tendenciaEconomiaTrimestre', tendenciaEconomia);
            } catch (error) {
                console.error('Erro na an√°lise trimestral:', error);
            }
        }

        /**
         * Analisar atividade mensal
         */
        function analisarAtividadeMensal() {
            try {
                const atividadePorMes = {};
                const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

                transacoes.forEach(transacao => {
                    if (transacao.data) {
                        const data = new Date(transacao.data + 'T00:00:00');
                        const mesAno = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                        atividadePorMes[mesAno] = (atividadePorMes[mesAno] || 0) + Math.abs(transacao.valor || 0);
                    }
                });

                const atividades = Object.entries(atividadePorMes);
                if (atividades.length === 0) {
                    document.getElementById('mesMaiorAtividade').textContent = 'N/A';
                    document.getElementById('mesMenorAtividade').textContent = 'N/A';
                    return;
                }

                const maiorAtividade = atividades.reduce((max, current) =>
                    current[1] > max.valor ? { mes: current[0], valor: current[1] } : max,
                    { mes: '', valor: 0 }
                );

                const menorAtividade = atividades.reduce((min, current) =>
                    current[1] < min.valor ? { mes: current[0], valor: current[1] } : min,
                    { mes: '', valor: Infinity }
                );

                // Formatar nomes dos meses
                const formatarMesAno = (mesAno) => {
                    const [ano, mes] = mesAno.split('-');
                    return `${meses[parseInt(mes) - 1]}/${ano}`;
                };

                document.getElementById('mesMaiorAtividade').textContent =
                    `${formatarMesAno(maiorAtividade.mes)} (${formatBRL(maiorAtividade.valor)})`;
                document.getElementById('mesMenorAtividade').textContent =
                    menorAtividade.valor !== Infinity ?
                        `${formatarMesAno(menorAtividade.mes)} (${formatBRL(menorAtividade.valor)})` : 'N/A';
            } catch (error) {
                console.error('Erro na an√°lise de atividade:', error);
            }
        }

        /**
         * Analisar categorias
         */
        function analisarCategorias() {
            try {
                const despesas = transacoes.filter(t => t.tipo === 'despesa');
                if (despesas.length === 0) {
                    document.getElementById('categoriaMaiorGasto').textContent = 'N/A';
                    document.getElementById('categoriaMaiorGastoValor').textContent = 'R$ 0,00';
                    document.getElementById('categoriaMaiorGastoMedia').textContent = '--';
                    return;
                }

                const categoriaAnalise = {};

                despesas.forEach(despesa => {
                    if (!categoriaAnalise[despesa.categoria]) {
                        categoriaAnalise[despesa.categoria] = { total: 0, count: 0 };
                    }
                    categoriaAnalise[despesa.categoria].total += parseFloat(despesa.valor || 0);
                    categoriaAnalise[despesa.categoria].count++;
                });

                // Encontrar categoria com maior gasto
                let maiorCategoria = { nome: 'N/A', valor: 0, media: 0 };
                Object.entries(categoriaAnalise).forEach(([categoria, dados]) => {
                    if (dados.total > maiorCategoria.valor) {
                        maiorCategoria = {
                            nome: categoria,
                            valor: dados.total,
                            media: dados.total / dados.count
                        };
                    }
                });

                document.getElementById('categoriaMaiorGasto').textContent = maiorCategoria.nome;
                document.getElementById('categoriaMaiorGastoValor').textContent = formatBRL(maiorCategoria.valor);
                document.getElementById('categoriaMaiorGastoMedia').textContent =
                    `M√©dia: ${formatBRL(maiorCategoria.media)}`;
            } catch (error) {
                console.error('Erro na an√°lise de categorias:', error);
            }
        }

        /**
         * Gerar alertas
         */
        function gerarAlertas() {
            try {
                const alertas = [];
                const mesAtual = new Date().toISOString().slice(0, 7);

                // Receitas e despesas do m√™s atual
                const receitasMesAtual = transacoes
                    .filter(r => r.tipo === 'receita' && r.data && r.data.startsWith(mesAtual))
                    .reduce((sum, r) => sum + (r.valor || 0), 0);

                const despesasMesAtual = transacoes
                    .filter(d => d.tipo === 'despesa' && d.data && d.data.startsWith(mesAtual))
                    .reduce((sum, d) => sum + (d.valor || 0), 0);

                // Alerta: Gastos superiores √† receita
                if (despesasMesAtual > receitasMesAtual) {
                    alertas.push({
                        tipo: 'danger',
                        titulo: 'Gastos Excedem Receitas',
                        mensagem: `Suas despesas deste m√™s (${formatBRL(despesasMesAtual)}) s√£o maiores que suas receitas (${formatBRL(receitasMesAtual)}).`
                    });
                }

                // Alerta: Categoria com gasto alto
                const categoriasGasto = {};
                transacoes
                    .filter(d => d.tipo === 'despesa' && d.data && d.data.startsWith(mesAtual))
                    .forEach(d => {
                        categoriasGasto[d.categoria] = (categoriasGasto[d.categoria] || 0) + (d.valor || 0);
                    });

                const totalDespesasMes = Object.values(categoriasGasto).reduce((sum, val) => sum + val, 0);
                Object.entries(categoriasGasto).forEach(([categoria, valor]) => {
                    const percentual = totalDespesasMes > 0 ? (valor / totalDespesasMes) * 100 : 0;
                    if (percentual > 40) {
                        alertas.push({
                            tipo: 'warning',
                            titulo: 'Categoria com Gasto Alto',
                            mensagem: `A categoria "${categoria}" representa ${percentual.toFixed(1)}% dos seus gastos este m√™s.`
                        });
                    }
                });

                // Alerta: Meta de economia
                const metaEconomia = receitasMesAtual * 0.2; // 20% de economia
                const economiaAtual = receitasMesAtual - despesasMesAtual;

                if (receitasMesAtual > 0 && economiaAtual < metaEconomia) {
                    alertas.push({
                        tipo: 'info',
                        titulo: 'Meta de Economia',
                        mensagem: `Para economizar 20% da renda, voc√™ precisa reduzir ${formatBRL(metaEconomia - economiaAtual)} em gastos.`
                    });
                }

                exibirAlertas(alertas);
            } catch (error) {
                console.error('Erro ao gerar alertas:', error);
            }
        }

        /**
         * Exibir alertas
         * @param {Array} alertas - Lista de alertas
         */
        function exibirAlertas(alertas) {
            try {
                const container = document.getElementById('alertasContainer');
                if (!container) return;

                container.innerHTML = '';

                if (alertas.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-check-circle text-4xl text-green-500 mb-2"></i>
                            <p>Nenhum alerta no momento!</p>
                            <p class="text-sm">Sua situa√ß√£o financeira est√° equilibrada.</p>
                        </div>`;
                    return;
                }

                alertas.forEach(alerta => {
                    const cor = {
                        'danger': 'red',
                        'warning': 'yellow',
                        'info': 'blue'
                    }[alerta.tipo];

                    const icone = {
                        'danger': 'exclamation-triangle',
                        'warning': 'exclamation-circle',
                        'info': 'info-circle'
                    }[alerta.tipo];

                    const alertDiv = document.createElement('div');
                    alertDiv.className = `bg-${cor}-50 border border-${cor}-200 rounded-lg p-4 mb-4`;
                    alertDiv.innerHTML = `
                        <div class="flex items-start">
                            <i class="fas fa-${icone} text-${cor}-500 mt-1 mr-3"></i>
                            <div>
                                <h4 class="font-semibold text-${cor}-800">${alerta.titulo}</h4>
                                <p class="text-${cor}-700 text-sm mt-1">${alerta.mensagem}</p>
                            </div>
                        </div>
                    `;
                    container.appendChild(alertDiv);
                });
            } catch (error) {
                console.error('Erro ao exibir alertas:', error);
            }
        }

        /**
         * Gerar previs√µes
         */
        function gerarPrevisoes() {
            try {
                const mesAtual = new Date().toISOString().slice(0, 7);
                const diaAtual = new Date().getDate();
                const diasNoMes = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();

                // Receitas e despesas at√© agora no m√™s
                const receitasMesAtual = transacoes
                    .filter(r => r.tipo === 'receita' && r.data && r.data.startsWith(mesAtual))
                    .reduce((sum, r) => sum + (r.valor || 0), 0);

                const despesasMesAtual = transacoes
                    .filter(d => d.tipo === 'despesa' && d.data && d.data.startsWith(mesAtual))
                    .reduce((sum, d) => sum + (d.valor || 0), 0);

                // Proje√ß√£o simples baseada no ritmo atual
                const projecaoReceitas = diaAtual > 0 ? (receitasMesAtual / diaAtual) * diasNoMes : 0;
                const projecaoDespesas = diaAtual > 0 ? (despesasMesAtual / diaAtual) * diasNoMes : 0;
                const projecaoSaldo = projecaoReceitas - projecaoDespesas;

                document.getElementById('projecaoReceitasMes').textContent = formatBRL(projecaoReceitas);
                document.getElementById('projecaoDespesasMes').textContent = formatBRL(projecaoDespesas);

                const saldoElement = document.getElementById('projecaoSaldoMes');
                saldoElement.textContent = formatBRL(projecaoSaldo);
                saldoElement.className = `font-bold ${projecaoSaldo >= 0 ? 'text-green-600' : 'text-red-600'}`;
            } catch (error) {
                console.error('Erro ao gerar previs√µes:', error);
            }
        }

        // ==================== FUN√á√ïES AUXILIARES ====================

        /**
         * Obter √∫ltimos tr√™s meses
         * @returns {Array} - Array com strings de meses no formato YYYY-MM
         */
        function obterUltimosTresMeses() {
            const meses = [];
            const hoje = new Date();
            for (let i = 2; i >= 0; i--) {
                const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                meses.push(data.toISOString().slice(0, 7));
            }
            return meses;
        }

        /**
         * Obter √∫ltimos seis meses
         * @returns {Array} - Array com strings de meses no formato YYYY-MM
         */
        function obterUltimosSeisMeses() {
            const meses = [];
            const hoje = new Date();
            for (let i = 5; i >= 0; i--) {
                const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                meses.push(data.toISOString().slice(0, 7));
            }
            return meses;
        }

        /**
         * Calcular tend√™ncia de uma s√©rie de valores
         * @param {Array} valores - Array de valores num√©ricos
         * @returns {number} - Percentual de tend√™ncia
         */
        function calcularTendencia(valores) {
            if (valores.length < 2) return 0;

            const primeiro = valores[0] || 0;
            const ultimo = valores[valores.length - 1] || 0;

            if (primeiro === 0) return ultimo > 0 ? 100 : 0;

            return ((ultimo - primeiro) / primeiro) * 100;
        }

        /**
         * Formatar tend√™ncia como string
         * @param {number} tendencia - Valor da tend√™ncia
         * @returns {string} - Tend√™ncia formatada
         */
        function formatarTendencia(tendencia) {
            const abs = Math.abs(tendencia);
            const sinal = tendencia >= 0 ? '+' : '-';
            return `${sinal}${abs.toFixed(1)}%`;
        }

        /**
         * Aplicar classe de cor baseada na tend√™ncia
         * @param {string} elementId - ID do elemento
         * @param {number} tendencia - Valor da tend√™ncia
         */
        function aplicarClasseTendencia(elementId, tendencia) {
            const elemento = document.getElementById(elementId);
            if (!elemento) return;

            if (tendencia > 0) {
                elemento.className = 'text-green-600 font-semibold';
            } else if (tendencia < 0) {
                elemento.className = 'text-red-600 font-semibold';
            } else {
                elemento.className = 'text-gray-600 font-semibold';
            }
        }

        /**
         * Formatar m√™s abreviado
         * @param {string} mes - M√™s no formato YYYY-MM
         * @returns {string} - M√™s formatado
         */
        function formatarMesAbrev(mes) {
            const [ano, mesNum] = mes.split('-');
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            return `${meses[parseInt(mesNum) - 1]}/${ano.slice(2)}`;
        }

        // ==================== FUNCIONALIDADES DE AN√ÅLISE COMPARATIVA ====================

        /**
         * Atualizar an√°lise comparativa
         */
        function atualizarComparativo() {
            try {
                const tipo = document.getElementById('comparativoTipo').value;
                
                // Mostrar/ocultar campos personalizados
                const personalizado = document.getElementById('comparativoPersonalizado');
                if (tipo === 'personalizado') {
                    personalizado.classList.remove('hidden');
                } else {
                    personalizado.classList.add('hidden');
                }
                
                const dadosComparativo = calcularDadosComparativos(tipo);
                
                atualizarResumoComparativo(dadosComparativo);
                renderizarGraficoComparativo(dadosComparativo);
                renderizarVariacoes(dadosComparativo);
                renderizarInsightsComparativos(dadosComparativo);
                
            } catch (error) {
                console.error('Erro ao atualizar an√°lise comparativa:', error);
            }
        }

        /**
         * Calcular dados comparativos
         */
        function calcularDadosComparativos(tipo) {
            try {
                let periodo1, periodo2, labelPeriodo1, labelPeriodo2;
                const hoje = new Date();
                
                switch (tipo) {
                    case 'mensal':
                        // M√™s atual vs anterior
                        periodo1 = {
                            inicio: new Date(hoje.getFullYear(), hoje.getMonth(), 1),
                            fim: new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0)
                        };
                        periodo2 = {
                            inicio: new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1),
                            fim: new Date(hoje.getFullYear(), hoje.getMonth(), 0)
                        };
                        labelPeriodo1 = 'M√™s Atual';
                        labelPeriodo2 = 'M√™s Anterior';
                        break;
                        
                    case 'trimestral':
                        // Trimestre atual vs anterior
                        const trimestreAtual = Math.floor(hoje.getMonth() / 3);
                        periodo1 = {
                            inicio: new Date(hoje.getFullYear(), trimestreAtual * 3, 1),
                            fim: new Date(hoje.getFullYear(), (trimestreAtual + 1) * 3, 0)
                        };
                        periodo2 = {
                            inicio: new Date(hoje.getFullYear(), (trimestreAtual - 1) * 3, 1),
                            fim: new Date(hoje.getFullYear(), trimestreAtual * 3, 0)
                        };
                        labelPeriodo1 = 'Trimestre Atual';
                        labelPeriodo2 = 'Trimestre Anterior';
                        break;
                        
                    case 'anual':
                        // Ano atual vs anterior
                        periodo1 = {
                            inicio: new Date(hoje.getFullYear(), 0, 1),
                            fim: new Date(hoje.getFullYear(), 11, 31)
                        };
                        periodo2 = {
                            inicio: new Date(hoje.getFullYear() - 1, 0, 1),
                            fim: new Date(hoje.getFullYear() - 1, 11, 31)
                        };
                        labelPeriodo1 = 'Ano Atual';
                        labelPeriodo2 = 'Ano Anterior';
                        break;
                        
                    case 'personalizado':
                        const p1Inicio = document.getElementById('comparativoPeriodo1Inicio').value;
                        const p1Fim = document.getElementById('comparativoPeriodo1Fim').value;
                        const p2Inicio = document.getElementById('comparativoPeriodo2Inicio').value;
                        const p2Fim = document.getElementById('comparativoPeriodo2Fim').value;
                        
                        if (!p1Inicio || !p1Fim || !p2Inicio || !p2Fim) {
                            throw new Error('Preencha todas as datas para compara√ß√£o personalizada');
                        }
                        
                        periodo1 = {
                            inicio: new Date(p1Inicio + 'T00:00:00'),
                            fim: new Date(p1Fim + 'T23:59:59')
                        };
                        periodo2 = {
                            inicio: new Date(p2Inicio + 'T00:00:00'),
                            fim: new Date(p2Fim + 'T23:59:59')
                        };
                        labelPeriodo1 = 'Per√≠odo 1';
                        labelPeriodo2 = 'Per√≠odo 2';
                        break;
                        
                    default:
                        throw new Error('Tipo de compara√ß√£o inv√°lido');
                }
                
                // Filtrar transa√ß√µes por per√≠odo
                const transacoesPeriodo1 = transacoes.filter(t => {
                    const data = new Date(t.data + 'T00:00:00');
                    return data >= periodo1.inicio && data <= periodo1.fim;
                });
                
                const transacoesPeriodo2 = transacoes.filter(t => {
                    const data = new Date(t.data + 'T00:00:00');
                    return data >= periodo2.inicio && data <= periodo2.fim;
                });
                
                // Calcular totais
                const dadosPeriodo1 = calcularTotaisPeriodo(transacoesPeriodo1);
                const dadosPeriodo2 = calcularTotaisPeriodo(transacoesPeriodo2);
                
                return {
                    periodo1: dadosPeriodo1,
                    periodo2: dadosPeriodo2,
                    labelPeriodo1,
                    labelPeriodo2,
                    tipo
                };
                
            } catch (error) {
                console.error('Erro ao calcular dados comparativos:', error);
                return {
                    periodo1: { receitas: 0, despesas: 0, saldo: 0, categorias: {} },
                    periodo2: { receitas: 0, despesas: 0, saldo: 0, categorias: {} },
                    labelPeriodo1: 'Per√≠odo 1',
                    labelPeriodo2: 'Per√≠odo 2',
                    tipo: 'mensal'
                };
            }
        }

        /**
         * Calcular totais de um per√≠odo
         */
        function calcularTotaisPeriodo(transacoesPeriodo) {
            const receitas = transacoesPeriodo
                .filter(t => t.tipo === 'receita')
                .reduce((sum, t) => sum + t.valor, 0);
                
            const despesas = transacoesPeriodo
                .filter(t => t.tipo === 'despesa')
                .reduce((sum, t) => sum + t.valor, 0);
                
            const saldo = receitas - despesas;
            
            // Agrupar por categoria
            const categorias = {};
            transacoesPeriodo.forEach(t => {
                if (!categorias[t.categoria]) {
                    categorias[t.categoria] = { receitas: 0, despesas: 0 };
                }
                
                if (t.tipo === 'receita') {
                    categorias[t.categoria].receitas += t.valor;
                } else {
                    categorias[t.categoria].despesas += t.valor;
                }
            });
            
            return { receitas, despesas, saldo, categorias };
        }

        /**
         * Atualizar resumo comparativo
         */
        function atualizarResumoComparativo(dados) {
            try {
                // Atualizar labels
                document.getElementById('comparativoReceitasPeriodo1Label').textContent = dados.labelPeriodo1;
                document.getElementById('comparativoReceitasPeriodo2Label').textContent = dados.labelPeriodo2;
                document.getElementById('comparativoDespesasPeriodo1Label').textContent = dados.labelPeriodo1;
                document.getElementById('comparativoDespesasPeriodo2Label').textContent = dados.labelPeriodo2;
                document.getElementById('comparativoSaldoPeriodo1Label').textContent = dados.labelPeriodo1;
                document.getElementById('comparativoSaldoPeriodo2Label').textContent = dados.labelPeriodo2;
                document.getElementById('comparativoEconomiaPeriodo1Label').textContent = dados.labelPeriodo1;
                document.getElementById('comparativoEconomiaPeriodo2Label').textContent = dados.labelPeriodo2;
                
                // Atualizar valores
                document.getElementById('comparativoReceitasPeriodo1').textContent = formatBRL(dados.periodo1.receitas);
                document.getElementById('comparativoReceitasPeriodo2').textContent = formatBRL(dados.periodo2.receitas);
                document.getElementById('comparativoDespesasPeriodo1').textContent = formatBRL(dados.periodo1.despesas);
                document.getElementById('comparativoDespesasPeriodo2').textContent = formatBRL(dados.periodo2.despesas);
                
                // Saldo com cores
                const saldo1El = document.getElementById('comparativoSaldoPeriodo1');
                const saldo2El = document.getElementById('comparativoSaldoPeriodo2');
                saldo1El.textContent = formatBRL(dados.periodo1.saldo);
                saldo2El.textContent = formatBRL(dados.periodo2.saldo);
                saldo1El.className = `text-lg font-bold ${dados.periodo1.saldo >= 0 ? 'text-green-600' : 'text-red-600'}`;
                saldo2El.className = `text-lg font-bold ${dados.periodo2.saldo >= 0 ? 'text-green-600' : 'text-red-600'}`;
                
                // Taxa de economia
                const economia1 = dados.periodo1.receitas > 0 ? (dados.periodo1.saldo / dados.periodo1.receitas) * 100 : 0;
                const economia2 = dados.periodo2.receitas > 0 ? (dados.periodo2.saldo / dados.periodo2.receitas) * 100 : 0;
                document.getElementById('comparativoEconomiaPeriodo1').textContent = `${economia1.toFixed(1)}%`;
                document.getElementById('comparativoEconomiaPeriodo2').textContent = `${economia2.toFixed(1)}%`;
                
                // Calcular varia√ß√µes
                const varReceitas = calcularVariacao(dados.periodo1.receitas, dados.periodo2.receitas);
                const varDespesas = calcularVariacao(dados.periodo1.despesas, dados.periodo2.despesas);
                const varSaldo = calcularVariacao(dados.periodo1.saldo, dados.periodo2.saldo);
                const varEconomia = economia1 - economia2;
                
                // Atualizar varia√ß√µes
                atualizarVariacao('comparativoReceitas', varReceitas, true);
                atualizarVariacao('comparativoDespesas', varDespesas, false);
                atualizarVariacao('comparativoSaldo', varSaldo, true);
                
                const economiaIcon = document.getElementById('comparativoEconomiaIcon');
                const economiaVariacao = document.getElementById('comparativoEconomiaVariacao');
                economiaIcon.className = `fas ${varEconomia >= 0 ? 'fa-arrow-up text-green-500' : 'fa-arrow-down text-red-500'}`;
                economiaVariacao.textContent = `${Math.abs(varEconomia).toFixed(1)}pp`;
                economiaVariacao.className = `text-sm font-medium ${varEconomia >= 0 ? 'text-green-600' : 'text-red-600'}`;
                
            } catch (error) {
                console.error('Erro ao atualizar resumo comparativo:', error);
            }
        }

        /**
         * Calcular varia√ß√£o percentual
         */
        function calcularVariacao(valorAtual, valorAnterior) {
            if (valorAnterior === 0) {
                return valorAtual > 0 ? 100 : 0;
            }
            return ((valorAtual - valorAnterior) / Math.abs(valorAnterior)) * 100;
        }

        /**
         * Atualizar indicador de varia√ß√£o
         */
        function atualizarVariacao(prefixo, variacao, positiveIsGood) {
            const icon = document.getElementById(prefixo + 'Icon');
            const text = document.getElementById(prefixo + 'Variacao');
            
            const isPositive = variacao >= 0;
            const isGood = positiveIsGood ? isPositive : !isPositive;
            
            icon.className = `fas ${isPositive ? 'fa-arrow-up' : 'fa-arrow-down'} ${isGood ? 'text-green-500' : 'text-red-500'}`;
            text.textContent = `${Math.abs(variacao).toFixed(1)}%`;
            text.className = `text-sm font-medium ${isGood ? 'text-green-600' : 'text-red-600'}`;
        }

        /**
         * Renderizar gr√°fico comparativo
         */
        function renderizarGraficoComparativo(dados) {
            try {
                const ctx = document.getElementById('comparativoChart');
                if (!ctx) return;
                
                if (comparativoChart) {
                    comparativoChart.destroy();
                }
                
                // Obter todas as categorias
                const todasCategorias = new Set([
                    ...Object.keys(dados.periodo1.categorias),
                    ...Object.keys(dados.periodo2.categorias)
                ]);
                
                const categorias = Array.from(todasCategorias).sort();
                const despesasPeriodo1 = categorias.map(cat => dados.periodo1.categorias[cat]?.despesas || 0);
                const despesasPeriodo2 = categorias.map(cat => dados.periodo2.categorias[cat]?.despesas || 0);
                
                comparativoChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: categorias,
                        datasets: [
                            {
                                label: dados.labelPeriodo1,
                                data: despesasPeriodo1,
                                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                borderColor: 'rgb(59, 130, 246)',
                                borderWidth: 1
                            },
                            {
                                label: dados.labelPeriodo2,
                                data: despesasPeriodo2,
                                backgroundColor: 'rgba(156, 163, 175, 0.8)',
                                borderColor: 'rgb(156, 163, 175)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + formatBRL(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Categorias'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Valor (R$)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatBRL(value);
                                    }
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Erro ao renderizar gr√°fico comparativo:', error);
            }
        }

        /**
         * Renderizar maiores varia√ß√µes
         */
        function renderizarVariacoes(dados) {
            try {
                const container = document.getElementById('comparativoVariacoes');
                
                // Calcular varia√ß√µes por categoria
                const variacoes = [];
                const todasCategorias = new Set([
                    ...Object.keys(dados.periodo1.categorias),
                    ...Object.keys(dados.periodo2.categorias)
                ]);
                
                todasCategorias.forEach(categoria => {
                    const despesa1 = dados.periodo1.categorias[categoria]?.despesas || 0;
                    const despesa2 = dados.periodo2.categorias[categoria]?.despesas || 0;
                    
                    if (despesa1 > 0 || despesa2 > 0) {
                        const variacao = calcularVariacao(despesa1, despesa2);
                        const diferenca = despesa1 - despesa2;
                        
                        variacoes.push({
                            categoria,
                            variacao,
                            diferenca,
                            valor1: despesa1,
                            valor2: despesa2
                        });
                    }
                });
                
                // Ordenar por maior varia√ß√£o absoluta
                variacoes.sort((a, b) => Math.abs(b.variacao) - Math.abs(a.variacao));
                
                if (variacoes.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhuma varia√ß√£o encontrada</p>';
                    return;
                }
                
                container.innerHTML = variacoes.slice(0, 8).map(v => {
                    const isAumento = v.variacao > 0;
                    const isSignificativo = Math.abs(v.variacao) > 10;
                    
                    return `
                        <div class="flex items-center justify-between p-3 ${isSignificativo ? 'bg-yellow-50' : 'bg-gray-50'} rounded-lg">
                            <div class="flex items-center space-x-3">
                                <i class="fas ${isAumento ? 'fa-arrow-up text-red-500' : 'fa-arrow-down text-green-500'}"></i>
                                <div>
                                    <div class="font-medium">${v.categoria}</div>
                                    <div class="text-sm text-gray-600">
                                        ${formatBRL(v.valor2)} ‚Üí ${formatBRL(v.valor1)}
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold ${isAumento ? 'text-red-600' : 'text-green-600'}">
                                    ${isAumento ? '+' : ''}${v.variacao.toFixed(1)}%
                                </div>
                                <div class="text-sm text-gray-600">
                                    ${formatBRL(Math.abs(v.diferenca))}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Erro ao renderizar varia√ß√µes:', error);
            }
        }

        /**
         * Renderizar insights comparativos
         */
        function renderizarInsightsComparativos(dados) {
            try {
                const container = document.getElementById('comparativoInsights');
                const insights = [];
                
                // An√°lise de receitas
                const varReceitas = calcularVariacao(dados.periodo1.receitas, dados.periodo2.receitas);
                if (Math.abs(varReceitas) > 5) {
                    insights.push({
                        icon: varReceitas > 0 ? 'fa-arrow-up text-green-500' : 'fa-arrow-down text-red-500',
                        titulo: varReceitas > 0 ? 'Aumento nas Receitas' : 'Redu√ß√£o nas Receitas',
                        descricao: `Suas receitas ${varReceitas > 0 ? 'aumentaram' : 'diminu√≠ram'} ${Math.abs(varReceitas).toFixed(1)}% em rela√ß√£o ao per√≠odo anterior.`,
                        tipo: varReceitas > 0 ? 'positivo' : 'negativo'
                    });
                }
                
                // An√°lise de despesas
                const varDespesas = calcularVariacao(dados.periodo1.despesas, dados.periodo2.despesas);
                if (Math.abs(varDespesas) > 5) {
                    insights.push({
                        icon: varDespesas > 0 ? 'fa-arrow-up text-red-500' : 'fa-arrow-down text-green-500',
                        titulo: varDespesas > 0 ? 'Aumento nos Gastos' : 'Redu√ß√£o nos Gastos',
                        descricao: `Seus gastos ${varDespesas > 0 ? 'aumentaram' : 'diminu√≠ram'} ${Math.abs(varDespesas).toFixed(1)}% em rela√ß√£o ao per√≠odo anterior.`,
                        tipo: varDespesas > 0 ? 'negativo' : 'positivo'
                    });
                }
                
                // An√°lise de saldo
                const varSaldo = calcularVariacao(dados.periodo1.saldo, dados.periodo2.saldo);
                if (Math.abs(varSaldo) > 10) {
                    insights.push({
                        icon: varSaldo > 0 ? 'fa-arrow-up text-green-500' : 'fa-arrow-down text-red-500',
                        titulo: varSaldo > 0 ? 'Melhora no Saldo' : 'Piora no Saldo',
                        descricao: `Seu saldo ${varSaldo > 0 ? 'melhorou' : 'piorou'} significativamente (${Math.abs(varSaldo).toFixed(1)}%).`,
                        tipo: varSaldo > 0 ? 'positivo' : 'negativo'
                    });
                }
                
                // Recomenda√ß√µes gerais
                if (dados.periodo1.despesas > dados.periodo1.receitas) {
                    insights.push({
                        icon: 'fa-exclamation-triangle text-yellow-500',
                        titulo: 'Aten√ß√£o ao Or√ßamento',
                        descricao: 'Suas despesas est√£o superiores √†s receitas. Considere revisar seus gastos.',
                        tipo: 'alerta'
                    });
                }
                
                if (insights.length === 0) {
                    insights.push({
                        icon: 'fa-info-circle text-blue-500',
                        titulo: 'Estabilidade Financeira',
                        descricao: 'Seus gastos e receitas est√£o relativamente est√°veis entre os per√≠odos comparados.',
                        tipo: 'neutro'
                    });
                }
                
                container.innerHTML = insights.map(insight => `
                    <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                        <i class="fas ${insight.icon} mt-1"></i>
                        <div>
                            <div class="font-medium text-gray-800">${insight.titulo}</div>
                            <div class="text-sm text-gray-600 mt-1">${insight.descricao}</div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Erro ao renderizar insights comparativos:', error);
            }
        }

        // ==================== FUNCIONALIDADES DE FLUXO DE CAIXA ====================

        /**
         * Atualizar fluxo de caixa
         */
        function atualizarFluxoCaixa() {
            try {
                const periodo = parseInt(document.getElementById('fluxoPeriodo').value);
                const tipo = document.getElementById('fluxoTipo').value;
                
                const dadosFluxo = calcularDadosFluxoCaixa(periodo, tipo);
                
                atualizarResumoFluxo(dadosFluxo);
                renderizarGraficoFluxoCaixa(dadosFluxo);
                renderizarCategoriasFluxo(dadosFluxo);
                
            } catch (error) {
                console.error('Erro ao atualizar fluxo de caixa:', error);
            }
        }

        /**
         * Calcular dados do fluxo de caixa
         */
        function calcularDadosFluxoCaixa(meses, tipo) {
            try {
                const hoje = new Date();
                const dataInicio = new Date();
                dataInicio.setMonth(hoje.getMonth() - meses);
                
                const transacoesPeriodo = transacoes.filter(t => {
                    const dataTransacao = new Date(t.data + 'T00:00:00');
                    return dataTransacao >= dataInicio && dataTransacao <= hoje;
                });
                
                let dadosAgrupados = {};
                let totalEntradas = 0;
                let totalSaidas = 0;
                
                // Agrupar transa√ß√µes por per√≠odo
                transacoesPeriodo.forEach(transacao => {
                    const data = new Date(transacao.data + 'T00:00:00');
                    let chave;
                    
                    switch (tipo) {
                        case 'diario':
                            chave = data.toISOString().split('T')[0];
                            break;
                        case 'semanal':
                            const inicioSemana = new Date(data);
                            inicioSemana.setDate(data.getDate() - data.getDay());
                            chave = inicioSemana.toISOString().split('T')[0];
                            break;
                        case 'mensal':
                        default:
                            chave = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                            break;
                    }
                    
                    if (!dadosAgrupados[chave]) {
                        dadosAgrupados[chave] = {
                            entradas: 0,
                            saidas: 0,
                            categorias: { entradas: {}, saidas: {} }
                        };
                    }
                    
                    if (transacao.tipo === 'receita') {
                        dadosAgrupados[chave].entradas += transacao.valor;
                        totalEntradas += transacao.valor;
                        
                        if (!dadosAgrupados[chave].categorias.entradas[transacao.categoria]) {
                            dadosAgrupados[chave].categorias.entradas[transacao.categoria] = 0;
                        }
                        dadosAgrupados[chave].categorias.entradas[transacao.categoria] += transacao.valor;
                    } else {
                        dadosAgrupados[chave].saidas += transacao.valor;
                        totalSaidas += transacao.valor;
                        
                        if (!dadosAgrupados[chave].categorias.saidas[transacao.categoria]) {
                            dadosAgrupados[chave].categorias.saidas[transacao.categoria] = 0;
                        }
                        dadosAgrupados[chave].categorias.saidas[transacao.categoria] += transacao.valor;
                    }
                });
                
                // Ordenar por data
                const periodosOrdenados = Object.keys(dadosAgrupados).sort();
                
                return {
                    periodos: periodosOrdenados,
                    dados: dadosAgrupados,
                    totalEntradas,
                    totalSaidas,
                    fluxoLiquido: totalEntradas - totalSaidas,
                    mediaMensal: (totalEntradas - totalSaidas) / meses,
                    tipo
                };
                
            } catch (error) {
                console.error('Erro ao calcular dados do fluxo de caixa:', error);
                return {
                    periodos: [],
                    dados: {},
                    totalEntradas: 0,
                    totalSaidas: 0,
                    fluxoLiquido: 0,
                    mediaMensal: 0,
                    tipo: 'mensal'
                };
            }
        }

        /**
         * Atualizar resumo do fluxo
         */
        function atualizarResumoFluxo(dadosFluxo) {
            try {
                document.getElementById('fluxoTotalEntradas').textContent = formatBRL(dadosFluxo.totalEntradas);
                document.getElementById('fluxoTotalSaidas').textContent = formatBRL(dadosFluxo.totalSaidas);
                
                const fluxoLiquidoEl = document.getElementById('fluxoLiquido');
                fluxoLiquidoEl.textContent = formatBRL(dadosFluxo.fluxoLiquido);
                fluxoLiquidoEl.className = `text-2xl font-bold ${dadosFluxo.fluxoLiquido >= 0 ? 'text-green-600' : 'text-red-600'}`;
                
                document.getElementById('fluxoMediaMensal').textContent = formatBRL(dadosFluxo.mediaMensal);
                
            } catch (error) {
                console.error('Erro ao atualizar resumo do fluxo:', error);
            }
        }

        /**
         * Renderizar gr√°fico de fluxo de caixa
         */
        function renderizarGraficoFluxoCaixa(dadosFluxo) {
            try {
                const ctx = document.getElementById('fluxoCaixaChart');
                if (!ctx) return;
                
                if (fluxoCaixaChart) {
                    fluxoCaixaChart.destroy();
                }
                
                const labels = dadosFluxo.periodos.map(periodo => {
                    switch (dadosFluxo.tipo) {
                        case 'diario':
                            return new Date(periodo + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                        case 'semanal':
                            return `Sem ${new Date(periodo + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })}`;
                        case 'mensal':
                        default:
                            const [ano, mes] = periodo.split('-');
                            return new Date(ano, mes - 1).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                    }
                });
                
                const entradas = dadosFluxo.periodos.map(periodo => dadosFluxo.dados[periodo]?.entradas || 0);
                const saidas = dadosFluxo.periodos.map(periodo => dadosFluxo.dados[periodo]?.saidas || 0);
                const saldoAcumulado = [];
                let acumulado = 0;
                
                dadosFluxo.periodos.forEach(periodo => {
                    const entrada = dadosFluxo.dados[periodo]?.entradas || 0;
                    const saida = dadosFluxo.dados[periodo]?.saidas || 0;
                    acumulado += entrada - saida;
                    saldoAcumulado.push(acumulado);
                });
                
                fluxoCaixaChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Entradas',
                                data: entradas,
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                borderColor: 'rgb(34, 197, 94)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: 'Sa√≠das',
                                data: saidas,
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                borderColor: 'rgb(239, 68, 68)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: 'Saldo Acumulado',
                                data: saldoAcumulado,
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderColor: 'rgb(59, 130, 246)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + formatBRL(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Per√≠odo'
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Valor (R$)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatBRL(value);
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Saldo Acumulado (R$)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatBRL(value);
                                    }
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Erro ao renderizar gr√°fico de fluxo de caixa:', error);
            }
        }

        /**
         * Renderizar categorias do fluxo
         */
        function renderizarCategoriasFluxo(dadosFluxo) {
            try {
                // Agregar categorias de todo o per√≠odo
                const categoriasEntradas = {};
                const categoriasSaidas = {};
                
                dadosFluxo.periodos.forEach(periodo => {
                    const dados = dadosFluxo.dados[periodo];
                    if (dados) {
                        Object.entries(dados.categorias.entradas).forEach(([categoria, valor]) => {
                            categoriasEntradas[categoria] = (categoriasEntradas[categoria] || 0) + valor;
                        });
                        
                        Object.entries(dados.categorias.saidas).forEach(([categoria, valor]) => {
                            categoriasSaidas[categoria] = (categoriasSaidas[categoria] || 0) + valor;
                        });
                    }
                });
                
                // Renderizar entradas
                const containerEntradas = document.getElementById('fluxoEntradasCategoria');
                const entradasOrdenadas = Object.entries(categoriasEntradas)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10);
                
                if (entradasOrdenadas.length === 0) {
                    containerEntradas.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhuma entrada no per√≠odo</p>';
                } else {
                    containerEntradas.innerHTML = entradasOrdenadas.map(([categoria, valor]) => {
                        const percentual = dadosFluxo.totalEntradas > 0 ? (valor / dadosFluxo.totalEntradas) * 100 : 0;
                        return `
                            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-800">${categoria}</div>
                                    <div class="w-full bg-green-200 rounded-full h-2 mt-1">
                                        <div class="bg-green-500 h-2 rounded-full" style="width: ${percentual}%"></div>
                                    </div>
                                </div>
                                <div class="ml-4 text-right">
                                    <div class="font-semibold text-green-600">${formatBRL(valor)}</div>
                                    <div class="text-sm text-gray-600">${percentual.toFixed(1)}%</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // Renderizar sa√≠das
                const containerSaidas = document.getElementById('fluxoSaidasCategoria');
                const saidasOrdenadas = Object.entries(categoriasSaidas)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10);
                
                if (saidasOrdenadas.length === 0) {
                    containerSaidas.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhuma sa√≠da no per√≠odo</p>';
                } else {
                    containerSaidas.innerHTML = saidasOrdenadas.map(([categoria, valor]) => {
                        const percentual = dadosFluxo.totalSaidas > 0 ? (valor / dadosFluxo.totalSaidas) * 100 : 0;
                        return `
                            <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-800">${categoria}</div>
                                    <div class="w-full bg-red-200 rounded-full h-2 mt-1">
                                        <div class="bg-red-500 h-2 rounded-full" style="width: ${percentual}%"></div>
                                    </div>
                                </div>
                                <div class="ml-4 text-right">
                                    <div class="font-semibold text-red-600">${formatBRL(valor)}</div>
                                    <div class="text-sm text-gray-600">${percentual.toFixed(1)}%</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
            } catch (error) {
                console.error('Erro ao renderizar categorias do fluxo:', error);
            }
        }

        // ==================== FUNCIONALIDADES DE OR√áAMENTO ====================

        let orcamentos = [];
        let unsubscribeOrcamentos = null;

        /**
         * Configura o listener para or√ßamentos
         */
        function setupOrcamentosListener() {
            if (unsubscribeOrcamentos) unsubscribeOrcamentos();
            unsubscribeOrcamentos = onSnapshot(collection(db, `users/${currentUser.uid}/orcamentos`), (snapshot) => {
                orcamentos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrcamentos();
            }, (error) => {
                console.error("Erro ao sincronizar or√ßamentos:", error);
                showToast("Erro", "Erro ao carregar or√ßamentos", "error");
            });
        }

        /**
         * Renderiza os or√ßamentos na tela
         */
        function renderOrcamentos() {
            const container = document.getElementById("orcamentosList");
            if (!container) return;

            if (orcamentos.length === 0) {
                container.innerHTML = 
                    `<div class="text-center py-8 text-gray-500">
                        <i class="fas fa-box-open text-4xl mb-4"></i>
                        <p>Nenhum or√ßamento cadastrado. Comece a planejar suas finan√ßas!</p>
                    </div>`;
                return;
            }

            container.innerHTML = orcamentos.map(orc => {
                const gasto = calcularGastoOrcamento(orc.categoria);
                const percentual = orc.valor > 0 ? (gasto / orc.valor) * 100 : 0;
                let progressBarColor = "bg-green-500";
                if (percentual > 100) {
                    progressBarColor = "bg-red-500";
                } else if (percentual > 80) {
                    progressBarColor = "bg-yellow-500";
                }
                const excedidoText = percentual > 100 ? " - Excedido!" : "";

                return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex-1">
                            <div class="font-medium">${sanitizeString(orc.categoria)}</div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div class="${progressBarColor} h-2 rounded-full" style="width: ${Math.min(100, percentual)}%"></div>
                            </div>
                        </div>
                        <div class="ml-4 text-right">
                            <div class="font-semibold">${formatBRL(gasto)} / ${formatBRL(orc.valor)}</div>
                            <div class="text-sm text-gray-600">${percentual.toFixed(1)}% utilizado${excedidoText}</div>
                        </div>
                        <div class="ml-4 flex space-x-2">
                            <button onclick="abrirModalOrcamento(\'${orc.id}\')" class="text-blue-500 hover:text-blue-700">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="excluirOrcamento(\'${orc.id}\')" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join("");

            atualizarResumoOrcamentos();
        }

        /**
         * Calcula o gasto total para uma categoria de or√ßamento
         * @param {string} categoria - Categoria do or√ßamento
         * @returns {number} Gasto total
         */
        function calcularGastoOrcamento(categoria) {
            const mesAtual = new Date().toISOString().slice(0, 7);
            return transacoes
                .filter(t => t.tipo === "despesa" && t.categoria === categoria && t.data.startsWith(mesAtual))
                .reduce((sum, t) => sum + t.valor, 0);
        }

        /**
         * Atualiza o resumo geral dos or√ßamentos
         */
        function atualizarResumoOrcamentos() {
            let totalOrcado = 0;
            let totalGasto = 0;

            orcamentos.forEach(orc => {
                totalOrcado += orc.valor;
                totalGasto += calcularGastoOrcamento(orc.categoria);
            });

            const disponivel = totalOrcado - totalGasto;

            document.getElementById("orcamentoTotalOrcado").textContent = formatBRL(totalOrcado);
            document.getElementById("orcamentoTotalGasto").textContent = formatBRL(totalGasto);
            document.getElementById("orcamentoDisponivel").textContent = formatBRL(disponivel);

            const disponivelEl = document.getElementById("orcamentoDisponivel");
            disponivelEl.className = `text-2xl font-bold ${disponivel >= 0 ? "text-green-600" : "text-red-600"}`;
        }

        /**
         * Abre o modal de or√ßamento para adicionar ou editar
         * @param {string} [id] - ID do or√ßamento para edi√ß√£o
         */
        function abrirModalOrcamento(id) {
            const modal = document.getElementById("orcamentoModal");
            const form = document.getElementById("orcamentoForm");
            const titulo = document.getElementById("orcamentoModalTitle");
            const btnSubmit = document.getElementById("orcamentoSubmitBtn");

            orcamentoEditando = null;
            form.reset();

            if (id) {
                orcamentoEditando = orcamentos.find(orc => orc.id === id);
                if (orcamentoEditando) {
                    titulo.textContent = "Editar Or√ßamento";
                    btnSubmit.textContent = "Salvar Altera√ß√µes";
                    form.querySelector("#orcamentoCategoria").value = orcamentoEditando.categoria;
                    form.querySelector("#orcamentoValor").value = orcamentoEditando.valor;
                }
            } else {
                titulo.textContent = "Novo Or√ßamento";
                btnSubmit.textContent = "Adicionar Or√ßamento";
            }

            modal.classList.remove("hidden");
        }

        /**
         * Fecha o modal de or√ßamento
         */
        function fecharModalOrcamento() {
            document.getElementById("orcamentoModal").classList.add("hidden");
            orcamentoEditando = null;
        }

        /**
         * Lida com o envio do formul√°rio de or√ßamento
         * @param {Event} event - Evento de envio
         */
        async function handleOrcamentoForm(event) {
            event.preventDefault();
            const form = event.target;
            const categoria = form.querySelector("#orcamentoCategoria").value;
            const valor = parseFloat(form.querySelector("#orcamentoValor").value);

            if (!categoria || isNaN(valor) || valor <= 0) {
                showToast("Erro", "Preencha todos os campos corretamente", "error");
                return;
            }

            const dadosOrcamento = {
                categoria: categoria,
                valor: valor
            };

            try {
                if (orcamentoEditando) {
                    await updateDoc(doc(db, `users/${currentUser.uid}/orcamentos`, orcamentoEditando.id), dadosOrcamento);
                    showToast("Sucesso", "Or√ßamento atualizado!", "success");
                } else {
                    await addDoc(collection(db, `users/${currentUser.uid}/orcamentos`), dadosOrcamento);
                    showToast("Sucesso", "Or√ßamento adicionado!", "success");
                }
                fecharModalOrcamento();
            } catch (error) {
                console.error("Erro ao salvar or√ßamento:", error);
                showToast("Erro", "Erro ao salvar or√ßamento", "error");
            }
        }

        /**
         * Exclui um or√ßamento
         * @param {string} id - ID do or√ßamento a ser exclu√≠do
         */
        function excluirOrcamento(id) {
            openConfirmModal(
                "Confirmar Exclus√£o",
                "Deseja realmente excluir este or√ßamento?",
                async () => {
                    try {
                        await deleteDoc(doc(db, `users/${currentUser.uid}/orcamentos`, id));
                        showToast("Sucesso", "Or√ßamento exclu√≠do!", "success");
                    } catch (error) {
                        console.error("Erro ao excluir or√ßamento:", error);
                        showToast("Erro", "Erro ao excluir or√ßamento", "error");
                    }
                },
                "danger"
            );
        }

        // ==================== FUNCIONALIDADES DE TRANSA√á√ïES RECORRENTES ====================

        /**
         * Abrir modal de transa√ß√£o recorrente
         */
        function abrirModalRecorrente(recorrente = null) {
            try {
                const modal = document.getElementById('recorrenteModal');
                const title = document.getElementById('recorrenteTitle');
                const submitText = document.getElementById('recorrenteSubmitText');
                const form = document.getElementById('recorrenteForm');
                
                // Carregar categorias
                carregarCategoriasRecorrente();
                
                // Definir data de in√≠cio padr√£o
                const hoje = new Date();
                document.getElementById('recorrenteDataInicio').value = hoje.toISOString().split('T')[0];
                document.getElementById('recorrenteDia').value = hoje.getDate();
                
                if (recorrente) {
                    // Modo edi√ß√£o
                    recorrenteEditando = recorrente;
                    title.textContent = 'Editar Transa√ß√£o Recorrente';
                    submitText.textContent = 'Salvar Altera√ß√µes';
                    
                    document.getElementById('recorrenteTipo').value = recorrente.tipo;
                    document.getElementById('recorrenteDescricao').value = recorrente.descricao;
                    document.getElementById('recorrenteValor').value = formatBRL(recorrente.valor);
                    document.getElementById('recorrenteCategoria').value = recorrente.categoria;
                    document.getElementById('recorrenteFrequencia').value = recorrente.frequencia;
                    document.getElementById('recorrenteDia').value = recorrente.diaExecucao;
                    document.getElementById('recorrenteDataInicio').value = recorrente.dataInicio;
                    document.getElementById('recorrenteDataFim').value = recorrente.dataFim || '';
                    document.getElementById('recorrenteAtiva').checked = recorrente.ativa;
                } else {
                    // Modo cria√ß√£o
                    recorrenteEditando = null;
                    title.textContent = 'Nova Transa√ß√£o Recorrente';
                    submitText.textContent = 'Criar Recorrente';
                    form.reset();
                    
                    // Redefinir valores padr√£o ap√≥s reset
                    document.getElementById('recorrenteDataInicio').value = hoje.toISOString().split('T')[0];
                    document.getElementById('recorrenteDia').value = hoje.getDate();
                    document.getElementById('recorrenteAtiva').checked = true;
                }
                
                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao abrir modal de recorrente:', error);
                showToast('Erro ao abrir formul√°rio', 'error');
            }
        }

        /**
         * Fechar modal de transa√ß√£o recorrente
         */
        function fecharModalRecorrente() {
            const modal = document.getElementById('recorrenteModal');
            modal.classList.add('hidden');
            recorrenteEditando = null;
        }

        /**
         * Carregar categorias no select de recorrente
         */
        function carregarCategoriasRecorrente() {
            try {
                const select = document.getElementById('recorrenteCategoria');
                const categorias = new Set();
                
                // Obter categorias das transa√ß√µes
                transacoes
                    .filter(t => t.categoria)
                    .forEach(t => categorias.add(t.categoria));
                
                // Limpar e repovoar select
                select.innerHTML = '<option value="">Selecione uma categoria</option>';
                
                Array.from(categorias).sort().forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria;
                    option.textContent = categoria;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        /**
         * Manipular formul√°rio de transa√ß√£o recorrente
         */
        async function handleRecorrenteForm(event) {
            event.preventDefault();
            
            try {
                const tipo = document.getElementById('recorrenteTipo').value;
                const descricao = document.getElementById('recorrenteDescricao').value.trim();
                const valorStr = document.getElementById('recorrenteValor').value;
                const categoria = document.getElementById('recorrenteCategoria').value;
                const frequencia = document.getElementById('recorrenteFrequencia').value;
                const diaExecucao = parseInt(document.getElementById('recorrenteDia').value);
                const dataInicio = document.getElementById('recorrenteDataInicio').value;
                const dataFim = document.getElementById('recorrenteDataFim').value;
                const ativa = document.getElementById('recorrenteAtiva').checked;
                
                if (!tipo || !descricao || !valorStr || !categoria || !frequencia || !diaExecucao || !dataInicio) {
                    showToast('Preencha todos os campos obrigat√≥rios', 'error');
                    return;
                }
                
                const valor = parseFloat(valorStr.replace(/[^\d,]/g, '').replace(',', '.'));
                
                if (isNaN(valor) || valor <= 0) {
                    showToast('Valor inv√°lido', 'error');
                    return;
                }
                
                if (diaExecucao < 1 || diaExecucao > 31) {
                    showToast('Dia de execu√ß√£o deve estar entre 1 e 31', 'error');
                    return;
                }
                
                const recorrenteData = {
                    tipo,
                    descricao,
                    valor,
                    categoria,
                    frequencia,
                    diaExecucao,
                    dataInicio,
                    dataFim: dataFim || null,
                    ativa,
                    proximaExecucao: calcularProximaExecucao(dataInicio, frequencia, diaExecucao),
                    criadoEm: new Date().toISOString(),
                    userId: currentUser.uid
                };
                
                if (recorrenteEditando) {
                    // Atualizar recorrente existente
                    await updateDoc(doc(db, 'recorrentes', recorrenteEditando.id), recorrenteData);
                    showToast('Transa√ß√£o recorrente atualizada com sucesso!', 'success');
                } else {
                    // Criar nova recorrente
                    await addDoc(collection(db, 'recorrentes'), recorrenteData);
                    showToast('Transa√ß√£o recorrente criada com sucesso!', 'success');
                }
                
                fecharModalRecorrente();
                
            } catch (error) {
                console.error('Erro ao salvar transa√ß√£o recorrente:', error);
                showToast('Erro ao salvar transa√ß√£o recorrente', 'error');
            }
        }

        /**
         * Calcular pr√≥xima execu√ß√£o
         */
        function calcularProximaExecucao(dataInicio, frequencia, diaExecucao) {
            try {
                const inicio = new Date(dataInicio + 'T00:00:00');
                const hoje = new Date();
                let proximaData = new Date(inicio);
                
                // Ajustar para o dia de execu√ß√£o
                proximaData.setDate(diaExecucao);
                
                // Se a data j√° passou, calcular a pr√≥xima
                while (proximaData <= hoje) {
                    switch (frequencia) {
                        case 'semanal':
                            proximaData.setDate(proximaData.getDate() + 7);
                            break;
                        case 'mensal':
                            proximaData.setMonth(proximaData.getMonth() + 1);
                            break;
                        case 'bimestral':
                            proximaData.setMonth(proximaData.getMonth() + 2);
                            break;
                        case 'trimestral':
                            proximaData.setMonth(proximaData.getMonth() + 3);
                            break;
                        case 'semestral':
                            proximaData.setMonth(proximaData.getMonth() + 6);
                            break;
                        case 'anual':
                            proximaData.setFullYear(proximaData.getFullYear() + 1);
                            break;
                    }
                }
                
                return proximaData.toISOString().split('T')[0];
                
            } catch (error) {
                console.error('Erro ao calcular pr√≥xima execu√ß√£o:', error);
                return dataInicio;
            }
        }

        /**
         * Renderizar transa√ß√µes recorrentes
         */
        function renderRecorrentes() {
            try {
                const container = document.getElementById('recorrentsContainer');
                
                if (recorrentes.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <i class="fas fa-sync-alt text-6xl text-gray-300 mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-600 mb-2">Nenhuma transa√ß√£o recorrente</h3>
                            <p class="text-gray-500 mb-4">Crie transa√ß√µes recorrentes para automatizar seu controle financeiro</p>
                            <button onclick="abrirModalRecorrente()" 
                                    class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
                                <i class="fas fa-plus mr-2"></i>Nova Recorrente
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = recorrentes.map(recorrente => {
                    const proximaExecucao = new Date(recorrente.proximaExecucao + 'T00:00:00');
                    const hoje = new Date();
                    const diasRestantes = Math.ceil((proximaExecucao - hoje) / (1000 * 60 * 60 * 24));
                    
                    let statusClass = 'bg-green-500';
                    let statusText = 'Ativa';
                    
                    if (!recorrente.ativa) {
                        statusClass = 'bg-gray-500';
                        statusText = 'Inativa';
                    } else if (diasRestantes <= 3) {
                        statusClass = 'bg-yellow-500';
                        statusText = 'Pr√≥xima';
                    } else if (diasRestantes < 0) {
                        statusClass = 'bg-red-500';
                        statusText = 'Atrasada';
                    }
                    
                    return `
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h4 class="text-lg font-semibold text-gray-800">${recorrente.descricao}</h4>
                                    <p class="text-sm text-gray-500">${recorrente.categoria} ‚Ä¢ ${recorrente.frequencia}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="abrirModalRecorrente(${JSON.stringify(recorrente).replace(/"/g, '&quot;')})" 
                                            class="text-blue-500 hover:text-blue-700">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="excluirRecorrente('${recorrente.id}')" 
                                            class="text-red-500 hover:text-red-700">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="text-2xl font-bold ${recorrente.tipo === 'receita' ? 'text-green-600' : 'text-red-600'}">
                                    ${recorrente.tipo === 'receita' ? '+' : '-'} ${formatBRL(recorrente.valor)}
                                </div>
                                <div class="text-sm text-gray-600">
                                    Pr√≥xima execu√ß√£o: ${proximaExecucao.toLocaleDateString('pt-BR')}
                                    ${diasRestantes >= 0 ? `(${diasRestantes} dias)` : '(atrasada)'}
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 ${statusClass} rounded-full"></div>
                                    <span class="text-sm font-medium">${statusText}</span>
                                </div>
                                <div class="text-xs text-gray-500">
                                    Dia ${recorrente.diaExecucao}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                renderProximasExecucoes();
                
            } catch (error) {
                console.error('Erro ao renderizar recorrentes:', error);
            }
        }

        /**
         * Renderizar pr√≥ximas execu√ß√µes
         */
        function renderProximasExecucoes() {
            try {
                const container = document.getElementById('proximasExecucoes');
                const hoje = new Date();
                const em30Dias = new Date();
                em30Dias.setDate(hoje.getDate() + 30);
                
                const proximasExecucoes = recorrentes
                    .filter(r => r.ativa)
                    .map(r => ({
                        ...r,
                        dataExecucao: new Date(r.proximaExecucao + 'T00:00:00')
                    }))
                    .filter(r => r.dataExecucao <= em30Dias)
                    .sort((a, b) => a.dataExecucao - b.dataExecucao);
                
                if (proximasExecucoes.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-calendar-check text-4xl mb-2"></i>
                            <p>Nenhuma execu√ß√£o programada para os pr√≥ximos 30 dias</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = proximasExecucoes.map(exec => {
                    const diasRestantes = Math.ceil((exec.dataExecucao - hoje) / (1000 * 60 * 60 * 24));
                    let urgenciaClass = 'border-l-green-500';
                    
                    if (diasRestantes <= 0) {
                        urgenciaClass = 'border-l-red-500';
                    } else if (diasRestantes <= 3) {
                        urgenciaClass = 'border-l-yellow-500';
                    }
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border-l-4 ${urgenciaClass}">
                            <div class="flex items-center space-x-3">
                                <i class="fas ${exec.tipo === 'receita' ? 'fa-arrow-up text-green-500' : 'fa-arrow-down text-red-500'}"></i>
                                <div>
                                    <div class="font-medium">${exec.descricao}</div>
                                    <div class="text-sm text-gray-600">${exec.categoria}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold ${exec.tipo === 'receita' ? 'text-green-600' : 'text-red-600'}">
                                    ${formatBRL(exec.valor)}
                                </div>
                                <div class="text-sm text-gray-600">
                                    ${exec.dataExecucao.toLocaleDateString('pt-BR')}
                                    ${diasRestantes === 0 ? '(hoje)' : diasRestantes === 1 ? '(amanh√£)' : `(${diasRestantes} dias)`}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Erro ao renderizar pr√≥ximas execu√ß√µes:', error);
            }
        }

        /**
         * Excluir transa√ß√£o recorrente
         */
        async function excluirRecorrente(recorrenteId) {
            try {
                const recorrente = recorrentes.find(r => r.id === recorrenteId);
                if (!recorrente) return;
                
                const confirmacao = confirm(`Deseja realmente excluir a transa√ß√£o recorrente "${recorrente.descricao}"?`);
                if (!confirmacao) return;
                
                await deleteDoc(doc(db, 'recorrentes', recorrenteId));
                showToast('Transa√ß√£o recorrente exclu√≠da com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao excluir recorrente:', error);
                showToast('Erro ao excluir transa√ß√£o recorrente', 'error');
            }
        }

        /**
         * Configurar listener de transa√ß√µes recorrentes
         */
        function setupRecorrentesListener() {
            if (!currentUser) return;
            
            try {
                const q = query(
                    collection(db, 'recorrentes'),
                    orderBy('criadoEm', 'desc')
                );
                
                unsubscribeRecorrentes = onSnapshot(q, (snapshot) => {
                    recorrentes = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(recorrente => recorrente.userId === currentUser.uid);
                    
                    renderRecorrentes();
                });
                
            } catch (error) {
                console.error('Erro ao configurar listener de recorrentes:', error);
            }
        }

        // ==================== FUNCIONALIDADES DE OR√áAMENTO ====================

        /**
         * Abrir modal de or√ßamento
         */
        function abrirModalOrcamento(orcamento = null) {
            try {
                const modal = document.getElementById('orcamentoModal');
                const title = document.getElementById('orcamentoTitle');
                const submitText = document.getElementById('orcamentoSubmitText');
                const form = document.getElementById('orcamentoForm');
                
                // Carregar categorias
                carregarCategoriasOrcamento();
                
                if (orcamento) {
                    // Modo edi√ß√£o
                    orcamentoEditando = orcamento;
                    title.textContent = 'Editar Or√ßamento';
                    submitText.textContent = 'Salvar Altera√ß√µes';
                    
                    document.getElementById('orcamentoCategoria').value = orcamento.categoria;
                    document.getElementById('orcamentoValor').value = formatBRL(orcamento.valor);
                    document.getElementById('orcamentoPeriodo').value = orcamento.periodo;
                    document.getElementById('orcamentoDescricao').value = orcamento.descricao || '';
                } else {
                    // Modo cria√ß√£o
                    orcamentoEditando = null;
                    title.textContent = 'Novo Or√ßamento';
                    submitText.textContent = 'Criar Or√ßamento';
                    form.reset();
                }
                
                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao abrir modal de or√ßamento:', error);
                showToast('Erro ao abrir formul√°rio', 'error');
            }
        }

        /**
         * Fechar modal de or√ßamento
         */
        function fecharModalOrcamento() {
            const modal = document.getElementById('orcamentoModal');
            modal.classList.add('hidden');
            orcamentoEditando = null;
        }

        /**
         * Carregar categorias no select de or√ßamento
         */
        function carregarCategoriasOrcamento() {
            try {
                const select = document.getElementById('orcamentoCategoria');
                const categorias = new Set();
                
                // Obter categorias das despesas
                transacoes
                    .filter(t => t.tipo === 'despesa' && t.categoria)
                    .forEach(t => categorias.add(t.categoria));
                
                // Limpar e repovoar select
                select.innerHTML = '<option value="">Selecione uma categoria</option>';
                
                Array.from(categorias).sort().forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria;
                    option.textContent = categoria;
                    select.appendChild(option);
                });
                
                // Adicionar op√ß√£o para nova categoria
                const novaOption = document.createElement('option');
                novaOption.value = 'nova';
                novaOption.textContent = '+ Nova Categoria';
                select.appendChild(novaOption);
                
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        /**
         * Manipular formul√°rio de or√ßamento
         */
        async function handleOrcamentoForm(event) {
            event.preventDefault();
            
            try {
                const categoria = document.getElementById('orcamentoCategoria').value;
                const valorStr = document.getElementById('orcamentoValor').value;
                const periodo = document.getElementById('orcamentoPeriodo').value;
                const descricao = document.getElementById('orcamentoDescricao').value;
                
                if (!categoria || !valorStr || !periodo) {
                    showToast('Preencha todos os campos obrigat√≥rios', 'error');
                    return;
                }
                
                const valor = parseFloat(valorStr.replace(/[^\d,]/g, '').replace(',', '.'));
                
                if (isNaN(valor) || valor <= 0) {
                    showToast('Valor inv√°lido', 'error');
                    return;
                }
                
                const orcamentoData = {
                    categoria,
                    valor,
                    periodo,
                    descricao: descricao.trim(),
                    criadoEm: new Date().toISOString(),
                    userId: currentUser.uid
                };
                
                if (orcamentoEditando) {
                    // Atualizar or√ßamento existente
                    await updateDoc(doc(db, 'orcamentos', orcamentoEditando.id), orcamentoData);
                    showToast('Or√ßamento atualizado com sucesso!', 'success');
                } else {
                    // Criar novo or√ßamento
                    await addDoc(collection(db, 'orcamentos'), orcamentoData);
                    showToast('Or√ßamento criado com sucesso!', 'success');
                }
                
                fecharModalOrcamento();
                
            } catch (error) {
                console.error('Erro ao salvar or√ßamento:', error);
                showToast('Erro ao salvar or√ßamento', 'error');
            }
        }

        /**
         * Renderizar or√ßamentos
         */
        function renderOrcamentos() {
            try {
                const container = document.getElementById('orcamentosContainer');
                
                if (orcamentos.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <i class="fas fa-bullseye text-6xl text-gray-300 mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-600 mb-2">Nenhum or√ßamento criado</h3>
                            <p class="text-gray-500 mb-4">Crie seu primeiro or√ßamento para controlar seus gastos</p>
                            <button onclick="abrirModalOrcamento()" 
                                    class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fas fa-plus mr-2"></i>Criar Or√ßamento
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = orcamentos.map(orcamento => {
                    const gastoAtual = calcularGastoCategoria(orcamento.categoria, orcamento.periodo);
                    const percentual = orcamento.valor > 0 ? (gastoAtual / orcamento.valor) * 100 : 0;
                    const disponivel = orcamento.valor - gastoAtual;
                    
                    let statusClass = 'bg-green-500';
                    let statusIcon = 'fa-check-circle';
                    let statusText = 'No limite';
                    
                    if (percentual >= 100) {
                        statusClass = 'bg-red-500';
                        statusIcon = 'fa-exclamation-triangle';
                        statusText = 'Excedido';
                    } else if (percentual >= 80) {
                        statusClass = 'bg-yellow-500';
                        statusIcon = 'fa-exclamation-circle';
                        statusText = 'Aten√ß√£o';
                    }
                    
                    return `
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h4 class="text-lg font-semibold text-gray-800">${orcamento.categoria}</h4>
                                    <p class="text-sm text-gray-500">${orcamento.periodo === 'mensal' ? 'Mensal' : 'Anual'}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="abrirModalOrcamento(${JSON.stringify(orcamento).replace(/"/g, '&quot;')})" 
                                            class="text-blue-500 hover:text-blue-700">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="excluirOrcamento('${orcamento.id}')" 
                                            class="text-red-500 hover:text-red-700">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="flex justify-between text-sm mb-2">
                                    <span>Gasto: ${formatBRL(gastoAtual)}</span>
                                    <span>Or√ßado: ${formatBRL(orcamento.valor)}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="${statusClass} h-3 rounded-full transition-all duration-300" 
                                         style="width: ${Math.min(percentual, 100)}%"></div>
                                </div>
                                <div class="flex justify-between text-xs mt-1 text-gray-600">
                                    <span>${percentual.toFixed(1)}% usado</span>
                                    <span class="${disponivel >= 0 ? 'text-green-600' : 'text-red-600'}">
                                        ${disponivel >= 0 ? 'Dispon√≠vel' : 'Excedido'}: ${formatBRL(Math.abs(disponivel))}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <i class="fas ${statusIcon} ${statusClass.replace('bg-', 'text-')}"></i>
                                    <span class="text-sm font-medium ${statusClass.replace('bg-', 'text-')}">${statusText}</span>
                                </div>
                                ${orcamento.descricao ? `<i class="fas fa-info-circle text-gray-400" title="${orcamento.descricao}"></i>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                atualizarResumoOrcamentos();
                
            } catch (error) {
                console.error('Erro ao renderizar or√ßamentos:', error);
            }
        }

        /**
         * Calcular gasto atual de uma categoria
         */
        function calcularGastoCategoria(categoria, periodo) {
            try {
                const agora = new Date();
                let dataInicio;
                
                if (periodo === 'mensal') {
                    dataInicio = new Date(agora.getFullYear(), agora.getMonth(), 1);
                } else {
                    dataInicio = new Date(agora.getFullYear(), 0, 1);
                }
                
                return transacoes
                    .filter(t => 
                        t.tipo === 'despesa' && 
                        t.categoria === categoria && 
                        t.data && 
                        new Date(t.data + 'T00:00:00') >= dataInicio &&
                        new Date(t.data + 'T00:00:00') <= agora
                    )
                    .reduce((sum, t) => sum + (t.valor || 0), 0);
                    
            } catch (error) {
                console.error('Erro ao calcular gasto da categoria:', error);
                return 0;
            }
        }

        /**
         * Atualizar resumo dos or√ßamentos
         */
        function atualizarResumoOrcamentos() {
            try {
                const totalOrcado = orcamentos.reduce((sum, o) => sum + (o.valor || 0), 0);
                let totalGasto = 0;
                
                orcamentos.forEach(orcamento => {
                    totalGasto += calcularGastoCategoria(orcamento.categoria, orcamento.periodo);
                });
                
                const totalDisponivel = totalOrcado - totalGasto;
                const percentualGasto = totalOrcado > 0 ? (totalGasto / totalOrcado) * 100 : 0;
                
                document.getElementById('totalOrcamentos').textContent = formatBRL(totalOrcado);
                document.getElementById('totalGasto').textContent = formatBRL(totalGasto);
                document.getElementById('totalDisponivel').textContent = formatBRL(totalDisponivel);
                document.getElementById('percentualGasto').textContent = `${percentualGasto.toFixed(1)}%`;
                
            } catch (error) {
                console.error('Erro ao atualizar resumo dos or√ßamentos:', error);
            }
        }

        /**
         * Excluir or√ßamento
         */
        async function excluirOrcamento(orcamentoId) {
            try {
                const orcamento = orcamentos.find(o => o.id === orcamentoId);
                if (!orcamento) return;
                
                const confirmacao = confirm(`Deseja realmente excluir o or√ßamento da categoria "${orcamento.categoria}"?`);
                if (!confirmacao) return;
                
                await deleteDoc(doc(db, 'orcamentos', orcamentoId));
                showToast('Or√ßamento exclu√≠do com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao excluir or√ßamento:', error);
                showToast('Erro ao excluir or√ßamento', 'error');
            }
        }

        /**
         * Configurar listener de or√ßamentos
         */
        function setupOrcamentosListener() {
            if (!currentUser) return;
            
            try {
                const q = query(
                    collection(db, 'orcamentos'),
                    orderBy('criadoEm', 'desc')
                );
                
                unsubscribeOrcamentos = onSnapshot(q, (snapshot) => {
                    orcamentos = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(orcamento => orcamento.userId === currentUser.uid);
                    
                    renderOrcamentos();
                });
                
            } catch (error) {
                console.error('Erro ao configurar listener de or√ßamentos:', error);
            }
        }

        // ==================== EXPORT TO WINDOW ====================

        // Exporta fun√ß√µes necess√°rias para o escopo global
        window.loginWithGoogle = loginWithGoogle;
        window.logout = logout;
        window.handleReceitaForm = handleReceitaForm;
        window.handleDespesaForm = handleDespesaForm;
        window.handlePatrimonioForm = handlePatrimonioForm;
        window.formatCurrency = formatCurrency;
        window.showTab = showTab;
        window.editTransaction = editTransaction;
        window.editPatrimonio = editPatrimonio;
        window.deleteTransactionConfirm = deleteTransactionConfirm;
        window.deletePatrimonioConfirm = deletePatrimonioConfirm;
        window.closeConfirmModal = closeConfirmModal;
        window.closeEditModal = closeEditModal;
        window.updateDashboardPeriod = updateDashboardPeriod;
        window.updateProjecaoPersonalizada = updateProjecaoPersonalizada;
        window.syncFiltersFromReports = syncFiltersFromReports;

        // Fun√ß√µes de relat√≥rios - CORRIGIDAS
        window.aplicarFiltros = aplicarFiltros;
        window.limparFiltros = limparFiltros;
        window.exportarCSV = exportarCSV;
        window.alterarOrdenacao = alterarOrdenacao;

        // Fun√ß√µes de or√ßamento
        window.abrirModalOrcamento = abrirModalOrcamento;
        window.fecharModalOrcamento = fecharModalOrcamento;
        window.handleOrcamentoForm = handleOrcamentoForm;
        window.excluirOrcamento = excluirOrcamento;

        // Fun√ß√µes de transa√ß√µes recorrentes
        window.abrirModalRecorrente = abrirModalRecorrente;
        window.fecharModalRecorrente = fecharModalRecorrente;
        window.handleRecorrenteForm = handleRecorrenteForm;
        window.excluirRecorrente = excluirRecorrente;

        // Fun√ß√µes de fluxo de caixa
        window.atualizarFluxoCaixa = atualizarFluxoCaixa;

        // Fun√ß√µes de an√°lise comparativa
        window.atualizarComparativo = atualizarComparativo;

        // ==================== INICIALIZA√á√ÉO ====================

        // Inicializa quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Sistema Financeiro Corrigido Carregado com Sucesso!');

            // Define datas nos campos
            setToday();
            
            // Adiciona event listeners para os formul√°rios
            const orcamentoForm = document.getElementById('orcamentoForm');
            if (orcamentoForm) {
                orcamentoForm.addEventListener('submit', handleOrcamentoForm);
            }
            
            const recorrenteForm = document.getElementById('recorrenteForm');
            if (recorrenteForm) {
                recorrenteForm.addEventListener('submit', handleRecorrenteForm);
            }
        });

    </script>

    <!-- README das Instru√ß√µes de Configura√ß√£o -->
    <div style="display: none;" id="readme">
        <h1>Sistema de Gest√£o Financeira Pessoal - README</h1>

        <h2>üöÄ Configura√ß√£o do Firebase</h2>
        <ol>
            <li>Acesse <a href="https://console.firebase.google.com">Firebase Console</a></li>
            <li>Crie um novo projeto ou use um existente</li>
            <li>Ative Authentication > Sign-in method > Google</li>
            <li>Ative Firestore Database</li>
            <li>Em Project Settings > General, copie suas credenciais</li>
            <li>Substitua o conte√∫do do script JSON com suas credenciais</li>
            <li>Em Authentication > Settings > Authorized domains, adicione seus dom√≠nios</li>
        </ol>

        <h2>üìä Estrutura do Firestore</h2>
        <pre>
users/{uid}/
‚îú‚îÄ‚îÄ transacoes/
‚îÇ   ‚îú‚îÄ‚îÄ {docId}
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tipo: "receita" | "despesa"
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ descricao: string
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ valor: number
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ categoria: string
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ data: string (YYYY-MM-DD)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ createdAt: timestamp
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ patrimonio/
    ‚îú‚îÄ‚îÄ {docId}
    ‚îÇ   ‚îú‚îÄ‚îÄ tipo: "bem" | "divida"
    ‚îÇ   ‚îú‚îÄ‚îÄ descricao: string
    ‚îÇ   ‚îú‚îÄ‚îÄ valor: number
    ‚îÇ   ‚îú‚îÄ‚îÄ categoria: string
    ‚îÇ   ‚îî‚îÄ‚îÄ createdAt: timestamp
    ‚îî‚îÄ‚îÄ ...
        </pre>

        <h2>üåê Deploy</h2>
        <h3>GitHub Pages:</h3>
        <ol>
            <li>Fa√ßa upload do arquivo HTML para um reposit√≥rio</li>
            <li>Ative GitHub Pages</li>
            <li>Adicione o dom√≠nio do GitHub Pages aos dom√≠nios autorizados do Firebase</li>
        </ol>

        <h3>Vercel:</h3>
        <ol>
            <li>Conecte seu reposit√≥rio ao Vercel</li>
            <li>Deploy autom√°tico</li>
            <li>Adicione o dom√≠nio do Vercel aos dom√≠nios autorizados</li>
        </ol>

        <h3>Firebase Hosting:</h3>
        <ol>
            <li>npm install -g firebase-tools</li>
            <li>firebase login</li>
            <li>firebase init hosting</li>
            <li>firebase deploy</li>
        </ol>

        <h2>‚ú® Recursos Corrigidos</h2>
        <ul>
            <li>‚úÖ Autentica√ß√£o Google autom√°tica</li>
            <li>‚úÖ Dados em tempo real com onSnapshot</li>
            <li>‚úÖ Valida√ß√£o robusta de entrada</li>
            <li>‚úÖ Formata√ß√£o monet√°ria brasileira</li>
            <li>‚úÖ Gr√°ficos interativos</li>
            <li>‚úÖ Proje√ß√µes financeiras inteligentes</li>
            <li>‚úÖ Interface responsiva</li>
            <li>‚úÖ Edi√ß√£o e exclus√£o de registros</li>
            <li>‚úÖ An√°lise autom√°tica de padr√µes</li>
            <li>‚úÖ Sugest√µes de metas</li>
            <li>‚úÖ Relat√≥rios detalhados com filtros</li>
            <li>‚úÖ Insights avan√ßados com alertas</li>
            <li>‚úÖ Exporta√ß√£o para CSV</li>
            <li>‚úÖ Sistema de notifica√ß√µes melhorado</li>
            <li>‚úÖ Preserva√ß√£o de dados dos usu√°rios</li>
        </ul>

        <h2>üîß Corre√ß√µes Implementadas</h2>
        <ul>
            <li>Unifica√ß√£o da fonte de dados (apenas Firebase)</li>
            <li>Corre√ß√£o das fun√ß√µes de relat√≥rios e insights</li>
            <li>Exporta√ß√£o correta de fun√ß√µes para escopo global</li>
            <li>Valida√ß√£o robusta de dados</li>
            <li>Inicializa√ß√£o correta dos gr√°ficos</li>
            <li>Sistema de cache para melhor performance</li>
            <li>Responsividade melhorada das tabelas</li>
            <li>Loading states implementados</li>
            <li>Tratamento de erros aprimorado</li>
            <li>Preserva√ß√£o completa dos dados dos usu√°rios</li>
        </ul>
    </div>
</body>

</html>
