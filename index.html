<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceControl Pro - Vers√£o Avan√ßada</title>

    <!-- CDN Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>

    <!-- Firebase Config -->
    <script type="application/json" id="firebase-config">
    {
        "apiKey": "AIzaSyCqCUYuwos_h5Fdt9a6bjibX7CzfhaJUqQ",
        "authDomain": "sistemafinanceiropessoal-ddbe3.firebaseapp.com",
        "projectId": "sistemafinanceiropessoal-ddbe3",
        "storageBucket": "sistemafinanceiropessoal-ddbe3.firebasestorage.app",
        "messagingSenderId": "360949795018",
        "appId": "1:360949795018:web:863523b189a26879e44c33",
        "measurementId": "G-1B3R3EK1TY"
    }
    </script>

    <style>
        /* Estilos customizados */
        .tab-content {
            min-height: 500px;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        .chart-container-large {
            height: 400px;
            position: relative;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .modal {
            backdrop-filter: blur(4px);
        }

        /* Otimiza√ß√£o para PDF */
        @media print {
            body {
                font-size: 12px;
            }

            .no-print {
                display: none !important;
            }

            .tab-content {
                break-inside: avoid;
            }

            .chart-container {
                height: 250px;
            }
        }

        /* Gradientes customizados */
        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .gradient-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .gradient-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .gradient-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .gradient-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .gradient-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .gradient-indigo {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }

        .gradient-pink {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
        }

        /* Anima√ß√µes */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pulse-success {
            animation: pulseSuccess 2s infinite;
        }

        @keyframes pulseSuccess {
            0%, 100% {
                background-color: #10b981;
            }
            50% {
                background-color: #059669;
            }
        }

        /* Estilos da tabela */
        .transaction-row {
            transition: all 0.2s;
        }

        .transaction-row:hover {
            background-color: #f9fafb;
            transform: translateX(2px);
        }

        .transaction-row.selected {
            background-color: #dbeafe !important;
            border-left: 4px solid #3b82f6;
        }

        /* Estilos dos filtros */
        .filter-chip {
            transition: all 0.2s;
        }

        .filter-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Insight cards */
        .insight-card {
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }

        .insight-card.insight-positive {
            border-left-color: #10b981;
        }

        .insight-card.insight-negative {
            border-left-color: #ef4444;
        }

        .insight-card.insight-neutral {
            border-left-color: #6b7280;
        }

        .insight-card.insight-warning {
            border-left-color: #f59e0b;
        }

        /* Scrollbar customizada */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Estilo para metas */
        .goal-progress {
            transition: width 0.5s ease;
        }

        .goal-card {
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .goal-card:hover {
            border-color: #e5e7eb;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Tela de Login -->
    <div id="loginScreen" class="min-h-screen gradient-primary flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="gradient-info w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-wallet text-3xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">FinanceControl Pro</h1>
                <p class="text-gray-600">Sistema Inteligente de Gest√£o Financeira</p>
                <div class="text-xs text-blue-600 mt-2">
                    <i class="fas fa-sparkles mr-1"></i>Vers√£o Avan√ßada
                </div>
            </div>

            <button onclick="loginWithGoogle()" id="loginBtn"
                class="w-full bg-red-500 text-white py-3 px-4 rounded-lg hover:bg-red-600 transition-all flex items-center justify-center space-x-2 font-semibold">
                <i class="fab fa-google"></i>
                <span>Entrar com Google</span>
            </button>

            <div class="mt-6 text-center text-sm text-gray-500">
                <p>Seus dados s√£o protegidos e criptografados</p>
                <div class="mt-2 flex items-center justify-center space-x-4 text-xs">
                    <span class="flex items-center"><i class="fas fa-chart-line mr-1"></i>Relat√≥rios Avan√ßados</span>
                    <span class="flex items-center"><i class="fas fa-filter mr-1"></i>Filtros Inteligentes</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tela Principal do App -->
    <div id="appScreen" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="gradient-info w-10 h-10 rounded-full flex items-center justify-center">
                            <i class="fas fa-wallet text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">FinanceControl Pro</h1>
                            <p class="text-xs text-gray-500">Sistema Inteligente Avan√ßado</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Filtro Global de Per√≠odo -->
                        <div class="hidden md:flex items-center space-x-2 bg-gray-100 rounded-lg p-2">
                            <select id="globalPeriodFilter" onchange="updateGlobalPeriod()" 
                                class="bg-transparent text-sm font-medium focus:outline-none">
                                <option value="current">M√™s Atual</option>
                                <option value="last3">√öltimos 3 Meses</option>
                                <option value="last6">√öltimos 6 Meses</option>
                                <option value="year">Ano Atual</option>
                                <option value="all">Todos os Per√≠odos</option>
                                <option value="custom">Per√≠odo Personalizado</option>
                            </select>
                        </div>
                        <img id="userPhoto" src="" alt="User" class="w-8 h-8 rounded-full">
                        <span id="userName" class="text-sm font-medium hidden lg:block"></span>
                        <button onclick="logout()"
                            class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm transition-colors">
                            <i class="fas fa-sign-out-alt mr-1"></i>Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navega√ß√£o por Tabs -->
        <nav class="bg-white border-b sticky top-16 z-30">
            <div class="container mx-auto px-4">
                <div class="flex flex-wrap space-x-1 py-2 overflow-x-auto custom-scrollbar">
                    <button onclick="showTab('dashboard')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap gradient-info text-white"
                        data-tab="dashboard">
                        <i class="fas fa-tachometer-alt mr-1"></i>Dashboard
                    </button>
                    <button onclick="showTab('receitas')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="receitas">
                        <i class="fas fa-plus-circle mr-1"></i>Receitas
                    </button>
                    <button onclick="showTab('despesas')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="despesas">
                        <i class="fas fa-minus-circle mr-1"></i>Despesas
                    </button>
                    <button onclick="showTab('relatorios')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="relatorios">
                        <i class="fas fa-chart-bar mr-1"></i>Relat√≥rios
                    </button>
                    <button onclick="showTab('patrimonio')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="patrimonio">
                        <i class="fas fa-home mr-1"></i>Patrim√¥nio
                    </button>
                    <button onclick="showTab('insights')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="insights">
                        <i class="fas fa-brain mr-1"></i>Insights
                    </button>
                    <button onclick="showTab('metas')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="metas">
                        <i class="fas fa-target mr-1"></i>Metas
                    </button>
                    <button onclick="showTab('projecao')"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap"
                        data-tab="projecao">
                        <i class="fas fa-chart-line mr-1"></i>Proje√ß√£o
                    </button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-4 py-6">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Dashboard Financeiro</h2>
                    <div class="flex items-center space-x-2">
                        <div class="text-sm text-gray-600">
                            <i class="fas fa-clock mr-1"></i>
                            <span id="lastUpdated">Atualizado agora</span>
                        </div>
                        <button onclick="refreshDashboard()" 
                            class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                            <i class="fas fa-sync-alt mr-1"></i>Atualizar
                        </button>
                    </div>
                </div>

                <!-- Filtros R√°pidos do Dashboard -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="setDashboardPeriod('current')" 
                            class="filter-chip px-3 py-1 bg-blue-500 text-white rounded-full text-sm" data-period="current">
                            M√™s Atual
                        </button>
                        <button onclick="setDashboardPeriod('last3')" 
                            class="filter-chip px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm" data-period="last3">
                            √öltimos 3 Meses
                        </button>
                        <button onclick="setDashboardPeriod('year')" 
                            class="filter-chip px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm" data-period="year">
                            Ano Atual
                        </button>
                        <button onclick="setDashboardPeriod('all')" 
                            class="filter-chip px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm" data-period="all">
                            Todos os Per√≠odos
                        </button>
                    </div>
                </div>

                <!-- M√©tricas Principais -->
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                    <div class="gradient-primary rounded-xl p-6 text-white fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Saldo Atual</p>
                                <p class="text-2xl font-bold" id="saldoAtual">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-1" id="percentualSaldo">0% vs per√≠odo anterior</p>
                            </div>
                            <i class="fas fa-wallet text-3xl opacity-70"></i>
                        </div>
                    </div>

                    <div class="gradient-success rounded-xl p-6 text-white fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Receitas do Per√≠odo</p>
                                <p class="text-2xl font-bold" id="receitasPeriodo">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-1" id="mediaReceitas">M√©dia: R$ 0,00</p>
                            </div>
                            <i class="fas fa-arrow-up text-3xl opacity-70"></i>
                        </div>
                    </div>

                    <div class="gradient-danger rounded-xl p-6 text-white fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Despesas do Per√≠odo</p>
                                <p class="text-2xl font-bold" id="despesasPeriodo">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-1" id="mediaDespesas">M√©dia: R$ 0,00</p>
                            </div>
                            <i class="fas fa-arrow-down text-3xl opacity-70"></i>
                        </div>
                    </div>

                    <div class="gradient-info rounded-xl p-6 text-white fade-in">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Economia do Per√≠odo</p>
                                <p class="text-2xl font-bold" id="economiaPeriodo">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-1" id="percentualEconomia">0% da receita</p>
                            </div>
                            <i class="fas fa-piggy-bank text-3xl opacity-70"></i>
                        </div>
                    </div>
                </div>

                <!-- Gr√°ficos Principais -->
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold flex items-center">
                                <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                                Evolu√ß√£o Mensal
                            </h3>
                            <div class="flex items-center space-x-2">
                                <button onclick="toggleChartType('evolucaoChart')" 
                                    class="text-gray-400 hover:text-gray-600 text-sm">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                <button onclick="exportChart('evolucaoChart')" 
                                    class="text-gray-400 hover:text-gray-600 text-sm">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="evolucaoChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold flex items-center">
                                <i class="fas fa-chart-pie mr-2 text-purple-500"></i>
                                Gastos por Categoria
                            </h3>
                            <select id="categoryPeriodSelect" onchange="updateCategoryChart()" 
                                class="text-sm border rounded px-2 py-1">
                                <option value="current">M√™s Atual</option>
                                <option value="last3">√öltimos 3 Meses</option>
                                <option value="year">Ano Atual</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="categoriaChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Resumo de Transa√ß√µes Recentes -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold flex items-center">
                            <i class="fas fa-history mr-2 text-gray-500"></i>
                            Transa√ß√µes Recentes
                        </h3>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-500" id="totalTransacoesDashboard">0 transa√ß√µes</span>
                            <button onclick="showTab('relatorios')" 
                                class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                Ver Todas
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold">Data</th>
                                    <th class="text-left py-3 px-4 font-semibold">Descri√ß√£o</th>
                                    <th class="text-left py-3 px-4 font-semibold">Categoria</th>
                                    <th class="text-right py-3 px-4 font-semibold">Valor</th>
                                    <th class="text-center py-3 px-4 font-semibold">Tipo</th>
                                </tr>
                            </thead>
                            <tbody id="recentTransactionsBody">
                                <!-- Transa√ß√µes recentes ser√£o carregadas aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Receitas Tab -->
            <div id="receitas" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Controle de Receitas</h2>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <!-- Formul√°rio -->
                    <div class="xl:col-span-1">
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 flex items-center text-green-600">
                                <i class="fas fa-plus-circle mr-2"></i>
                                Nova Receita
                            </h3>
                            <form onsubmit="handleReceitaForm(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700" for="receita-descricao">
                                        <i class="fas fa-file-alt mr-1"></i>Descri√ß√£o *
                                    </label>
                                    <input name="descricao" id="receita-descricao" type="text" required maxlength="100"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        placeholder="Ex: Sal√°rio Principal">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700" for="receita-valor">
                                        <i class="fas fa-dollar-sign mr-1"></i>Valor *
                                    </label>
                                    <input name="valor" id="receita-valor" type="text" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        placeholder="1.000,00" oninput="formatCurrency(this)">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700" for="receita-categoria">
                                        <i class="fas fa-tags mr-1"></i>Categoria *
                                    </label>
                                    <select name="categoria" id="receita-categoria" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">Selecione uma categoria...</option>
                                        <option value="Sal√°rio">üíº Sal√°rio</option>
                                        <option value="Freelancer">üíª Freelancer</option>
                                        <option value="Investimentos">üìà Investimentos</option>
                                        <option value="Vendas">üõí Vendas</option>
                                        <option value="Aluguel">üè† Aluguel Recebido</option>
                                        <option value="Bonus">üéÅ B√¥nus</option>
                                        <option value="Dividendos">üí∞ Dividendos</option>
                                        <option value="Consultoria">üéØ Consultoria</option>
                                        <option value="Outros">üìù Outros</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700" for="receita-data">
                                        <i class="fas fa-calendar mr-1"></i>Data *
                                    </label>
                                    <input name="data" id="receita-data" type="date" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700" for="receita-observacoes">
                                        <i class="fas fa-sticky-note mr-1"></i>Observa√ß√µes
                                    </label>
                                    <textarea name="observacoes" id="receita-observacoes" maxlength="200"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                        placeholder="Observa√ß√µes opcionais..." rows="2"></textarea>
                                </div>
                                <button type="submit" id="receitaSubmitBtn"
                                    class="w-full gradient-success text-white py-3 rounded-lg hover:opacity-90 transition-all font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Adicionar Receita
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Resumo e Lista -->
                    <div class="xl:col-span-2 space-y-6">
                        <!-- Resumo -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="gradient-success rounded-xl p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90">Total do M√™s</p>
                                        <p class="text-2xl font-bold" id="totalReceitasMes">R$ 0,00</p>
                                    </div>
                                    <i class="fas fa-chart-line text-3xl opacity-70"></i>
                                </div>
                            </div>
                            <div class="gradient-info rounded-xl p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90">M√©dia Mensal</p>
                                        <p class="text-2xl font-bold" id="mediaReceitasMensal">R$ 0,00</p>
                                    </div>
                                    <i class="fas fa-calculator text-3xl opacity-70"></i>
                                </div>
                            </div>
                            <div class="gradient-purple rounded-xl p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90">Maior Receita</p>
                                        <p class="text-2xl font-bold" id="maiorReceita">R$ 0,00</p>
                                    </div>
                                    <i class="fas fa-trophy text-3xl opacity-70"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Receitas -->
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-semibold">Receitas Recentes</h4>
                                <div class="flex items-center space-x-2">
                                    <select id="receitasPeriodFilter" onchange="filterReceitas()" 
                                        class="text-sm border rounded px-2 py-1">
                                        <option value="current">M√™s Atual</option>
                                        <option value="last3">√öltimos 3 Meses</option>
                                        <option value="year">Ano Atual</option>
                                        <option value="all">Todas</option>
                                    </select>
                                    <button onclick="exportReceitas()" 
                                        class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                        <i class="fas fa-download mr-1"></i>Exportar
                                    </button>
                                </div>
                            </div>
                            <div id="receitasList" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                                <!-- Receitas ser√£o carregadas aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Despesas Tab -->
            <div id="despesas" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Controle de Despesas</h2>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <!-- Formul√°rio -->
                    <div class="xl:col-span-1">
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 flex items-center text-red-600">
                                <i class="fas fa-minus-circle mr-2"></i>
                                Nova Despesa
                            </h3>
                            <form onsubmit="handleDespesaForm(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700" for="despesa-descricao">
                                        <i class="fas fa-file-alt mr-1"></i>Descri√ß√£o *
                                    </label>
                                    <input name="descricao" id="despesa-descricao" type="text" required maxlength="100"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                        placeholder="Ex: Aluguel">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700" for="despesa-valor">
                                        <i class="fas fa-dollar-sign mr-1"></i>Valor *
                                    </label>
                                    <input name="valor" id="despesa-valor" type="text" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                        placeholder="500,00" oninput="formatCurrency(this)">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700" for="despesa-categoria">
                                        <i class="fas fa-tags mr-1"></i>Categoria *
                                    </label>
                                    <select name="categoria" id="despesa-categoria" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                        <option value="">Selecione uma categoria...</option>
                                        <option value="Habita√ß√£o">üè† Habita√ß√£o</option>
                                        <option value="Alimenta√ß√£o">üçΩÔ∏è Alimenta√ß√£o</option>
                                        <option value="Transporte">üöó Transporte</option>
                                        <option value="Lazer">üéØ Lazer</option>
                                        <option value="Sa√∫de">‚öïÔ∏è Sa√∫de</option>
                                        <option value="Educa√ß√£o">üìö Educa√ß√£o</option>
                                        <option value="Roupas">üëï Roupas</option>
                                        <option value="Tecnologia">üíª Tecnologia</option>
                                        <option value="Contas">üìÑ Contas</option>
                                        <option value="Investimentos">üìà Investimentos</option>
                                        <option value="Impostos">üèõÔ∏è Impostos</option>
                                        <option value="Seguros">üõ°Ô∏è Seguros</option>
                                        <option value="Outros">üìù Outros</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700" for="despesa-data">
                                        <i class="fas fa-calendar mr-1"></i>Data *
                                    </label>
                                    <input name="data" id="despesa-data" type="date" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700" for="despesa-observacoes">
                                        <i class="fas fa-sticky-note mr-1"></i>Observa√ß√µes
                                    </label>
                                    <textarea name="observacoes" id="despesa-observacoes" maxlength="200"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                        placeholder="Observa√ß√µes opcionais..." rows="2"></textarea>
                                </div>
                                <button type="submit" id="despesaSubmitBtn"
                                    class="w-full gradient-danger text-white py-3 rounded-lg hover:opacity-90 transition-all font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Adicionar Despesa
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Resumo e Lista -->
                    <div class="xl:col-span-2 space-y-6">
                        <!-- Resumo -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="gradient-danger rounded-xl p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90">Total do M√™s</p>
                                        <p class="text-2xl font-bold" id="totalDespesasMes">R$ 0,00</p>
                                    </div>
                                    <i class="fas fa-chart-line text-3xl opacity-70"></i>
                                </div>
                            </div>
                            <div class="gradient-warning rounded-xl p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90">M√©dia Mensal</p>
                                        <p class="text-2xl font-bold" id="mediaDespesasMensal">R$ 0,00</p>
                                    </div>
                                    <i class="fas fa-calculator text-3xl opacity-70"></i>
                                </div>
                            </div>
                            <div class="gradient-purple rounded-xl p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm opacity-90">Maior Despesa</p>
                                        <p class="text-2xl font-bold" id="maiorDespesa">R$ 0,00</p>
                                    </div>
                                    <i class="fas fa-exclamation-triangle text-3xl opacity-70"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Despesas -->
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-semibold">Despesas Recentes</h4>
                                <div class="flex items-center space-x-2">
                                    <select id="despesasPeriodFilter" onchange="filterDespesas()" 
                                        class="text-sm border rounded px-2 py-1">
                                        <option value="current">M√™s Atual</option>
                                        <option value="last3">√öltimos 3 Meses</option>
                                        <option value="year">Ano Atual</option>
                                        <option value="all">Todas</option>
                                    </select>
                                    <button onclick="exportDespesas()" 
                                        class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                        <i class="fas fa-download mr-1"></i>Exportar
                                    </button>
                                </div>
                            </div>
                            <div id="despesasList" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                                <!-- Despesas ser√£o carregadas aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relat√≥rios Tab -->
            <div id="relatorios" class="tab-content hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Relat√≥rios Detalhados</h2>
                    <div class="flex items-center space-x-2">
                        <button onclick="exportAllTransactions()" 
                            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            <i class="fas fa-file-excel mr-1"></i>Exportar Tudo
                        </button>
                        <button onclick="toggleBulkActions()" id="bulkActionBtn"
                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            <i class="fas fa-tasks mr-1"></i>A√ß√µes em Lote
                        </button>
                    </div>
                </div>

                <!-- Filtros Avan√ßados -->
                <div class="bg-white rounded-xl p-6 shadow-lg mb-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-filter mr-2 text-purple-500"></i>
                        Filtros Avan√ßados
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Per√≠odo</label>
                            <select id="reportPeriodFilter" onchange="applyReportFilters()" 
                                class="w-full p-2 border rounded-lg">
                                <option value="current">M√™s Atual</option>
                                <option value="last3">√öltimos 3 Meses</option>
                                <option value="last6">√öltimos 6 Meses</option>
                                <option value="year">Ano Atual</option>
                                <option value="all">Todos os Per√≠odos</option>
                                <option value="custom">Per√≠odo Personalizado</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Tipo</label>
                            <select id="reportTypeFilter" onchange="applyReportFilters()" 
                                class="w-full p-2 border rounded-lg">
                                <option value="all">Todos</option>
                                <option value="receita">Apenas Receitas</option>
                                <option value="despesa">Apenas Despesas</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Categoria</label>
                            <select id="reportCategoryFilter" onchange="applyReportFilters()" 
                                class="w-full p-2 border rounded-lg">
                                <option value="all">Todas as Categorias</option>
                                <!-- Categorias ser√£o preenchidas dinamicamente -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Valor M√≠nimo</label>
                            <input type="text" id="reportMinValue" onchange="applyReportFilters()" 
                                oninput="formatCurrency(this)" placeholder="R$ 0,00"
                                class="w-full p-2 border rounded-lg">
                        </div>
                    </div>

                    <!-- Filtros de Data Personalizada -->
                    <div id="customDateFilter" class="hidden mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Data Inicial</label>
                            <input type="date" id="reportStartDate" onchange="applyReportFilters()" 
                                class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Data Final</label>
                            <input type="date" id="reportEndDate" onchange="applyReportFilters()" 
                                class="w-full p-2 border rounded-lg">
                        </div>
                    </div>

                    <!-- Busca -->
                    <div class="mt-4">
                        <label class="block text-sm font-semibold mb-2">Buscar por Descri√ß√£o</label>
                        <input type="text" id="reportSearch" onkeyup="applyReportFilters()" 
                            placeholder="Digite para buscar..." class="w-full p-2 border rounded-lg">
                    </div>
                </div>

                <!-- Resumo do Relat√≥rio -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-lg p-4 shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Total de Transa√ß√µes</p>
                                <p class="text-xl font-bold" id="reportTotalCount">0</p>
                            </div>
                            <i class="fas fa-list text-2xl text-gray-400"></i>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Total Receitas</p>
                                <p class="text-xl font-bold text-green-600" id="reportTotalReceitas">R$ 0,00</p>
                            </div>
                            <i class="fas fa-arrow-up text-2xl text-green-400"></i>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Total Despesas</p>
                                <p class="text-xl font-bold text-red-600" id="reportTotalDespesas">R$ 0,00</p>
                            </div>
                            <i class="fas fa-arrow-down text-2xl text-red-400"></i>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Saldo L√≠quido</p>
                                <p class="text-xl font-bold" id="reportSaldoLiquido">R$ 0,00</p>
                            </div>
                            <i class="fas fa-balance-scale text-2xl text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <!-- A√ß√µes em Lote -->
                <div id="bulkActionsPanel" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold text-yellow-800">A√ß√µes em Lote</h4>
                        <button onclick="toggleBulkActions()" class="text-yellow-600 hover:text-yellow-800">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="selectAllTransactions()" 
                            class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                            <i class="fas fa-check-square mr-1"></i>Selecionar Todas
                        </button>
                        <button onclick="deselectAllTransactions()" 
                            class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">
                            <i class="fas fa-square mr-1"></i>Desmarcar Todas
                        </button>
                        <button onclick="bulkDeleteTransactions()" id="bulkDeleteBtn" disabled
                            class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-trash mr-1"></i>Excluir Selecionadas (<span id="selectedCount">0</span>)
                        </button>
                        <button onclick="bulkEditCategory()" id="bulkEditBtn" disabled
                            class="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-edit mr-1"></i>Alterar Categoria
                        </button>
                    </div>
                </div>

                <!-- Tabela de Transa√ß√µes -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4 text-left">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" 
                                            class="bulk-action-checkbox hidden">
                                        <span class="bulk-action-checkbox hidden">Sel.</span>
                                    </th>
                                    <th class="py-3 px-4 text-left cursor-pointer hover:bg-gray-100" 
                                        onclick="sortTransactions('data')">
                                        Data <i class="fas fa-sort text-xs ml-1"></i>
                                    </th>
                                    <th class="py-3 px-4 text-left cursor-pointer hover:bg-gray-100" 
                                        onclick="sortTransactions('tipo')">
                                        Tipo <i class="fas fa-sort text-xs ml-1"></i>
                                    </th>
                                    <th class="py-3 px-4 text-left cursor-pointer hover:bg-gray-100" 
                                        onclick="sortTransactions('descricao')">
                                        Descri√ß√£o <i class="fas fa-sort text-xs ml-1"></i>
                                    </th>
                                    <th class="py-3 px-4 text-left cursor-pointer hover:bg-gray-100" 
                                        onclick="sortTransactions('categoria')">
                                        Categoria <i class="fas fa-sort text-xs ml-1"></i>
                                    </th>
                                    <th class="py-3 px-4 text-right cursor-pointer hover:bg-gray-100" 
                                        onclick="sortTransactions('valor')">
                                        Valor <i class="fas fa-sort text-xs ml-1"></i>
                                    </th>
                                    <th class="py-3 px-4 text-center">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody" class="divide-y divide-gray-200">
                                <!-- Transa√ß√µes ser√£o carregadas aqui -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagina√ß√£o -->
                    <div class="bg-gray-50 px-6 py-3 flex items-center justify-between">
                        <div class="flex items-center space-x-2 text-sm text-gray-600">
                            <span>Mostrando</span>
                            <select id="itemsPerPage" onchange="updatePagination()" 
                                class="border rounded px-2 py-1">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span>de <span id="totalItems">0</span> itens</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="changePage(-1)" id="prevPageBtn" 
                                class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span id="pageInfo" class="text-sm text-gray-600">P√°gina 1 de 1</span>
                            <button onclick="changePage(1)" id="nextPageBtn" 
                                class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patrim√¥nio Tab -->
            <div id="patrimonio" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Controle de Patrim√¥nio</h2>

                <!-- Resumo do Patrim√¥nio -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="gradient-success rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Total de Bens</p>
                                <p class="text-2xl font-bold" id="totalBens">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-1" id="quantidadeBens">0 itens</p>
                            </div>
                            <i class="fas fa-arrow-trend-up text-3xl opacity-70"></i>
                        </div>
                    </div>

                    <div class="gradient-danger rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Total de D√≠vidas</p>
                                <p class="text-2xl font-bold" id="totalDividas">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-1" id="quantidadeDividas">0 itens</p>
                            </div>
                            <i class="fas fa-arrow-trend-down text-3xl opacity-70"></i>
                        </div>
                    </div>

                    <div class="gradient-info rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Patrim√¥nio L√≠quido</p>
                                <p class="text-2xl font-bold" id="patrimonioLiquido">R$ 0,00</p>
                                <p class="text-xs opacity-75 mt-1" id="statusPatrimonio">Positivo</p>
                            </div>
                            <i class="fas fa-balance-scale text-3xl opacity-70"></i>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <!-- Formul√°rio -->
                    <div class="xl:col-span-1">
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 flex items-center text-blue-600">
                                <i class="fas fa-plus mr-2"></i>
                                Novo Item
                            </h3>
                            <form onsubmit="handlePatrimonioForm(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700">
                                        <i class="fas fa-list mr-1"></i>Tipo *
                                    </label>
                                    <select name="tipo" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">Selecione o tipo...</option>
                                        <option value="bem">üí∞ Bem (Ativo)</option>
                                        <option value="divida">üí≥ D√≠vida (Passivo)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700">
                                        <i class="fas fa-file-alt mr-1"></i>Descri√ß√£o *
                                    </label>
                                    <input name="descricao" type="text" required maxlength="100"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Ex: Casa, Carro, Financiamento...">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700">
                                        <i class="fas fa-dollar-sign mr-1"></i>Valor *
                                    </label>
                                    <input name="valor" type="text" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="50.000,00" oninput="formatCurrency(this)">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2 text-gray-700">
                                        <i class="fas fa-tags mr-1"></i>Categoria *
                                    </label>
                                    <select name="categoria" required
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">Selecione uma categoria...</option>
                                        <option value="Im√≥vel">üè† Im√≥vel</option>
                                        <option value="Ve√≠culo">üöó Ve√≠culo</option>
                                        <option value="Investimentos">üìà Investimentos</option>
                                        <option value="Poupan√ßa">üí∞ Poupan√ßa</option>
                                        <option value="Financiamento">üè¶ Financiamento</option>
                                        <option value="Cart√£o de Cr√©dito">üí≥ Cart√£o de Cr√©dito</option>
                                        <option value="Empr√©stimo">üí∏ Empr√©stimo</option>
                                        <option value="Outros">üìù Outros</option>
                                    </select>
                                </div>
                                <button type="submit" id="patrimonioSubmitBtn"
                                    class="w-full gradient-info text-white py-3 rounded-lg hover:opacity-90 transition-all font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Adicionar Item
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Listas de Bens e D√≠vidas -->
                    <div class="xl:col-span-2">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Bens -->
                            <div class="bg-white rounded-xl p-6 shadow-lg">
                                <h3 class="text-xl font-semibold mb-4 text-green-700 flex items-center">
                                    <i class="fas fa-arrow-up mr-2"></i>Meus Bens
                                </h3>
                                <div id="bensList" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                                    <!-- Bens ser√£o carregados aqui -->
                                </div>
                            </div>

                            <!-- D√≠vidas -->
                            <div class="bg-white rounded-xl p-6 shadow-lg">
                                <h3 class="text-xl font-semibold mb-4 text-red-700 flex items-center">
                                    <i class="fas fa-arrow-down mr-2"></i>Minhas D√≠vidas
                                </h3>
                                <div id="dividasList" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                                    <!-- D√≠vidas ser√£o carregadas aqui -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Insights Tab -->
            <div id="insights" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Insights Inteligentes</h2>

                <!-- An√°lise Geral -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-brain mr-2 text-purple-500"></i>
                            An√°lise de Comportamento
                        </h3>
                        <div id="behaviorAnalysis" class="space-y-4">
                            <!-- An√°lises ser√£o geradas automaticamente -->
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-chart-line mr-2 text-blue-500"></i>
                            Tend√™ncias Financeiras
                        </h3>
                        <div class="chart-container">
                            <canvas id="trendsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Cards de Insights -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="insight-card bg-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <i class="fas fa-piggy-bank text-2xl text-green-500 mr-3"></i>
                                <h4 class="font-semibold">Capacidade de Economia</h4>
                            </div>
                        </div>
                        <div id="savingsCapacity" class="space-y-2 text-sm text-gray-600">
                            <!-- Conte√∫do ser√° gerado dinamicamente -->
                        </div>
                    </div>

                    <div class="insight-card bg-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-2xl text-yellow-500 mr-3"></i>
                                <h4 class="font-semibold">Alertas de Gastos</h4>
                            </div>
                        </div>
                        <div id="spendingAlerts" class="space-y-2 text-sm text-gray-600">
                            <!-- Conte√∫do ser√° gerado dinamicamente -->
                        </div>
                    </div>

                    <div class="insight-card bg-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <i class="fas fa-lightbulb text-2xl text-blue-500 mr-3"></i>
                                <h4 class="font-semibold">Recomenda√ß√µes</h4>
                            </div>
                        </div>
                        <div id="recommendations" class="space-y-2 text-sm text-gray-600">
                            <!-- Conte√∫do ser√° gerado dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- An√°lise por Categoria -->
                <div class="bg-white rounded-xl p-6 shadow-lg mb-8">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-tags mr-2 text-indigo-500"></i>
                        An√°lise Detalhada por Categoria
                    </h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold mb-3 text-gray-700">Top 5 Categorias de Gastos</h4>
                            <div id="topCategories" class="space-y-3">
                                <!-- Lista ser√° gerada dinamicamente -->
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-3 text-gray-700">Evolu√ß√£o Mensal por Categoria</h4>
                            <div class="chart-container">
                                <canvas id="categoryTrendsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compara√ß√£o de Per√≠odos -->
                <div class="bg-white rounded-xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold flex items-center">
                            <i class="fas fa-calendar-alt mr-2 text-green-500"></i>
                            Compara√ß√£o de Per√≠odos
                        </h3>
                        <div class="flex items-center space-x-2">
                            <select id="comparisonPeriod" onchange="updateComparison()" 
                                class="text-sm border rounded px-2 py-1">
                                <option value="monthly">Mensal</option>
                                <option value="quarterly">Trimestral</option>
                                <option value="yearly">Anual</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container-large">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Metas Tab -->
            <div id="metas" class="tab-content hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Metas Financeiras</h2>
                    <button onclick="openGoalModal()" 
                        class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        <i class="fas fa-plus mr-1"></i>Nova Meta
                    </button>
                </div>

                <!-- Resumo das Metas -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-lg p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Metas Ativas</p>
                                <p class="text-2xl font-bold text-blue-600" id="totalMetasAtivas">0</p>
                            </div>
                            <i class="fas fa-target text-3xl text-blue-400"></i>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Metas Conclu√≠das</p>
                                <p class="text-2xl font-bold text-green-600" id="totalMetasConcluidas">0</p>
                            </div>
                            <i class="fas fa-check-circle text-3xl text-green-400"></i>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Progresso M√©dio</p>
                                <p class="text-2xl font-bold text-purple-600" id="progressoMedio">0%</p>
                            </div>
                            <i class="fas fa-chart-pie text-3xl text-purple-400"></i>
                        </div>
                    </div>
                </div>

                <!-- Lista de Metas -->
                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6" id="metasList">
                    <!-- Metas ser√£o carregadas aqui -->
                </div>
            </div>

            <!-- Proje√ß√£o Tab -->
            <div id="projecao" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Proje√ß√£o Financeira</h2>

                <!-- Controles de Proje√ß√£o -->
                <div class="bg-white rounded-xl p-6 shadow-lg mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Per√≠odo de Proje√ß√£o</label>
                            <select id="projectionPeriod" onchange="updateProjection()" 
                                class="w-full p-2 border rounded-lg">
                                <option value="6">Pr√≥ximos 6 Meses</option>
                                <option value="12">Pr√≥ximos 12 Meses</option>
                                <option value="24">Pr√≥ximos 24 Meses</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Ajuste de Receita (%)</label>
                            <input type="range" id="revenueAdjustment" min="-20" max="50" value="0" 
                                onchange="updateProjection()" class="w-full">
                            <div class="text-sm text-gray-600 text-center mt-1">
                                <span id="revenueAdjustmentValue">0%</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Ajuste de Despesas (%)</label>
                            <input type="range" id="expenseAdjustment" min="-30" max="30" value="0" 
                                onchange="updateProjection()" class="w-full">
                            <div class="text-sm text-gray-600 text-center mt-1">
                                <span id="expenseAdjustmentValue">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fico de Proje√ß√£o -->
                <div class="bg-white rounded-xl p-6 shadow-lg mb-8">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-chart-bar mr-2 text-purple-500"></i>
                        Proje√ß√£o de Economia Mensal
                    </h3>
                    <div class="chart-container-large">
                        <canvas id="projecaoChart"></canvas>
                    </div>
                </div>

                <!-- Cen√°rios de Proje√ß√£o -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-6">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mr-3"></i>
                            <h3 class="text-lg font-bold text-yellow-700">Cen√°rio Conservador</h3>
                        </div>
                        <p class="text-3xl font-bold text-yellow-600 mb-3" id="cenarioConservador">R$ 0,00</p>
                        <p class="text-sm text-gray-600 mb-4">Economia no per√≠odo (70% da m√©dia atual)</p>
                        <div class="space-y-2 text-xs text-gray-500">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-yellow-500 mr-2"></i>
                                <span>Considera imprevistos</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-yellow-500 mr-2"></i>
                                <span>Gastos emergenciais +15%</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-yellow-500 mr-2"></i>
                                <span>Receita reduzida -5%</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-chart-line text-blue-500 text-2xl mr-3"></i>
                            <h3 class="text-lg font-bold text-blue-700">Cen√°rio Realista</h3>
                        </div>
                        <p class="text-3xl font-bold text-blue-600 mb-3" id="cenarioRealista">R$ 0,00</p>
                        <p class="text-sm text-gray-600 mb-4">Economia no per√≠odo (m√©dia atual)</p>
                        <div class="space-y-2 text-xs text-gray-500">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-blue-500 mr-2"></i>
                                <span>Padr√£o atual de gastos</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-blue-500 mr-2"></i>
                                <span>Receita mantida</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-blue-500 mr-2"></i>
                                <span>Sem grandes mudan√ßas</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-green-50 border-2 border-green-200 rounded-xl p-6">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-rocket text-green-500 text-2xl mr-3"></i>
                            <h3 class="text-lg font-bold text-green-700">Cen√°rio Otimista</h3>
                        </div>
                        <p class="text-3xl font-bold text-green-600 mb-3" id="cenarioOtimista">R$ 0,00</p>
                        <p class="text-sm text-gray-600 mb-4">Economia no per√≠odo (130% da m√©dia atual)</p>
                        <div class="space-y-2 text-xs text-gray-500">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span>Aumento de receita +20%</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span>Redu√ß√£o de gastos -15%</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span>Rendimento investimentos</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- An√°lise e Recomenda√ß√µes -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                            An√°lise Inteligente
                        </h3>
                        <div id="analiseInteligente" class="space-y-3 text-sm text-gray-600">
                            <!-- An√°lise ser√° gerada automaticamente -->
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-target mr-2 text-purple-500"></i>
                            Metas Sugeridas
                        </h3>
                        <div id="metasSugeridas" class="space-y-3 text-sm text-gray-600">
                            <!-- Metas ser√£o geradas automaticamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="confirmModal"
        class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md fade-in">
            <div class="flex items-center mb-4">
                <i id="confirmIcon" class="fas fa-question-circle text-3xl text-blue-500 mr-3"></i>
                <h3 id="confirmTitle" class="text-lg font-semibold">Confirmar A√ß√£o</h3>
            </div>
            <p id="confirmMessage" class="text-gray-600 mb-6">Deseja realmente executar esta a√ß√£o?</p>
            <div class="flex space-x-3">
                <button onclick="closeConfirmModal()"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button id="confirmButton"
                    class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o -->
    <div id="editModal"
        class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md fade-in">
            <div class="flex items-center justify-between mb-4">
                <h3 id="editTitle" class="text-lg font-semibold">Editar Item</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="editForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Descri√ß√£o</label>
                    <input id="editDescricao" type="text" required maxlength="100"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Valor</label>
                    <input id="editValor" type="text" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        oninput="formatCurrency(this)">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Categoria</label>
                    <select id="editCategoria" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <!-- Op√ß√µes ser√£o preenchidas dinamicamente -->
                    </select>
                </div>
                <div id="editDataContainer">
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Data</label>
                    <input id="editData" type="date" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div id="editObservacoesContainer" class="hidden">
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Observa√ß√µes</label>
                    <textarea id="editObservacoes" maxlength="200"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        rows="2"></textarea>
                </div>
                <div class="flex space-x-3">
                    <button type="button" onclick="closeEditModal()"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Meta -->
    <div id="goalModal"
        class="fixed inset-0 bg-black bg-opacity-50 modal hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md fade-in">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Nova Meta Financeira</h3>
                <button onclick="closeGoalModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form onsubmit="handleGoalForm(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">T√≠tulo da Meta</label>
                    <input name="titulo" type="text" required maxlength="100"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        placeholder="Ex: Reserva de Emerg√™ncia">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Valor Objetivo</label>
                    <input name="valorObjetivo" type="text" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        placeholder="10.000,00" oninput="formatCurrency(this)">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Data Limite</label>
                    <input name="dataLimite" type="date" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Categoria</label>
                    <select name="categoria" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">Selecione uma categoria...</option>
                        <option value="Emerg√™ncia">üö® Reserva de Emerg√™ncia</option>
                        <option value="Viagem">‚úàÔ∏è Viagem</option>
                        <option value="Casa">üè† Casa Pr√≥pria</option>
                        <option value="Ve√≠culo">üöó Ve√≠culo</option>
                        <option value="Investimento">üìà Investimento</option>
                        <option value="Educa√ß√£o">üìö Educa√ß√£o</option>
                        <option value="Aposentadoria">üë¥ Aposentadoria</option>
                        <option value="Outros">üìù Outros</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Descri√ß√£o</label>
                    <textarea name="descricao" maxlength="200"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        placeholder="Descri√ß√£o opcional da meta..." rows="2"></textarea>
                </div>
                <div class="flex space-x-3">
                    <button type="button" onclick="closeGoalModal()"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        Criar Meta
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast de Notifica√ß√£o -->
    <div id="toast" class="fixed top-4 right-4 z-50 transform translate-x-full transition-transform duration-300">
        <div class="bg-white border-l-4 border-green-500 rounded-lg shadow-lg p-4 flex items-center space-x-3">
            <i id="toastIcon" class="fas fa-check-circle text-green-500"></i>
            <div>
                <p id="toastTitle" class="font-semibold text-gray-800">Sucesso</p>
                <p id="toastMessage" class="text-sm text-gray-600">Opera√ß√£o realizada com sucesso</p>
            </div>
        </div>
    </div>

    <!-- JavaScript Principal - M√≥dulo ES6 -->
    <script type="module">
        // ==================== IMPORTS E CONFIGURA√á√ÉO ====================
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import {
            getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc,
            query, orderBy, onSnapshot, serverTimestamp, where, writeBatch
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Configura√ß√£o do Firebase
        const firebaseConfig = JSON.parse(document.getElementById('firebase-config').textContent);

        // Inicializa√ß√£o do Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // ==================== VARI√ÅVEIS GLOBAIS ====================
        let currentUser = null;
        let transacoes = [];
        let patrimonio = [];
        let metas = [];
        let unsubscribeTransacoes = null;
        let unsubscribePatrimonio = null;
        let unsubscribeMetas = null;
        let currentPeriodFilter = 'current';
        let sortField = 'data';
        let sortOrder = 'desc';
        let currentPage = 1;
        let itemsPerPage = 25;
        let filteredTransacoes = [];
        let selectedTransactions = [];
        let bulkActionsEnabled = false;

        // Charts
        let evolucaoChart, categoriaChart, projecaoChart, trendsChart, categoryTrendsChart, comparisonChart;

        // ==================== HELPERS ====================

        /**
         * Converte string em formato brasileiro para n√∫mero
         */
        function parseBRL(value) {
            if (!value) return 0;
            const cleanValue = value.toString()
                .replace(/[^\d,.-]/g, '')
                .replace(/\./g, '')
                .replace(',', '.');
            const num = parseFloat(cleanValue);
            return isFinite(num) && num >= 0 ? num : NaN;
        }

        /**
         * Formata n√∫mero para exibi√ß√£o em Real brasileiro
         */
        function formatBRL(value) {
            if (typeof value !== 'number' || isNaN(value)) return 'R$ 0,00';
            return value.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        }

        /**
         * Formata entrada de moeda em tempo real
         */
        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length === 0) {
                input.value = '';
                return;
            }

            // Adiciona zeros √† esquerda se necess√°rio
            while (value.length < 3) {
                value = '0' + value;
            }

            // Insere a v√≠rgula decimal
            const decimal = value.slice(-2);
            const integer = value.slice(0, -2);

            // Adiciona pontos para milhares
            const formattedInteger = integer.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

            input.value = formattedInteger + ',' + decimal;
        }

        /**
         * Formata data para exibi√ß√£o
         */
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR');
            } catch {
                return dateString;
            }
        }

        /**
         * Obt√©m per√≠odo de datas baseado no filtro
         */
        function getDateRange(period) {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();

            switch (period) {
                case 'current':
                    return {
                        start: new Date(currentYear, currentMonth, 1),
                        end: new Date(currentYear, currentMonth + 1, 0)
                    };
                case 'last3':
                    return {
                        start: new Date(currentYear, currentMonth - 3, 1),
                        end: new Date(currentYear, currentMonth + 1, 0)
                    };
                case 'last6':
                    return {
                        start: new Date(currentYear, currentMonth - 6, 1),
                        end: new Date(currentYear, currentMonth + 1, 0)
                    };
                case 'year':
                    return {
                        start: new Date(currentYear, 0, 1),
                        end: new Date(currentYear, 11, 31)
                    };
                case 'all':
                    return {
                        start: new Date('2020-01-01'),
                        end: new Date('2030-12-31')
                    };
                default:
                    return getDateRange('current');
            }
        }

        /**
         * Filtra transa√ß√µes por per√≠odo
         */
        function filterTransactionsByPeriod(transactions, period, customStart = null, customEnd = null) {
            if (period === 'custom' && customStart && customEnd) {
                const start = new Date(customStart);
                const end = new Date(customEnd);
                return transactions.filter(t => {
                    const date = new Date(t.data);
                    return date >= start && date <= end;
                });
            }

            const { start, end } = getDateRange(period);
            return transactions.filter(t => {
                const date = new Date(t.data);
                return date >= start && date <= end;
            });
        }

        /**
         * Valida√ß√£o de entrada
         */
        function validateInput(value, type = 'text', min = null, max = null) {
            if (!value || value.trim() === '') return false;

            if (type === 'currency') {
                const num = parseBRL(value);
                if (isNaN(num) || num < 0.01 || num > 999999999) return false;
                return true;
            }

            if (type === 'date') {
                const date = new Date(value);
                const today = new Date();
                if (date > today) return false;
                return true;
            }

            if (type === 'text') {
                if (min && value.length < min) return false;
                if (max && value.length > max) return false;
                return true;
            }

            return true;
        }

        // ==================== SISTEMA DE TOAST ====================

        function showToast(title, message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            const toastContainer = toast.querySelector('div');

            // Configurar √≠cone e cores baseado no tipo
            switch (type) {
                case 'success':
                    toastIcon.className = 'fas fa-check-circle text-green-500';
                    toastContainer.className = 'bg-white border-l-4 border-green-500 rounded-lg shadow-lg p-4 flex items-center space-x-3';
                    break;
                case 'error':
                    toastIcon.className = 'fas fa-times-circle text-red-500';
                    toastContainer.className = 'bg-white border-l-4 border-red-500 rounded-lg shadow-lg p-4 flex items-center space-x-3';
                    break;
                case 'warning':
                    toastIcon.className = 'fas fa-exclamation-triangle text-yellow-500';
                    toastContainer.className = 'bg-white border-l-4 border-yellow-500 rounded-lg shadow-lg p-4 flex items-center space-x-3';
                    break;
                case 'info':
                    toastIcon.className = 'fas fa-info-circle text-blue-500';
                    toastContainer.className = 'bg-white border-l-4 border-blue-500 rounded-lg shadow-lg p-4 flex items-center space-x-3';
                    break;
            }

            toastTitle.textContent = title;
            toastMessage.textContent = message;

            // Mostrar toast
            toast.style.transform = 'translateX(0)';

            // Esconder toast ap√≥s 4 segundos
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
            }, 4000);
        }

        // ==================== AUTENTICA√á√ÉO ====================

        // Listener de estado de autentica√ß√£o
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                
                // Atualizar informa√ß√µes do usu√°rio na UI
                document.getElementById('userName').textContent = user.displayName;
                document.getElementById('userPhoto').src = user.photoURL;

                // Inicializar listeners e dados
                initializeData();
                
                showToast('Bem-vindo!', `Ol√°, ${user.displayName}!`, 'success');
            } else {
                currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('appScreen').classList.add('hidden');
                
                // Limpar listeners
                cleanupListeners();
            }
        });

        // Fun√ß√£o de login
        async function loginWithGoogle() {
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Conectando...';

            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Erro no login:', error);
                showToast('Erro no Login', 'N√£o foi poss√≠vel fazer login. Tente novamente.', 'error');
                
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fab fa-google mr-2"></i>Entrar com Google';
            }
        }

        // Fun√ß√£o de logout
        async function logout() {
            try {
                await signOut(auth);
                showToast('At√© logo!', 'Logout realizado com sucesso.', 'info');
            } catch (error) {
                console.error('Erro no logout:', error);
                showToast('Erro', 'N√£o foi poss√≠vel fazer logout.', 'error');
            }
        }

        // ==================== INICIALIZA√á√ÉO DE DADOS ====================

        function initializeData() {
            // Configurar data padr√£o nos formul√°rios
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('receita-data').value = today;
            document.getElementById('despesa-data').value = today;

            // Inicializar listeners
            setupTransactionListener();
            setupPatrimonioListener();
            setupMetasListener();

            // Inicializar dashboard
            updateDashboard();
            
            // Atualizar timestamp
            updateLastUpdated();
        }

        function cleanupListeners() {
            if (unsubscribeTransacoes) unsubscribeTransacoes();
            if (unsubscribePatrimonio) unsubscribePatrimonio();
            if (unsubscribeMetas) unsubscribeMetas();
        }

        function setupTransactionListener() {
            if (!currentUser) return;

            const q = query(
                collection(db, 'users', currentUser.uid, 'transacoes'),
                orderBy('createdAt', 'desc')
            );

            unsubscribeTransacoes = onSnapshot(q, (snapshot) => {
                transacoes = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                updateDashboard();
                updateReceitas();
                updateDespesas();
                updateRelatories();
                updateInsights();
                updateProjection();
            }, (error) => {
                console.error('Erro ao carregar transa√ß√µes:', error);
                showToast('Erro', 'Falha ao carregar transa√ß√µes', 'error');
            });
        }

        function setupPatrimonioListener() {
            if (!currentUser) return;

            const q = query(
                collection(db, 'users', currentUser.uid, 'patrimonio'),
                orderBy('createdAt', 'desc')
            );

            unsubscribePatrimonio = onSnapshot(q, (snapshot) => {
                patrimonio = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                updatePatrimonio();
            }, (error) => {
                console.error('Erro ao carregar patrim√¥nio:', error);
                showToast('Erro', 'Falha ao carregar patrim√¥nio', 'error');
            });
        }

        function setupMetasListener() {
            if (!currentUser) return;

            const q = query(
                collection(db, 'users', currentUser.uid, 'metas'),
                orderBy('createdAt', 'desc')
            );

            unsubscribeMetas = onSnapshot(q, (snapshot) => {
                metas = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                updateMetas();
            }, (error) => {
                console.error('Erro ao carregar metas:', error);
                showToast('Erro', 'Falha ao carregar metas', 'error');
            });
        }

        function updateLastUpdated() {
            document.getElementById('lastUpdated').textContent = 
                'Atualizado ' + new Date().toLocaleTimeString('pt-BR');
        }

        // ==================== TRANSA√á√ïES ====================

        async function handleReceitaForm(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = document.getElementById('receitaSubmitBtn');

            // Valida√ß√µes
            const descricao = form.descricao.value.trim();
            const valor = parseBRL(form.valor.value);
            const categoria = form.categoria.value;
            const data = form.data.value;
            const observacoes = form.observacoes.value.trim();

            if (!validateInput(descricao, 'text', 2, 100)) {
                showToast('Erro', 'Descri√ß√£o deve ter entre 2 e 100 caracteres', 'error');
                return;
            }

            if (!validateInput(form.valor.value, 'currency')) {
                showToast('Erro', 'Valor deve estar entre R$ 0,01 e R$ 999.999.999,99', 'error');
                return;
            }

            if (!categoria) {
                showToast('Erro', 'Selecione uma categoria', 'error');
                return;
            }

            if (!validateInput(data, 'date')) {
                showToast('Erro', 'Data n√£o pode ser futura', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';

            try {
                const transactionData = {
                    tipo: 'receita',
                    descricao,
                    valor,
                    categoria,
                    data,
                    observacoes,
                    createdAt: serverTimestamp()
                };

                await addDoc(collection(db, 'users', currentUser.uid, 'transacoes'), transactionData);
                
                form.reset();
                document.getElementById('receita-data').value = new Date().toISOString().split('T')[0];
                
                showToast('Sucesso!', 'Receita adicionada com sucesso', 'success');

            } catch (error) {
                console.error('Erro ao salvar receita:', error);
                showToast('Erro', 'Falha ao salvar receita. Tente novamente.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Adicionar Receita';
            }
        }

        async function handleDespesaForm(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = document.getElementById('despesaSubmitBtn');

            // Valida√ß√µes
            const descricao = form.descricao.value.trim();
            const valor = parseBRL(form.valor.value);
            const categoria = form.categoria.value;
            const data = form.data.value;
            const observacoes = form.observacoes.value.trim();

            if (!validateInput(descricao, 'text', 2, 100)) {
                showToast('Erro', 'Descri√ß√£o deve ter entre 2 e 100 caracteres', 'error');
                return;
            }

            if (!validateInput(form.valor.value, 'currency')) {
                showToast('Erro', 'Valor deve estar entre R$ 0,01 e R$ 999.999.999,99', 'error');
                return;
            }

            if (!categoria) {
                showToast('Erro', 'Selecione uma categoria', 'error');
                return;
            }

            if (!validateInput(data, 'date')) {
                showToast('Erro', 'Data n√£o pode ser futura', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';

            try {
                const transactionData = {
                    tipo: 'despesa',
                    descricao,
                    valor,
                    categoria,
                    data,
                    observacoes,
                    createdAt: serverTimestamp()
                };

                await addDoc(collection(db, 'users', currentUser.uid, 'transacoes'), transactionData);
                
                form.reset();
                document.getElementById('despesa-data').value = new Date().toISOString().split('T')[0];
                
                showToast('Sucesso!', 'Despesa adicionada com sucesso', 'success');

            } catch (error) {
                console.error('Erro ao salvar despesa:', error);
                showToast('Erro', 'Falha ao salvar despesa. Tente novamente.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Adicionar Despesa';
            }
        }

        // ==================== PATRIM√îNIO ====================

        async function handlePatrimonioForm(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = document.getElementById('patrimonioSubmitBtn');

            const tipo = form.tipo.value;
            const descricao = form.descricao.value.trim();
            const valor = parseBRL(form.valor.value);
            const categoria = form.categoria.value;

            if (!tipo || !descricao || !categoria) {
                showToast('Erro', 'Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }

            if (!validateInput(form.valor.value, 'currency')) {
                showToast('Erro', 'Valor deve estar entre R$ 0,01 e R$ 999.999.999,99', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';

            try {
                const patrimonioData = {
                    tipo,
                    descricao,
                    valor,
                    categoria,
                    createdAt: serverTimestamp()
                };

                await addDoc(collection(db, 'users', currentUser.uid, 'patrimonio'), patrimonioData);
                
                form.reset();
                showToast('Sucesso!', 'Item de patrim√¥nio adicionado com sucesso', 'success');

            } catch (error) {
                console.error('Erro ao salvar patrim√¥nio:', error);
                showToast('Erro', 'Falha ao salvar item. Tente novamente.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Adicionar Item';
            }
        }

        // ==================== METAS ====================

        async function handleGoalForm(event) {
            event.preventDefault();
            const form = event.target;

            const titulo = form.titulo.value.trim();
            const valorObjetivo = parseBRL(form.valorObjetivo.value);
            const dataLimite = form.dataLimite.value;
            const categoria = form.categoria.value;
            const descricao = form.descricao.value.trim();

            if (!titulo || !categoria || !dataLimite) {
                showToast('Erro', 'Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }

            if (!validateInput(form.valorObjetivo.value, 'currency')) {
                showToast('Erro', 'Valor objetivo inv√°lido', 'error');
                return;
            }

            const limite = new Date(dataLimite);
            const hoje = new Date();
            if (limite <= hoje) {
                showToast('Erro', 'Data limite deve ser futura', 'error');
                return;
            }

            try {
                const metaData = {
                    titulo,
                    valorObjetivo,
                    valorAtual: 0,
                    dataLimite,
                    categoria,
                    descricao,
                    ativa: true,
                    createdAt: serverTimestamp()
                };

                await addDoc(collection(db, 'users', currentUser.uid, 'metas'), metaData);
                
                form.reset();
                closeGoalModal();
                showToast('Sucesso!', 'Meta criada com sucesso', 'success');

            } catch (error) {
                console.error('Erro ao salvar meta:', error);
                showToast('Erro', 'Falha ao criar meta. Tente novamente.', 'error');
            }
        }

        // ==================== NAVEGA√á√ÉO E UI ====================

        function showTab(tabName) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Remover classe ativa de todos os bot√µes
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('gradient-info', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });

            // Mostrar tab selecionada
            document.getElementById(tabName).classList.remove('hidden');

            // Adicionar classe ativa ao bot√£o
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('gradient-info', 'text-white');
                activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
            }

            // Executar a√ß√µes espec√≠ficas da tab
            switch (tabName) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'receitas':
                    updateReceitas();
                    break;
                case 'despesas':
                    updateDespesas();
                    break;
                case 'relatorios':
                    updateRelatories();
                    break;
                case 'patrimonio':
                    updatePatrimonio();
                    break;
                case 'insights':
                    updateInsights();
                    break;
                case 'metas':
                    updateMetas();
                    break;
                case 'projecao':
                    updateProjection();
                    break;
            }
        }

        // ==================== DASHBOARD ====================

        function updateDashboard() {
            const periodTransacoes = filterTransactionsByPeriod(transacoes, currentPeriodFilter);
            
            // Calcular m√©tricas
            const receitas = periodTransacoes.filter(t => t.tipo === 'receita');
            const despesas = periodTransacoes.filter(t => t.tipo === 'despesa');
            
            const totalReceitas = receitas.reduce((sum, t) => sum + (t.valor || 0), 0);
            const totalDespesas = despesas.reduce((sum, t) => sum + (t.valor || 0), 0);
            const saldo = totalReceitas - totalDespesas;
            const economia = saldo;

            // Atualizar UI
            document.getElementById('saldoAtual').textContent = formatBRL(saldo);
            document.getElementById('receitasPeriodo').textContent = formatBRL(totalReceitas);
            document.getElementById('despesasPeriodo').textContent = formatBRL(totalDespesas);
            document.getElementById('economiaPeriodo').textContent = formatBRL(economia);

            // Calcular percentuais (compara√ß√£o com per√≠odo anterior)
            const percentualEconomia = totalReceitas > 0 ? ((economia / totalReceitas) * 100) : 0;
            document.getElementById('percentualEconomia').textContent = `${percentualEconomia.toFixed(1)}% da receita`;

            // Calcular m√©dias
            const mesesPeriodo = Math.max(1, Math.ceil(periodTransacoes.length / 10)); // Estimativa
            document.getElementById('mediaReceitas').textContent = `M√©dia: ${formatBRL(totalReceitas / mesesPeriodo)}`;
            document.getElementById('mediaDespesas').textContent = `M√©dia: ${formatBRL(totalDespesas / mesesPeriodo)}`;

            // Atualizar gr√°ficos
            updateEvolucaoChart();
            updateCategoriaChart();

            // Atualizar transa√ß√µes recentes
            updateRecentTransactions();

            updateLastUpdated();
        }

        function updateRecentTransactions() {
            const recentTransactions = transacoes.slice(0, 10);
            const tbody = document.getElementById('recentTransactionsBody');
            
            tbody.innerHTML = recentTransactions.map(transaction => `
                <tr class="transaction-row">
                    <td class="py-3 px-4 text-sm">${formatDate(transaction.data)}</td>
                    <td class="py-3 px-4 text-sm">${transaction.descricao}</td>
                    <td class="py-3 px-4 text-sm">${transaction.categoria}</td>
                    <td class="py-3 px-4 text-sm text-right ${transaction.tipo === 'receita' ? 'text-green-600' : 'text-red-600'}">
                        ${formatBRL(transaction.valor)}
                    </td>
                    <td class="py-3 px-4 text-center">
                        <span class="px-2 py-1 text-xs rounded-full ${
                            transaction.tipo === 'receita' 
                                ? 'bg-green-100 text-green-800' 
                                : 'bg-red-100 text-red-800'
                        }">
                            ${transaction.tipo === 'receita' ? 'Receita' : 'Despesa'}
                        </span>
                    </td>
                </tr>
            `).join('');

            document.getElementById('totalTransacoesDashboard').textContent = `${transacoes.length} transa√ß√µes`;
        }

        function setDashboardPeriod(period) {
            currentPeriodFilter = period;
            
            // Atualizar bot√µes visuais
            document.querySelectorAll('.filter-chip').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            document.querySelector(`[data-period="${period}"]`).classList.remove('bg-gray-200', 'text-gray-700');
            document.querySelector(`[data-period="${period}"]`).classList.add('bg-blue-500', 'text-white');

            updateDashboard();
        }

        function refreshDashboard() {
            updateDashboard();
            showToast('Atualizado', 'Dashboard atualizado com sucesso', 'info');
        }

        // ==================== GR√ÅFICOS ====================

        function updateEvolucaoChart() {
            const canvas = document.getElementById('evolucaoChart');
            const ctx = canvas.getContext('2d');

            if (evolucaoChart) {
                evolucaoChart.destroy();
            }

            // Preparar dados mensais dos √∫ltimos 12 meses
            const meses = [];
            const receitasPorMes = [];
            const despesasPorMes = [];
            const saldoPorMes = [];

            const hoje = new Date();
            for (let i = 11; i >= 0; i--) {
                const mes = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() - i + 1, 0);
                
                const transacoesMes = transacoes.filter(t => {
                    const dataT = new Date(t.data);
                    return dataT >= mes && dataT <= fimMes;
                });

                const receitasMes = transacoesMes.filter(t => t.tipo === 'receita');
                const despesasMes = transacoesMes.filter(t => t.tipo === 'despesa');
                
                const totalReceitas = receitasMes.reduce((sum, t) => sum + (t.valor || 0), 0);
                const totalDespesas = despesasMes.reduce((sum, t) => sum + (t.valor || 0), 0);

                meses.push(mes.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' }));
                receitasPorMes.push(totalReceitas);
                despesasPorMes.push(totalDespesas);
                saldoPorMes.push(totalReceitas - totalDespesas);
            }
                evolucaoChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                            'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                        datasets: [{
                            label: 'Receitas',
                            data: Array(12).fill(0),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Despesas',
                            data: Array(12).fill(0),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.dataset.label + ': ' + formatBRL(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return formatBRL(value);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro no gr√°fico de evolu√ß√£o:', error);
            }
        }

        /**
         * Inicializa gr√°fico de categorias
         */
        function initCategoriaChart() {
            const ctx = document.getElementById('categoriaChart');
            if (!ctx) return;

            try {
                categoriaChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#3b82f6', '#ef4444', '#10b981', '#f59e0b',
                                '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16',
                                '#f97316', '#6366f1', '#14b8a6', '#f43f5e'
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.label || '';
                                        const value = formatBRL(context.parsed);
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro no gr√°fico de categorias:', error);
            }
        }

        /**
         * Inicializa gr√°fico de proje√ß√£o
         */
        function initProjecaoChart() {
            const ctx = document.getElementById('projecaoChart');
            if (!ctx) return;

            try {
                projecaoChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                            'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                        datasets: [{
                            label: 'Economia Acumulada',
                            data: Array(12).fill(0),
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return 'Economia: ' + formatBRL(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return formatBRL(value);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro no gr√°fico de proje√ß√£o:', error);
            }
        }

        /**
         * Atualiza dados dos gr√°ficos
         */
        function updateCharts() {
            try {
                updateEvolucaoChart();
                updateCategoriaChart();
                updateProjecaoChart();
            } catch (error) {
                console.error('Erro ao atualizar gr√°ficos:', error);
            }
        }

        /**
         * Atualiza gr√°fico de evolu√ß√£o
         */
        function updateEvolucaoChart() {
            if (!evolucaoChart) return;

            try {
                const receitasMeses = Array(12).fill(0);
                const despesasMeses = Array(12).fill(0);

                transacoes.forEach(transacao => {
                    if (transacao.data && transacao.valor) {
                        const data = new Date(transacao.data);
                        const mes = data.getMonth();

                        if (mes >= 0 && mes < 12) {
                            if (transacao.tipo === 'receita') {
                                receitasMeses[mes] += transacao.valor;
                            } else {
                                despesasMeses[mes] += transacao.valor;
                            }
                        }
                    }
                });

                evolucaoChart.data.datasets[0].data = receitasMeses;
                evolucaoChart.data.datasets[1].data = despesasMeses;
                evolucaoChart.update('none');
            } catch (error) {
                console.error('Erro ao atualizar gr√°fico de evolu√ß√£o:', error);
            }
        }

        /**
         * Atualiza gr√°fico de categorias
         */
        function updateCategoriaChart() {
            if (!categoriaChart) return;

            try {
                const categorias = {};

                transacoes
                    .filter(t => t.tipo === 'despesa' && t.categoria && t.valor)
                    .forEach(transacao => {
                        categorias[transacao.categoria] = (categorias[transacao.categoria] || 0) + transacao.valor;
                    });

                categoriaChart.data.labels = Object.keys(categorias);
                categoriaChart.data.datasets[0].data = Object.values(categorias);
                categoriaChart.update('none');
            } catch (error) {
                console.error('Erro ao atualizar gr√°fico de categorias:', error);
            }
        }

        /**
         * Atualiza gr√°fico de proje√ß√£o
         */
        function updateProjecaoChart() {
            if (!projecaoChart) return;

            try {
                const agora = new Date();
                const receitaTotal = transacoes
                    .filter(t => t.tipo === 'receita' && t.data && new Date(t.data).getFullYear() === agora.getFullYear())
                    .reduce((sum, t) => sum + (t.valor || 0), 0);

                const despesaTotal = transacoes
                    .filter(t => t.tipo === 'despesa' && t.data && new Date(t.data).getFullYear() === agora.getFullYear())
                    .reduce((sum, t) => sum + (t.valor || 0), 0);

                const mesesDecorridos = agora.getMonth() + 1;
                const economiaMensalMedia = mesesDecorridos > 0 ?
                    (receitaTotal - despesaTotal) / mesesDecorridos : 0;

                const projecaoMensal = Array(12).fill().map((_, i) =>
                    economiaMensalMedia * (i + 1)
                );

                projecaoChart.data.datasets[0].data = projecaoMensal;
                projecaoChart.update('none');
            } catch (error) {
                console.error('Erro ao atualizar gr√°fico de proje√ß√£o:', error);
            }
        }

        // ==================== FORM HANDLERS CORRIGIDOS ====================

        /**
         * Handler do formul√°rio de receitas com valida√ß√£o aprimorada
         * @param {Event} event - Evento do formul√°rio
         */
        async function handleReceitaForm(event) {
            event.preventDefault();

            const form = event.target;
            const submitBtn = document.getElementById('receitaSubmitBtn');

            try {
                submitBtn.classList.add('loading');
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';

                // Validar formul√°rio
                const data = validateForm(form, 'receita');
                if (!data) return;

                await addTransaction(data);

                // Reset form and clear errors
                form.reset();
                form.querySelectorAll('.input-error').forEach(input => {
                    input.classList.remove('input-error', 'input-success');
                    hideFieldError(input);
                });
                setToday();

            } catch (error) {
                console.error('Erro ao salvar receita:', error);
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Adicionar Receita';
            }
        }

        /**
         * Handler do formul√°rio de despesas com valida√ß√£o aprimorada
         * @param {Event} event - Evento do formul√°rio
         */
        async function handleDespesaForm(event) {
            event.preventDefault();

            const form = event.target;
            const submitBtn = document.getElementById('despesaSubmitBtn');

            try {
                submitBtn.classList.add('loading');
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';

                // Validar formul√°rio
                const data = validateForm(form, 'despesa');
                if (!data) return;

                await addTransaction(data);

                // Reset form and clear errors
                form.reset();
                form.querySelectorAll('.input-error').forEach(input => {
                    input.classList.remove('input-error', 'input-success');
                    hideFieldError(input);
                });
                setToday();

            } catch (error) {
                console.error('Erro ao salvar despesa:', error);
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Adicionar Despesa';
            }
        }

        /**
         * Handler do formul√°rio de patrim√¥nio com valida√ß√£o aprimorada
         * @param {Event} event - Evento do formul√°rio
         */
        async function handlePatrimonioForm(event) {
            event.preventDefault();

            const form = event.target;
            const submitBtn = document.getElementById('patrimonioSubmitBtn');

            try {
                submitBtn.classList.add('loading');
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';

                // Validar formul√°rio
                const data = validateForm(form, 'patrimonio');
                if (!data) return;

                await addPatrimony(data);

                // Reset form and clear errors
                form.reset();
                form.querySelectorAll('.input-error').forEach(input => {
                    input.classList.remove('input-error', 'input-success');
                });

            } catch (error) {
                console.error('Erro ao salvar patrim√¥nio:', error);
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Adicionar Item';
            }
        }

        // ==================== MODAL FUNCTIONS ====================

        let currentEditId = null;
        let currentEditCollection = null;

        /**
         * Abre modal de confirma√ß√£o
         * @param {string} title - T√≠tulo do modal
         * @param {string} message - Mensagem do modal
         * @param {Function} callback - Fun√ß√£o a executar se confirmado
         * @param {string} type - Tipo do modal (danger, warning, info)
         */
        function openConfirmModal(title, message, callback, type = 'danger') {
            const modal = document.getElementById('confirmModal');
            const icon = document.getElementById('confirmIcon');
            const titleEl = document.getElementById('confirmTitle');
            const messageEl = document.getElementById('confirmMessage');
            const confirmBtn = document.getElementById('confirmButton');

            const icons = {
                danger: 'fas fa-exclamation-triangle text-red-500',
                warning: 'fas fa-exclamation-triangle text-yellow-500',
                info: 'fas fa-info-circle text-blue-500'
            };

            const btnColors = {
                danger: 'bg-red-500 hover:bg-red-600',
                warning: 'bg-yellow-500 hover:bg-yellow-600',
                info: 'bg-blue-500 hover:bg-blue-600'
            };

            icon.className = icons[type] || icons.danger;
            titleEl.textContent = title;
            messageEl.textContent = message;
            confirmBtn.className = `flex-1 px-4 py-2 text-white rounded-lg transition-colors ${btnColors[type]}`;

            confirmBtn.onclick = () => {
                closeConfirmModal();
                callback();
            };

            modal.classList.remove('hidden');
        }

        /**
         * Fecha modal de confirma√ß√£o
         */
        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        /**
         * Abre modal de edi√ß√£o para transa√ß√£o com valida√ß√£o
         * @param {string} id - ID da transa√ß√£o
         */
        function editTransaction(id) {
            const transacao = transacoes.find(t => t.id === id);
            if (!transacao) {
                showToast('Erro', 'Transa√ß√£o n√£o encontrada', 'error');
                return;
            }

            try {
                currentEditId = id;
                currentEditCollection = 'transacoes';

                const modal = document.getElementById('editModal');
                const form = document.getElementById('editForm');
                const title = document.getElementById('editTitle');

                title.textContent = `Editar ${transacao.tipo === 'receita' ? 'Receita' : 'Despesa'}`;

                // Preenche campos com sanitiza√ß√£o
                document.getElementById('editDescricao').value = sanitizeString(transacao.descricao);
                document.getElementById('editValor').value = transacao.valor.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).replace('.', ',');
                document.getElementById('editData').value = transacao.data;

                // Preenche categorias
                const categoriaSelect = document.getElementById('editCategoria');
                categoriaSelect.innerHTML = '';

                const categorias = transacao.tipo === 'receita' ?
                    ['Sal√°rio', 'Freelancer', 'Investimentos', 'Vendas', 'Aluguel', 'Bonus', 'Outros'] :
                    ['Habita√ß√£o', 'Alimenta√ß√£o', 'Transporte', 'Lazer', 'Sa√∫de', 'Educa√ß√£o', 'Roupas', 'Tecnologia', 'Contas', 'Outros'];

                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    option.selected = cat === transacao.categoria;
                    categoriaSelect.appendChild(option);
                });

                // Mostra campo de data
                document.getElementById('editDataContainer').style.display = 'block';

                // Handler do formul√°rio
                form.onsubmit = handleEditSubmit;

                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao abrir edi√ß√£o:', error);
                showToast('Erro', 'Erro ao abrir formul√°rio de edi√ß√£o', 'error');
            }
        }

        /**
         * Abre modal de edi√ß√£o para patrim√¥nio
         * @param {string} id - ID do patrim√¥nio
         */
        function editPatrimonio(id) {
            const item = patrimonio.find(p => p.id === id);
            if (!item) {
                showToast('Erro', 'Item de patrim√¥nio n√£o encontrado', 'error');
                return;
            }

            try {
                currentEditId = id;
                currentEditCollection = 'patrimonio';

                const modal = document.getElementById('editModal');
                const form = document.getElementById('editForm');
                const title = document.getElementById('editTitle');

                title.textContent = `Editar ${item.tipo === 'bem' ? 'Bem' : 'D√≠vida'}`;

                // Preenche campos com sanitiza√ß√£o
                document.getElementById('editDescricao').value = sanitizeString(item.descricao);
                document.getElementById('editValor').value = item.valor.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).replace('.', ',');

                // Preenche categorias
                const categoriaSelect = document.getElementById('editCategoria');
                categoriaSelect.innerHTML = '';

                const categorias = ['Im√≥vel', 'Ve√≠culo', 'Investimentos', 'Poupan√ßa', 'Financiamento', 'Cart√£o de Cr√©dito', 'Empr√©stimo', 'Outros'];

                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    option.selected = cat === item.categoria;
                    categoriaSelect.appendChild(option);
                });

                // Esconde campo de data
                document.getElementById('editDataContainer').style.display = 'none';

                // Handler do formul√°rio
                form.onsubmit = handleEditSubmit;

                modal.classList.remove('hidden');
            } catch (error) {
                console.error('Erro ao abrir edi√ß√£o de patrim√¥nio:', error);
                showToast('Erro', 'Erro ao abrir formul√°rio de edi√ß√£o', 'error');
            }
        }

        /**
         * Handler do formul√°rio de edi√ß√£o com valida√ß√£o aprimorada
         * @param {Event} event - Evento do formul√°rio
         */
        async function handleEditSubmit(event) {
            event.preventDefault();

            const form = event.target;

            try {
                // Valida√ß√£o manual para edi√ß√£o
                const descricao = sanitizeString(form.querySelector('#editDescricao').value);
                const valor = parseBRL(form.querySelector('#editValor').value);
                const categoria = form.querySelector('#editCategoria').value;

                if (!descricao || descricao.length < 3) {
                    showToast('Erro', 'Descri√ß√£o deve ter pelo menos 3 caracteres', 'error');
                    return;
                }

                if (isNaN(valor) || valor <= 0) {
                    showToast('Erro', 'Valor deve ser maior que zero', 'error');
                    return;
                }

                const data = {
                    descricao: descricao,
                    valor: valor,
                    categoria: categoria
                };

                // Adiciona data se for transa√ß√£o
                if (currentEditCollection === 'transacoes') {
                    const dataValue = form.querySelector('#editData').value;
                    if (!isValidDate(dataValue)) {
                        showToast('Erro', 'Data inv√°lida', 'error');
                        return;
                    }
                    data.data = dataValue;
                }

                await updateItem(currentEditCollection, currentEditId, data);
                closeEditModal();

            } catch (error) {
                console.error('Erro ao atualizar:', error);
            }
        }

        /**
         * Fecha modal de edi√ß√£o
         */
        function closeEditModal() {
            const modal = document.getElementById('editModal');
            if (modal) {
                modal.classList.add('hidden');
            }
            currentEditId = null;
            currentEditCollection = null;
        }

        // ==================== DELETE FUNCTIONS ====================

        /**
         * Confirma exclus√£o de transa√ß√£o
         * @param {string} id - ID da transa√ß√£o
         */
        function deleteTransactionConfirm(id) {
            const transacao = transacoes.find(t => t.id === id);
            if (!transacao) {
                showToast('Erro', 'Transa√ß√£o n√£o encontrada', 'error');
                return;
            }

            openConfirmModal(
                'Confirmar Exclus√£o',
                `Deseja realmente excluir a ${transacao.tipo} "${sanitizeString(transacao.descricao)}" no valor de ${formatBRL(transacao.valor)}?`,
                () => deleteItem('transacoes', id),
                'danger'
            );
        }

        /**
         * Confirma exclus√£o de patrim√¥nio
         * @param {string} id - ID do patrim√¥nio
         */
        function deletePatrimonioConfirm(id) {
            const item = patrimonio.find(p => p.id === id);
            if (!item) {
                showToast('Erro', 'Item n√£o encontrado', 'error');
                return;
            }

            openConfirmModal(
                'Confirmar Exclus√£o',
                `Deseja realmente excluir o ${item.tipo} "${sanitizeString(item.descricao)}" no valor de ${formatBRL(item.valor)}?`,
                () => deleteItem('patrimonio', id),
                'danger'
            );
        }

        // ==================== TAB NAVIGATION ====================

        /**
         * Mostra tab espec√≠fica
         * @param {string} tabName - Nome da tab
         */
        function showTab(tabName) {
            try {
                // Esconde todas as tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.add('hidden');
                });

                // Remove classe ativa de todos os bot√µes
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.className = 'tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 whitespace-nowrap hover:bg-gray-200 transition-colors';
                });

                // Mostra tab selecionada
                const selectedTab = document.getElementById(tabName);
                if (selectedTab) {
                    selectedTab.classList.remove('hidden');
                    selectedTab.classList.add('fade-in');
                }

                // Ativa bot√£o da tab
                const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
                if (selectedBtn) {
                    selectedBtn.className = 'tab-btn px-4 py-2 rounded-lg text-sm font-medium gradient-info text-white whitespace-nowrap';
                }

                // Salva tab atual
                localStorage.setItem('currentTab', tabName);
            } catch (error) {
                console.error('Erro ao navegar entre tabs:', error);
            }
        }

        // ==================== EXPORT TO WINDOW ====================

        // Exporta fun√ß√µes necess√°rias para o escopo global
        window.loginWithGoogle = loginWithGoogle;
        window.logout = logout;
        window.handleReceitaForm = handleReceitaForm;
        window.handleDespesaForm = handleDespesaForm;
        window.handlePatrimonioForm = handlePatrimonioForm;
        window.formatCurrency = formatCurrency;
        window.showTab = showTab;
        window.editTransaction = editTransaction;
        window.editPatrimonio = editPatrimonio;
        window.deleteTransactionConfirm = deleteTransactionConfirm;
        window.deletePatrimonioConfirm = deletePatrimonioConfirm;
        window.closeConfirmModal = closeConfirmModal;
        window.closeEditModal = closeEditModal;

        // ==================== INICIALIZA√á√ÉO ====================

        // Inicializa quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Sistema Financeiro Corrigido Carregado com Sucesso!');

            // Define datas nos campos
            setToday();
        });

    </script>

    <!-- README das Instru√ß√µes de Configura√ß√£o -->
    <div style="display: none;" id="readme">
        <h1>Sistema de Gest√£o Financeira Pessoal - README</h1>

        <h2>üöÄ Configura√ß√£o do Firebase</h2>
        <ol>
            <li>Acesse <a href="https://console.firebase.google.com">Firebase Console</a></li>
            <li>Crie um novo projeto ou use um existente</li>
            <li>Ative Authentication > Sign-in method > Google</li>
            <li>Ative Firestore Database</li>
            <li>Em Project Settings > General, copie suas credenciais</li>
            <li>Substitua o conte√∫do do script JSON com suas credenciais</li>
            <li>Em Authentication > Settings > Authorized domains, adicione seus dom√≠nios</li>
        </ol>

        <h2>üìä Estrutura do Firestore</h2>
        <pre>
users/{uid}/
‚îú‚îÄ‚îÄ transacoes/
‚îÇ   ‚îú‚îÄ‚îÄ {docId}
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tipo: "receita" | "despesa"
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ descricao: string
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ valor: number
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ categoria: string
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ data: string (YYYY-MM-DD)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ createdAt: timestamp
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ patrimonio/
    ‚îú‚îÄ‚îÄ {docId}
    ‚îÇ   ‚îú‚îÄ‚îÄ tipo: "bem" | "divida"
    ‚îÇ   ‚îú‚îÄ‚îÄ descricao: string
    ‚îÇ   ‚îú‚îÄ‚îÄ valor: number
    ‚îÇ   ‚îú‚îÄ‚îÄ categoria: string
    ‚îÇ   ‚îî‚îÄ‚îÄ createdAt: timestamp
    ‚îî‚îÄ‚îÄ ...
        </pre>

        <h2>üåê Deploy</h2>
        <h3>GitHub Pages:</h3>
        <ol>
            <li>Fa√ßa upload do arquivo HTML para um reposit√≥rio</li>
            <li>Ative GitHub Pages</li>
            <li>Adicione o dom√≠nio do GitHub Pages aos dom√≠nios autorizados do Firebase</li>
        </ol>

        <h3>Vercel:</h3>
        <ol>
            <li>Conecte seu reposit√≥rio ao Vercel</li>
            <li>Deploy autom√°tico</li>
            <li>Adicione o dom√≠nio do Vercel aos dom√≠nios autorizados</li>
        </ol>

        <h3>Firebase Hosting:</h3>
        <ol>
            <li>npm install -g firebase-tools</li>
            <li>firebase login</li>
            <li>firebase init hosting</li>
            <li>firebase deploy</li>
        </ol>

        <h2>‚ú® Recursos</h2>
        <ul>
            <li>‚úÖ Autentica√ß√£o Google autom√°tica</li>
            <li>‚úÖ Dados em tempo real com onSnapshot</li>
            <li>‚úÖ Valida√ß√£o robusta de entrada</li>
            <li>‚úÖ Formata√ß√£o monet√°ria brasileira</li>
            <li>‚úÖ Gr√°ficos interativos</li>
            <li>‚úÖ Proje√ß√µes financeiras inteligentes</li>
            <li>‚úÖ Interface responsiva</li>
            <li>‚úÖ Edi√ß√£o e exclus√£o de registros</li>
            <li>‚úÖ An√°lise autom√°tica de padr√µes</li>
            <li>‚úÖ Sugest√µes de metas</li>
        </ul>

        <h2>üîß Personaliza√ß√£o</h2>
        <ul>
            <li>Modifique as categorias nos selects dos formul√°rios</li>
            <li>Ajuste as cores nos gradientes CSS</li>
            <li>Personalize os c√°lculos de proje√ß√£o</li>
            <li>Adicione novas an√°lises inteligentes</li>
        </ul>
    </div>
</body>

</html>

